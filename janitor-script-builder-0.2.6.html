<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JanitorAI Script Builder v0.2.6 ‚Äì Production Ready</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }

    :root {
      /* Janitor AI Color Palette */
      --bg: #1A1A1E;
      --panel-bg: #242428;
      --input-bg: #2C2C32;
      --hover-surface: #383A3F;
      --text-primary: #FFFFFF;
      --text-secondary: #C0C0C0;
      --text-muted: #888888;
      --border: #3D3D45;
      --divider: #333338;
      --accent: #CC6ECA;
      --accent-hover: #D88AD6;
      --accent-soft: rgba(204, 110, 202, 0.15);
      --button-bg: #A06DBE;
      --button-hover: #B080CE;
      --success: #5CB85C;
      --danger: #D9534F;
      /* Additional Janitor palette colors */
      --purple-dark: #4F2B53;
      --purple-mid: #713D71;
    }

    body {
      margin: 0;
      padding: 20px;
      font-family: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
    }

    h1, h2, h3 {
      margin-top: 0;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .page-title {
      text-align: center;
      margin-bottom: 6px;
      color: var(--text-primary);
    }

    .page-subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 18px;
    }

    .shell {
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background: var(--panel-bg);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 18px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      border: 1px solid var(--border);
    }

    /* Unified banner system - base class with CSS variables */
    .banner {
      padding: 12px 16px;
      margin-bottom: 16px;
      border-radius: 6px;
      font-size: 0.9rem;
      border-left: 4px solid var(--banner-accent);
      background: var(--banner-bg);
      color: var(--text-primary);
    }

    .banner.warning { --banner-bg: var(--panel-bg); --banner-accent: var(--accent); }
    .banner.info    { --banner-bg: var(--panel-bg); --banner-accent: var(--accent); }
    .banner.success { --banner-bg: var(--panel-bg); --banner-accent: var(--success); }
    .banner.danger  { --banner-bg: var(--panel-bg); --banner-accent: var(--danger); }

    /* Legacy banner classes for backwards compatibility */
    .warning-banner { padding: 12px 16px; margin-bottom: 16px; border-radius: 6px; font-size: 0.9rem; border-left: 4px solid var(--accent); background: var(--panel-bg); }
    .info-banner { padding: 12px 16px; margin-bottom: 16px; border-radius: 6px; font-size: 0.9rem; border-left: 4px solid var(--accent); background: var(--panel-bg); }
    .success-banner { padding: 12px 16px; margin-bottom: 16px; border-radius: 6px; font-size: 0.9rem; border-left: 4px solid var(--success); background: var(--panel-bg); }
    .danger-banner { padding: 12px 16px; margin-bottom: 16px; border-radius: 6px; font-size: 0.9rem; border-left: 4px solid var(--danger); background: var(--panel-bg); }

    .banner strong, .warning-banner strong {
      color: var(--text-secondary);
    }

    /* Unified info boxes - pitfall, glossary, checklist */
    .info-box {
      padding: 12px;
      margin-top: 12px;
      border-radius: 6px;
      font-size: 0.9rem;
      border-left: 4px solid var(--box-accent);
      background: var(--box-bg);
    }

    .info-box.pitfall { --box-bg: var(--panel-bg); --box-accent: var(--accent); }
    .info-box.glossary { --box-bg: var(--panel-bg); --box-accent: var(--accent); }
    .info-box.checklist { --box-bg: var(--panel-bg); --box-accent: var(--success); }

    /* Legacy box classes for backwards compatibility */
    .pitfall-box {
      background: var(--panel-bg);
      border-left: 4px solid var(--accent);
      padding: 12px;
      margin-top: 12px;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .pitfall-box strong, .info-box strong {
      color: var(--accent-hover);
    }

    .pitfall-box ul, .info-box ul {
      margin: 8px 0 0 0;
      padding-left: 20px;
    }

    .pitfall-box li, .info-box li {
      margin-bottom: 4px;
    }

    .onboarding-card {
      background: linear-gradient(135deg, var(--purple-dark) 0%, var(--panel-bg) 100%);
      color: var(--text-primary);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.15);
      border: 1px solid var(--purple-mid);
    }

    .onboarding-card h2 {
      margin-top: 0;
      font-size: 1.5rem;
    }

    .onboarding-examples {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .onboarding-example {
      background: var(--purple-dark);
      padding: 12px;
      border-radius: 6px;
      backdrop-filter: blur(10px);
      border: 1px solid var(--purple-mid);
    }

    .onboarding-example strong {
      display: block;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }

    .onboarding-example code {
      display: block;
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
      justify-content: center;
    }

    .tab-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      background: var(--hover-surface);
      color: var(--text-primary);
      transition: all 0.2s;
      font-family: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    .tab-btn:hover {
      background: var(--accent);
      color: var(--text-primary);
    }

    .tab-btn.active {
      background: var(--accent);
      color: var(--text-primary);
    }

    .tab-btn.experimental {
      background: var(--accent-soft);
      color: var(--accent-hover);
    }

    .tab-btn.experimental.active {
      background: var(--accent);
      color: var(--text-primary);
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .form-group {
      margin-bottom: 14px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 0.95rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.95rem;
      background: var(--input-bg);
      color: var(--text-primary);
      font-family: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
      font-family: 'Courier New', monospace;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    /* Placeholder styling - makes example text look muted and hint-like */
    input::placeholder,
    textarea::placeholder {
      color: var(--text-muted);
      opacity: 0.8;
    }

    /* Text selection with Janitor accent */
    ::selection {
      background: var(--accent);
      color: var(--text-primary);
    }

    .help-text {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 4px;
      font-style: italic;
    }

    .example-text {
      font-size: 0.85rem;
      color: var(--accent);
      margin-top: 4px;
      padding: 6px 8px;
      background: var(--accent-soft);
      border-radius: 3px;
      border-left: 3px solid var(--accent);
    }

    .example-text code {
      background: var(--hover-surface);
      padding: 2px 4px;
      border-radius: 2px;
      font-size: 0.9em;
    }

    .btn {
      background: var(--button-bg);
      color: var(--text-primary);
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
      margin-right: 8px;
      margin-bottom: 8px;
      transition: background 0.2s;
      font-family: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      font-weight: 600;
    }

    .btn:hover {
      background: var(--button-hover);
    }

    .btn-secondary {
      background: var(--hover-surface);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    .btn-danger {
      background: var(--danger);
    }

    .btn-danger:hover {
      background: var(--danger);
    }

    .btn-success {
      background: var(--success);
    }

    .btn-success:hover {
      background: var(--success);
    }

    .btn-warning {
      background: var(--accent);
      color: var(--text-primary);
    }

    .btn-warning:hover {
      background: var(--accent-hover);
    }

    .dynamic-list {
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 10px;
      margin-top: 8px;
      max-height: 300px;
      overflow-y: auto;
    }

    .dynamic-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      padding: 8px;
      background: var(--input-bg);
      border-radius: 4px;
    }

    .dynamic-item input,
    .dynamic-item textarea {
      flex: 1;
      padding: 6px 8px;
      border: 1px solid var(--border);
      border-radius: 3px;
      font-size: 0.9rem;
    }

    .dynamic-item textarea {
      min-height: 60px;
      font-family: 'Courier New', monospace;
    }

    .dynamic-item button {
      padding: 6px 10px;
      background: var(--danger);
      color: var(--text-primary);
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .output-box {
      background: var(--panel-bg);
      color: var(--text-primary);
      padding: 14px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 10px;
    }

    .module-order {
      border: 1px dashed var(--border);
      border-radius: 6px;
      padding: 12px;
      min-height: 80px;
    }

    .order-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 8px;
      cursor: move;
    }

    .order-item input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .order-item label {
      flex: 1;
      margin: 0;
      font-weight: normal;
    }

    .drag-handle {
      color: var(--text-muted);
      font-size: 1.2rem;
    }

    .token-meter {
      margin-top: 8px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .token-meter .bar {
      height: 6px;
      background: var(--input-bg);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 4px;
    }

    .token-meter .fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--accent), var(--danger));
      transition: width 0.3s;
    }

    .preset-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .preset-card {
      border: 2px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .preset-card:hover {
      border-color: var(--accent);
      box-shadow: 0 2px 8px var(--accent-soft);
    }

    .preset-card h4 {
      margin: 0 0 6px 0;
      color: var(--accent);
    }

    .preset-card p {
      margin: 0;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .glossary, .info-box.glossary {
      background: var(--panel-bg);
      border-left: 4px solid var(--accent);
      padding: 12px;
      border-radius: 6px;
      margin-top: 12px;
      font-size: 0.9rem;
    }

    .glossary h4, .info-box.glossary h4 {
      margin-top: 0;
      color: var(--accent);
    }

    .glossary dl {
      margin: 8px 0 0 0;
    }

    .glossary dt {
      font-weight: 600;
      margin-top: 8px;
      color: var(--text-secondary);
    }

    .glossary dd {
      margin: 2px 0 0 16px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .debug-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: var(--panel-bg);
      border-radius: 4px;
      margin-bottom: 12px;
    }

    .debug-toggle input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .debug-toggle label {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .checklist, .info-box.checklist {
      background: var(--panel-bg);
      border-left: 4px solid var(--success);
      padding: 12px;
      border-radius: 6px;
      margin-top: 12px;
      font-size: 0.9rem;
    }

    .checklist h4, .info-box.checklist h4 {
      margin-top: 0;
      color: var(--success);
    }

    .checklist ul, .info-box.checklist ul {
      margin: 8px 0 0 0;
      padding-left: 20px;
    }

    .checklist li, .info-box.checklist li {
      margin-bottom: 6px;
      color: var(--text-secondary);
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .page-title {
        font-size: 1.75rem;
      }

      .page-subtitle {
        font-size: 0.85rem;
        margin-bottom: 12px;
      }

      .tabs {
        flex-direction: column;
      }
      
      .tab-btn {
        width: 100%;
      }

      .onboarding-card h2 {
        font-size: 1.25rem;
      }

      .onboarding-examples {
        grid-template-columns: 1fr;
      }

      .preset-grid {
        grid-template-columns: 1fr;
      }

      .dynamic-item {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      .dynamic-item input,
      .dynamic-item textarea,
      .dynamic-item select {
        width: 100% !important;
        flex: none !important;
        min-height: 44px;
      }

      .dynamic-item input[type="number"] {
        width: 100% !important;
      }

      .dynamic-item textarea {
        min-height: 100px;
      }

      .dynamic-item button {
        width: 100%;
        padding: 12px;
        min-height: 44px;
      }

      .btn {
        width: 100%;
        margin-right: 0;
        margin-bottom: 10px;
        min-height: 44px;
      }

      .order-item {
        cursor: default;
        padding: 8px;
      }

      .drag-handle {
        display: none;
      }

      .output-box {
        font-size: 0.75rem;
        padding: 10px;
        max-height: 300px;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        min-height: 44px;
        font-size: 16px;
      }

      .form-group textarea {
        min-height: 100px;
      }

      .example-text {
        font-size: 0.8rem;
        word-break: break-word;
      }

      .pitfall-box,
      .warning-banner,
      .info-banner,
      .success-banner,
      .danger-banner {
        font-size: 0.85rem;
        padding: 10px 12px;
      }

      .card {
        padding: 12px;
        margin-bottom: 12px;
      }

      .glossary {
        padding: 10px;
      }

      h3 {
        font-size: 1.25rem;
      }

      h4 {
        font-size: 1.1rem;
      }

      .dynamic-list {
        max-height: 400px;
      }

      .token-meter {
        font-size: 0.8rem;
      }

      .checklist ul,
      .pitfall-box ul {
        font-size: 0.85rem;
      }
    }

    /* Header Banner Styles */
    .header-banner-wrap {
      text-align: center;
      margin-bottom: 14px;
    }

    .header-logo {
      width: auto;
      max-width: 120px;
      height: auto;
      margin-bottom: 8px;
    }

    .header-banner-subtext {
      margin-top: 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* Toast notification styles */
    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      pointer-events: none;
    }

    .toast {
      background: var(--panel-bg);
      color: var(--text-primary);
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      font-size: 0.95rem;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: auto;
      text-align: center;
      max-width: 90vw;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    .toast.warning {
      border-left: 4px solid var(--accent);
    }

    /* Trigger Analyzer styles */
    .analyzer-results {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-top: 12px;
      max-height: 400px;
      overflow-y: auto;
    }

    .analyzer-section {
      margin-bottom: 16px;
    }

    .analyzer-section:last-child {
      margin-bottom: 0;
    }

    .analyzer-section h4 {
      margin: 0 0 8px 0;
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    .analyzer-item {
      background: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 8px;
    }

    .analyzer-item:last-child {
      margin-bottom: 0;
    }

    .analyzer-keyword {
      font-weight: 700;
      color: var(--accent);
      font-family: monospace;
      font-size: 1rem;
    }

    .analyzer-usage {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 4px;
      padding-left: 12px;
      border-left: 2px solid var(--border);
    }

    .analyzer-usage-item {
      margin: 4px 0;
    }

    .analyzer-warning {
      border-left: 3px solid var(--accent);
    }

    .analyzer-conflict {
      border-left: 3px solid var(--danger);
    }

    .analyzer-ok {
      border-left: 3px solid var(--success);
    }

    .analyzer-empty {
      color: var(--text-muted);
      font-style: italic;
      text-align: center;
      padding: 20px;
    }

    /* Script Tester styles */
    .tester-results {
      margin-top: 16px;
      padding: 16px;
      background: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    .tester-results h4 {
      margin: 0 0 12px 0;
      color: var(--accent);
    }

    .tester-result-section {
      margin-bottom: 12px;
    }

    .tester-result-section:last-child {
      margin-bottom: 0;
    }

    .tester-result-section strong {
      display: block;
      margin-bottom: 6px;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .tester-result-section .output-box {
      margin-top: 0;
      font-size: 0.8rem;
    }

    .tester-success {
      border-left: 3px solid var(--success);
    }

    .tester-error {
      border-left: 3px solid var(--danger);
    }

    .tester-warning {
      border-left: 3px solid var(--accent);
    }

    /* Batch test result items */
    .batch-result-item {
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .batch-result-item.success {
      border-left: 4px solid var(--success);
    }

    .batch-result-item.no-trigger {
      border-left: 4px solid var(--text-muted);
    }

    .batch-result-item.error {
      border-left: 4px solid var(--danger);
    }

    .batch-result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      cursor: pointer;
    }

    .batch-result-header:hover {
      opacity: 0.8;
    }

    .batch-result-number {
      font-weight: 700;
      color: var(--accent);
      font-size: 0.9rem;
    }

    .batch-result-status {
      font-size: 0.8rem;
      padding: 2px 8px;
      border-radius: 4px;
      background: var(--panel-bg);
    }

    .batch-result-message {
      font-style: italic;
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-bottom: 8px;
      padding: 6px 8px;
      background: var(--panel-bg);
      border-radius: 4px;
      max-height: 60px;
      overflow-y: auto;
    }

    .batch-result-details {
      display: none;
      margin-top: 8px;
    }

    .batch-result-details.expanded {
      display: block;
    }

    .batch-result-detail {
      margin-bottom: 6px;
    }

    .batch-result-detail strong {
      display: block;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .batch-result-detail .output-box {
      font-size: 0.75rem;
      max-height: 80px;
      margin-top: 0;
    }

    .analyzer-summary {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      padding: 10px;
      background: var(--panel-bg);
      border-radius: 6px;
    }

    .analyzer-stat {
      font-size: 0.9rem;
    }

    .analyzer-stat strong {
      color: var(--accent);
    }
  </style>
</head>
<body>

<div class="shell">
  <!-- Header Banner -->
  <div class="header-banner-wrap">
    <img class="header-logo" src="logo2x-1_ia066y.png" alt="Janitor AI Logo">
    <div class="header-banner-subtext">
      web tool made by @mellowfllow
    </div>
  </div>

  <h1 class="page-title">Janitor Script Builder v0.2.6</h1>
  <p class="page-subtitle">Advanced scripts made easy ‚Äì fill out simple forms, get copy-paste-ready code.</p>

  <!-- Stateless 101 Onboarding -->
  <div class="onboarding-card">
    <h2>üéì Stateless 101: Understanding How Scripts Work</h2>
    <p style="margin-bottom: 12px;">
      <strong>Key Concept:</strong> JanitorAI scripts run fresh on <em>every single message</em>. Variables don't persist between messages unless you store them in scenario/personality notes.
    </p>
    <div class="onboarding-examples">
      <div class="onboarding-example">
        <strong>‚ùå Won't Work:</strong>
        <code>var score = 0; score++;</code>
        <small style="display:block; margin-top:4px;">Score resets to 0 every message</small>
      </div>
      <div class="onboarding-example">
        <strong>‚úÖ Will Work:</strong>
        <code>Memory ‚Üí adds to scenario notes</code>
        <small style="display:block; margin-top:4px;">Scenario persists between messages</small>
      </div>
      <div class="onboarding-example">
        <strong>‚ö†Ô∏è Experimental:</strong>
        <code>Using {{char}} tags for variables</code>
        <small style="display:block; margin-top:4px;">Fragile, can break with updates</small>
      </div>
    </div>
    <p style="margin-top: 12px; font-size: 0.9rem; opacity: 0.95;">
      <strong>Pro Tip:</strong> Scripts only check the <em>latest user message</em> by default. To check history, you need experimental methods (which may break).
    </p>
  </div>

  <!-- Test Checklist -->
  <div class="card">
    <h3>‚úÖ Pre-Launch Test Checklist</h3>
    <div class="checklist">
      <h4>Before using your script in JanitorAI:</h4>
      <ul>
        <li>‚úì Enable <strong>Debug Mode</strong> in Module Control Panel for first test</li>
        <li>‚úì Start with 1-2 modules, add more once working</li>
        <li>‚úì Test each trigger keyword/phrase in a real conversation</li>
        <li>‚úì Check scenario notes after 5-10 messages for bloat</li>
        <li>‚úì Verify message_count increments correctly (rerolls don't count)</li>
        <li>‚úì Disable debug mode before final deployment</li>
        <li>‚úì Keep total script under 10,000 characters for best performance</li>
      </ul>
    </div>
    <div class="info-banner" style="margin-top: 12px;">
      <strong>üí° Reroll Behavior:</strong> When you reroll a character response, <code>message_count</code> does NOT increment. Only new user messages increase the count.
    </div>
  </div>

  <!-- Recommended Build Order -->
  <div class="card">
    <h3>üìã Recommended Build Order (Pro Workflow)</h3>
    <p>Follow this order for the most reliable and maintainable scripts:</p>
    <ol style="line-height: 1.8;">
      <li><strong>Lorebook</strong> ‚Üí Foundation for rich context (most stable)</li>
      <li><strong>Memory System</strong> ‚Üí Track user info (stable)</li>
      <li><strong>Pacing</strong> ‚Üí Gate story progression (stable)</li>
      <li><strong>Tone/State Engine</strong> ‚Üí Dynamic mood shifts (stable)</li>
      <li><strong>Time & Environment</strong> ‚Üí Hour-based behaviors (stable)</li>
      <li><strong>Ambient Events</strong> ‚Üí Add flavor (watch token growth)</li>
      <li><strong>Random Events</strong> ‚Üí Weighted reactions (moderate complexity)</li>
      <li><strong>Combined Conditions</strong> ‚Üí Multi-trigger rules (advanced)</li>
      <li><strong>Scoring (Stateless only)</strong> ‚Üí Sentiment analysis (experimental)</li>
    </ol>
    <div class="info-banner">
      <strong>üí° Why this order?</strong> Lorebook and Memory are stable and token-efficient. Add complexity gradually, testing at each step. The Module Control Panel below is pre-ordered to match this workflow.
    </div>
  </div>

  <!-- Scenario Maintenance Tips -->
  <div class="card">
    <h3>üßπ Scenario Maintenance Best Practices</h3>
    <div class="warning-banner">
      <strong>‚ö†Ô∏è Token Bloat Warning:</strong> Scripts that only append to scenario will cause slowdowns over long conversations.
    </div>
    <p><strong>Pro strategies to prevent bloat:</strong></p>
    <ul style="line-height: 1.6;">
      <li><strong>Use personality for moods/states</strong> instead of scenario (personality can be overwritten)</li>
      <li><strong>Summarize old notes periodically</strong> instead of endless appending</li>
      <li><strong>Use lorebooks for static info</strong> that only triggers when relevant</li>
      <li><strong>Prefer "replace" over "append"</strong> for things that change (time, mood)</li>
      <li><strong>Test scenario length</strong> after 20-30 messages and clean if needed</li>
    </ul>
    <div class="example-text">
      <strong>Example:</strong> Instead of appending "User is happy" every time, <em>replace</em> the mood line or store it in personality which naturally gets refreshed.
    </div>
  </div>

  <!-- Module Control Panel -->
  <div class="card">
    <h3>‚öôÔ∏è Module Control Panel</h3>
    <div class="debug-toggle">
      <input type="checkbox" id="debugMode" />
      <label for="debugMode">
        <strong>üêõ Debug Mode:</strong> Add "(debug: module fired)" notes to scenario output for testing
      </label>
    </div>
    <div class="warning-banner">
      <strong>‚ö†Ô∏è Execution Order Matters!</strong> Modules run in the order below. Later modules can override earlier ones. Drag to reorder. This panel is pre-ordered to match the recommended pro workflow above.
    </div>
    <div id="moduleOrder" class="module-order">
      <div class="order-item" draggable="true" data-module="lorebook">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <input type="checkbox" id="toggle-lorebook" checked />
        <label for="toggle-lorebook">Lorebook</label>
      </div>
      <div class="order-item" draggable="true" data-module="memory">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <input type="checkbox" id="toggle-memory" checked />
        <label for="toggle-memory">Memory System</label>
      </div>
      <div class="order-item" draggable="true" data-module="pacing">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <input type="checkbox" id="toggle-pacing" checked />
        <label for="toggle-pacing">Pacing</label>
      </div>
      <div class="order-item" draggable="true" data-module="tone">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <input type="checkbox" id="toggle-tone" checked />
        <label for="toggle-tone">Tone/State Engine</label>
      </div>
      <div class="order-item" draggable="true" data-module="time">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <input type="checkbox" id="toggle-time" />
        <label for="toggle-time">Time & Environment</label>
      </div>
      <div class="order-item" draggable="true" data-module="ambient">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <input type="checkbox" id="toggle-ambient" />
        <label for="toggle-ambient">Ambient Events</label>
      </div>
      <div class="order-item" draggable="true" data-module="random">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <input type="checkbox" id="toggle-random" />
        <label for="toggle-random">Random Events</label>
      </div>
      <div class="order-item" draggable="true" data-module="combined">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <input type="checkbox" id="toggle-combined" />
        <label for="toggle-combined">Combined Conditions</label>
      </div>
      <div class="order-item" draggable="true" data-module="scoring">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <input type="checkbox" id="toggle-scoring" />
        <label for="toggle-scoring">Scoring Engine (Experimental)</label>
      </div>
    </div>
    <button type="button" class="btn btn-success" onclick="generateFinalCombinedScript()">
      üì¶ Copy All Enabled Modules
    </button>
    <button type="button" class="btn btn-warning" onclick="generateAllEnabledModules()">
      ‚ö° Generate All Enabled (then combine)
    </button>
    <button type="button" class="btn btn-danger" onclick="resetAllFields()">
      üîÑ Reset All Fields
    </button>
    <div class="token-meter" id="tokenMeter">
      <span>Estimated Script Size: <strong id="tokenCount">0</strong> characters</span>
      <div class="bar">
        <div class="fill" id="tokenFill" style="width: 0%"></div>
      </div>
      <small style="display:block; margin-top:4px;">Keep under 10,000 characters for best performance</small>
    </div>
  </div>

  <!-- Preset Library -->
  <div class="card">
    <h3>üìö Load Preset Templates</h3>
    <p>Click a preset to auto-fill the form with starter values. You can customize them after loading.</p>
    <div class="preset-grid">
      <div class="preset-card" onclick="loadPreset('slowburn')">
        <h4>üåπ Slow-Burn Romance</h4>
        <p>Gradual relationship progression with memory tracking</p>
      </div>
      <div class="preset-card" onclick="loadPreset('rpg')">
        <h4>‚öîÔ∏è RPG Adventure</h4>
        <p>Lorebook-heavy with locations, NPCs, and events</p>
      </div>
      <div class="preset-card" onclick="loadPreset('ambient')">
        <h4>üåø Ambient Flavor Pack</h4>
        <p>Random environmental details for immersion</p>
      </div>
      <div class="preset-card" onclick="loadPreset('memory')">
        <h4>üß† Memory Starter</h4>
        <p>Simple name + facts tracking for any scenario</p>
      </div>
    </div>
  </div>

  <!-- Module Tabs -->
  <div class="card">
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab(event, 'lorebook')">Lorebook</button>
      <button class="tab-btn" onclick="switchTab(event, 'memory')">Memory</button>
      <button class="tab-btn" onclick="switchTab(event, 'pacing')">Pacing</button>
      <button class="tab-btn" onclick="switchTab(event, 'tone')">Tone/State</button>
      <button class="tab-btn" onclick="switchTab(event, 'time')">Time & Environment</button>
      <button class="tab-btn" onclick="switchTab(event, 'ambient')">Ambient Events</button>
      <button class="tab-btn" onclick="switchTab(event, 'random')">Random Events</button>
      <button class="tab-btn" onclick="switchTab(event, 'combined')">Combined Conditions</button>
      <button class="tab-btn experimental" onclick="switchTab(event, 'scoring')">‚ö†Ô∏è Scoring (Experimental)</button>
      <button class="tab-btn experimental" onclick="switchTab(event, 'tester')">üß™ Script Tester</button>
    </div>

    <!-- LOREBOOK TAB -->
    <div id="lorebook" class="tab-panel active">
      <h3>üìñ Lorebook (Hierarchical Keyword Database)</h3>
      <p>Create a rich world with people, places, objects, moods, and events that trigger based on keywords.</p>
      
      <div class="warning-banner">
        <strong>‚ö†Ô∏è Token Warning:</strong> Keep entries 2-4 short paragraphs each. Too many long entries can cause slowdowns.
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" id="lorePadded" checked /> Use Padded Matching
        </label>
        <div class="help-text">Prevents partial word matches (e.g., "cat" won't trigger on "catch"). Note: Works best with single-word keywords. Multi-word phrases may need exact spacing.</div>
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" id="loreBreakEarly" checked /> Break After First Match
        </label>
        <div class="help-text">Stop after the first lore entry triggers (saves tokens, prevents multiple entries firing at once)</div>
      </div>

      <h4>üìù Lore Entries</h4>
      <button type="button" class="btn btn-secondary" onclick="addLoreEntry()">+ Add Entry</button>
      <div id="loreEntries" class="dynamic-list"></div>

      <button type="button" class="btn" onclick="generateLorebookScript()">Generate Lorebook Script</button>
      <button type="button" class="btn btn-secondary" onclick="copyToClipboard('lorebookOutput')">Copy to Clipboard</button>
      
      <div class="output-box" id="lorebookOutput">// Script will appear here after clicking Generate</div>

      <div class="pitfall-box">
        <strong>‚ö†Ô∏è Common Pitfalls:</strong>
        <ul>
          <li>Keywords too broad (e.g., "is", "the") trigger constantly</li>
          <li>Entries too long cause token bloat</li>
          <li>Without break-early, multiple entries can fire and overwhelm context</li>
          <li>Not using padded matching causes false triggers on partial words</li>
          <li>Same entry can trigger repeatedly ‚Üí enable deduplication below</li>
        </ul>
      </div>

      <div class="glossary">
        <h4>üìò Lorebook Glossary</h4>
        <dl>
          <dt>Keywords</dt>
          <dd>Words that trigger this lore entry (comma-separated, case-insensitive)</dd>
          <dt>Category</dt>
          <dd>Organizes entries: people, places, objects, moods, events</dd>
          <dt>Content</dt>
          <dd>Text injected into scenario when keywords match</dd>
          <dt>Padded Matching</dt>
          <dd>Requires spaces around keywords to avoid "cat" matching "scatter"</dd>
          <dt>Break-Early</dt>
          <dd>Stops checking after first match (recommended for performance)</dd>
        </dl>
      </div>
    </div>

    <!-- MEMORY TAB -->
    <div id="memory" class="tab-panel">
      <h3>üß† Memory System</h3>
      <p>Automatically detect and remember the user's name, facts about them, likes, and dislikes.</p>
      
      <div class="form-group">
        <label>Name Detection Trigger Phrase</label>
        <input type="text" id="memNamePhrase" placeholder="my name is" />
        <div class="help-text">The phrase that triggers name detection (case-insensitive)</div>
        <div class="example-text">Example: If user says "Hi, my name is Mar√≠a Garc√≠a", the script will remember "Mar√≠a Garc√≠a" (supports accents, hyphens, apostrophes, up to 40 characters)</div>
      </div>

      <div class="form-group">
        <label>Facts Keywords (comma-separated)</label>
        <input type="text" id="memFactsKeywords" placeholder="fact, i am, i work as, i study" />
        <div class="help-text">Keywords that trigger fact storage</div>
        <div class="example-text">Example: "Here's a fact: I love programming" ‚Üí saved as fact</div>
      </div>

      <div class="form-group">
        <label>Likes Keywords (comma-separated)</label>
        <input type="text" id="memLikesKeywords" placeholder="i like, i love, i enjoy, favorite" />
        <div class="help-text">Keywords that trigger likes storage</div>
        <div class="example-text">Example: "I love pizza" ‚Üí saved as like</div>
      </div>

      <div class="form-group">
        <label>Dislikes Keywords (comma-separated)</label>
        <input type="text" id="memDislikesKeywords" placeholder="i hate, i dislike, i don't like, can't stand" />
        <div class="help-text">Keywords that trigger dislikes storage</div>
        <div class="example-text">Example: "I hate mornings" ‚Üí saved as dislike</div>
      </div>

      <button type="button" class="btn" onclick="generateMemoryScript()">Generate Memory Script</button>
      <button type="button" class="btn btn-secondary" onclick="copyToClipboard('memoryOutput')">Copy to Clipboard</button>
      
      <div class="output-box" id="memoryOutput">// Script will appear here after clicking Generate</div>

      <div class="pitfall-box">
        <strong>‚ö†Ô∏è Common Pitfalls:</strong>
        <ul>
          <li>Trigger phrases too specific ‚Üí never fire</li>
          <li>No deduplication ‚Üí same fact saved multiple times (v3 includes basic dedupe)</li>
          <li>Scenario grows forever without maintenance</li>
          <li>Name regex may miss very long names (limited to 40 chars for safety)</li>
        </ul>
      </div>
    </div>

    <!-- PACING TAB -->
    <div id="pacing" class="tab-panel">
      <h3>üìä Pacing System (Message Count Gates)</h3>
      <p>Control story progression based on how many messages have been sent.</p>

      <div class="info-banner">
        <strong>üí° Pro Tip:</strong> Use pacing to gate major story beats. Combine with one-time events for reveals.
      </div>

      <div class="warning-banner">
        <strong>‚ö†Ô∏è Reroll Behavior:</strong> When you reroll a character response, <code>message_count</code> does NOT increment. Only new user messages count.
      </div>

      <h4>üìà Message Count Phases</h4>
      <button type="button" class="btn btn-secondary" onclick="addPacingPhase()">+ Add Phase</button>
      <div id="pacingPhases" class="dynamic-list"></div>

      <h4>üéØ One-Time Events (Exact Message Count)</h4>
      <button type="button" class="btn btn-secondary" onclick="addOneTimeEvent()">+ Add Event</button>
      <div id="oneTimeEvents" class="dynamic-list"></div>

      <button type="button" class="btn" onclick="generatePacingScript()">Generate Pacing Script</button>
      <button type="button" class="btn btn-secondary" onclick="copyToClipboard('pacingOutput')">Copy to Clipboard</button>
      
      <div class="output-box" id="pacingOutput">// Script will appear here after clicking Generate</div>

      <div class="pitfall-box">
        <strong>‚ö†Ô∏è Common Pitfalls:</strong>
        <ul>
          <li>Forgetting that rerolls don't increment message_count</li>
          <li>Overlapping phases causing conflicts</li>
          <li>One-time events at count 1 may miss if bot speaks first</li>
        </ul>
      </div>

      <div class="glossary">
        <h4>üìò Pacing Glossary</h4>
        <dl>
          <dt>message_count</dt>
          <dd>Built-in JanitorAI variable tracking total user messages sent (rerolls don't increment)</dd>
          <dt>Phases</dt>
          <dd>Ranges of messages (e.g., 1-10, 11-30) with associated behavior</dd>
          <dt>One-Time Events</dt>
          <dd>Fire exactly once at a specific message number</dd>
        </dl>
      </div>
    </div>

    <!-- TONE/STATE TAB -->
    <div id="tone" class="tab-panel">
      <h3>üé≠ Tone/State Engine</h3>
      <p>Dynamically shift character personality based on keywords in user messages.</p>

      <div class="form-group">
        <label>
          <input type="checkbox" id="tonePadded" checked /> Use Padded Matching
        </label>
        <div class="help-text">Prevents "angry" matching "danger". Note: Works best with single-word keywords.</div>
      </div>

      <h4>üé® Tone Triggers</h4>
      <button type="button" class="btn btn-secondary" onclick="addToneTrigger()">+ Add Trigger</button>
      <div id="toneTriggers" class="dynamic-list"></div>

      <button type="button" class="btn" onclick="generateToneScript()">Generate Tone Script</button>
      <button type="button" class="btn btn-secondary" onclick="copyToClipboard('toneOutput')">Copy to Clipboard</button>
      
      <div class="output-box" id="toneOutput">// Script will appear here after clicking Generate</div>

      <div class="pitfall-box">
        <strong>‚ö†Ô∏è Common Pitfalls:</strong>
        <ul>
          <li>Without padded matching, "sad" triggers on "salad"</li>
          <li>Multiple triggers fire ‚Üí personality bloats</li>
          <li>Mood doesn't reset between messages (use replace, not append)</li>
        </ul>
      </div>

      <div class="example-text">
        <strong>Example Trigger:</strong><br>
        Keywords: <code>angry, mad, furious</code><br>
        Personality Add-on: <code>{{char}} is currently angry and speaking tersely.</code>
      </div>
    </div>

    <!-- TIME & ENVIRONMENT TAB -->
    <div id="time" class="tab-panel">
      <h3>üåÖ Time & Environment System</h3>
      <p>Change character behavior and environment based on time of day.</p>

      <div class="warning-banner">
        <strong>‚ö†Ô∏è Time Source:</strong> Uses server time + your timezone offset. Time changes happen once per hour. Supports wrap-around (e.g., 22:00 to 03:00 for night).
      </div>

      <div class="form-group">
        <label>Timezone Offset (hours from UTC)</label>
        <input type="number" id="timeOffset" value="0" min="-12" max="14" />
        <div class="help-text">e.g., PST = -8, EST = -5, GMT = 0, JST = +9</div>
        <div class="example-text">Example: If server time is 14:00 UTC and offset is -8, local time is 06:00</div>
      </div>

      <h4>‚è∞ Time-Based Behaviors</h4>
      <button type="button" class="btn btn-secondary" onclick="addTimeSlot()">+ Add Time Slot</button>
      <div id="timeSlots" class="dynamic-list"></div>

      <button type="button" class="btn" onclick="generateTimeScript()">Generate Time Script</button>
      <button type="button" class="btn btn-secondary" onclick="copyToClipboard('timeOutput')">Copy to Clipboard</button>
      
      <div class="output-box" id="timeOutput">// Script will appear here after clicking Generate</div>

      <div class="pitfall-box">
        <strong>‚ö†Ô∏è Common Pitfalls:</strong>
        <ul>
          <li>Server time may not match your local time without offset</li>
          <li>Overlapping time slots cause conflicts</li>
          <li>Hour-based checks only update once per hour</li>
          <li>Forgot to handle wrap-around (e.g., 22:00-03:00) ‚Üí v3 handles this automatically</li>
        </ul>
      </div>
    </div>

    <!-- AMBIENT EVENTS TAB -->
    <div id="ambient" class="tab-panel">
      <h3>üåø Ambient Events (Random Flavor Text)</h3>
      <p>Add random environmental details to make the world feel alive.</p>

      <div class="warning-banner">
        <strong>‚ö†Ô∏è Scenario Growth:</strong> These add to scenario notes. Use sparingly to avoid bloat.
      </div>

      <div class="form-group">
        <label>Trigger Probability (%)</label>
        <input type="number" id="ambientProbability" value="10" min="1" max="100" />
        <div class="help-text">Chance each message triggers an ambient event (1-100)</div>
        <div class="example-text">Example: 10% = roughly 1 in 10 messages adds flavor text</div>
      </div>

      <h4>üé≤ Ambient Event Pool</h4>
      <button type="button" class="btn btn-secondary" onclick="addAmbientEvent()">+ Add Event</button>
      <div id="ambientEvents" class="dynamic-list"></div>

      <button type="button" class="btn" onclick="generateAmbientScript()">Generate Ambient Script</button>
      <button type="button" class="btn btn-secondary" onclick="copyToClipboard('ambientOutput')">Copy to Clipboard</button>
      
      <div class="output-box" id="ambientOutput">// Script will appear here after clicking Generate</div>

      <div class="pitfall-box">
        <strong>‚ö†Ô∏è Common Pitfalls:</strong>
        <ul>
          <li>High probability (>20%) causes rapid scenario bloat</li>
          <li>Events append forever without cleanup</li>
          <li>Same event can trigger multiple times (expected behavior)</li>
        </ul>
      </div>

      <div class="example-text">
        <strong>Example Event:</strong><br>
        <code>A bird chirps in the distance. The cafe smells of fresh coffee.</code>
      </div>
    </div>

    <!-- RANDOM EVENTS TAB -->
    <div id="random" class="tab-panel">
      <h3>üé≤ Random Events (Weighted Reactions)</h3>
      <p>Trigger random character reactions when user says specific phrases.</p>

      <h4>üéØ Event Triggers</h4>
      <button type="button" class="btn btn-secondary" onclick="addRandomEvent()">+ Add Event</button>
      <div id="randomEvents" class="dynamic-list"></div>

      <button type="button" class="btn" onclick="generateRandomScript()">Generate Random Events Script</button>
      <button type="button" class="btn btn-secondary" onclick="copyToClipboard('randomOutput')">Copy to Clipboard</button>
      
      <div class="output-box" id="randomOutput">// Script will appear here after clicking Generate</div>

      <div class="pitfall-box">
        <strong>‚ö†Ô∏è Common Pitfalls:</strong>
        <ul>
          <li>Trigger phrases too common ‚Üí fires constantly</li>
          <li>Responses not pipe-separated correctly</li>
          <li>Adding to personality instead of scenario</li>
        </ul>
      </div>

      <div class="example-text">
        <strong>Example Event:</strong><br>
        Trigger Phrase: <code>what do you think</code><br>
        Responses: <code>I think it's interesting|I'm not sure|That's a tough one</code> (pipe-separated, chosen randomly)
      </div>
    </div>

    <!-- COMBINED CONDITIONS TAB -->
    <div id="combined" class="tab-panel">
      <h3>üîó Combined Conditions (Multi-Trigger Rules)</h3>
      <p>Create rules that fire when multiple conditions are met (keywords + time + message count).</p>

      <div class="warning-banner">
        <strong>‚ö†Ô∏è Stateless Only:</strong> Combined rules work best with stateless checks (time + message_count + keywords). Time wrap-around supported (e.g., 22:00-03:00).
      </div>

      <h4>‚ö° Combined Rules</h4>
      <button type="button" class="btn btn-secondary" onclick="addCombinedRule()">+ Add Rule</button>
      <div id="combinedRules" class="dynamic-list"></div>

      <button type="button" class="btn" onclick="generateCombinedConditionsScript()">Generate Combined Script</button>
      <button type="button" class="btn btn-secondary" onclick="copyToClipboard('combinedOutput')">Copy to Clipboard</button>
      
      <div class="output-box" id="combinedOutput">// Script will appear here after clicking Generate</div>

      <div class="pitfall-box">
        <strong>‚ö†Ô∏è Common Pitfalls:</strong>
        <ul>
          <li>Conditions too strict ‚Üí never triggers</li>
          <li>Time checks without timezone offset mismatch user's local time</li>
          <li>Multiple rules fire at once causing bloat</li>
        </ul>
      </div>

      <div class="example-text">
        <strong>Example Rule:</strong><br>
        Keywords: <code>romantic, dinner</code><br>
        Min Hour: <code>18</code> Max Hour: <code>22</code><br>
        Min Messages: <code>20</code><br>
        Result: <code>{{char}} suggests a romantic candlelit dinner.</code><br>
        ‚Üí Only fires if user mentions "romantic" or "dinner" between 6pm-10pm after 20+ messages
      </div>
    </div>

    <!-- SCORING TAB -->
    <div id="scoring" class="tab-panel">
      <h3>üéØ Scoring Engine (EXPERIMENTAL)</h3>
      
      <div class="danger-banner">
        <strong>‚ö†Ô∏è EXPERIMENTAL FEATURE:</strong> Scoring is complex due to stateless constraints. Persistent mode uses fragile tag-based storage that may break. Use with extreme caution.
      </div>

      <div class="form-group">
        <label>Scoring Mode</label>
        <select id="scoringMode">
          <option value="stateless">Stateless (Single-Turn Sentiment) - RECOMMENDED</option>
          <option value="persistent">Persistent (Experimental Tag-Based) - FRAGILE</option>
        </select>
        <div class="help-text">
          <strong>Stateless:</strong> Analyzes current message only (safe)<br>
          <strong>Persistent:</strong> Uses {{char}} tags to store scores (fragile, may break with platform updates)
        </div>
      </div>

      <h4>‚ûï Positive Keywords</h4>
      <div class="form-group">
        <input type="text" id="scoringPositive" placeholder="love, great, wonderful, amazing" />
        <div class="example-text">Example: "You're amazing!" ‚Üí positive sentiment detected</div>
      </div>

      <h4>‚ûñ Negative Keywords</h4>
      <div class="form-group">
        <input type="text" id="scoringNegative" placeholder="hate, awful, terrible, horrible" />
        <div class="example-text">Example: "This is terrible" ‚Üí negative sentiment detected</div>
      </div>

      <h4>üìä Score Thresholds & Responses</h4>
      <button type="button" class="btn btn-secondary" onclick="addScoreThreshold()">+ Add Threshold</button>
      <div id="scoreThresholds" class="dynamic-list"></div>

      <button type="button" class="btn" onclick="generateScoringScript()">Generate Scoring Script</button>
      <button type="button" class="btn btn-secondary" onclick="copyToClipboard('scoringOutput')">Copy to Clipboard</button>
      
      <div class="output-box" id="scoringOutput">// Script will appear here after clicking Generate</div>

      <div class="pitfall-box">
        <strong>‚ö†Ô∏è Common Pitfalls:</strong>
        <ul>
          <li>Persistent mode tags can be stripped by platform updates</li>
          <li>Keyword sentiment too simplistic for nuanced emotion</li>
          <li>Score thresholds never reached with stateless mode</li>
          <li>No decay ‚Üí persistent scores grow forever</li>
        </ul>
      </div>
    </div>

    <!-- SCRIPT TESTER TAB -->
    <div id="tester" class="tab-panel">
      <h3>üß™ Script Tester</h3>
      <p>Test your generated script with sample messages to verify triggers work correctly before deploying to JanitorAI.</p>

      <div class="warning-banner">
        <strong>‚ö†Ô∏è Experimental Feature:</strong> This tester simulates the JanitorAI context environment. Results should match real behavior, but edge cases may differ.
      </div>

      <div class="form-group">
        <label>Script Source</label>
        <select id="testerScriptSource" onchange="updateTesterScript()">
          <option value="final">Final Combined Output</option>
          <option value="lorebook">Lorebook Script</option>
          <option value="memory">Memory Script</option>
          <option value="pacing">Pacing Script</option>
          <option value="tone">Tone/State Script</option>
          <option value="time">Time & Environment Script</option>
          <option value="ambient">Ambient Events Script</option>
          <option value="random">Random Events Script</option>
          <option value="combined">Combined Conditions Script</option>
          <option value="scoring">Scoring Script</option>
          <option value="custom">Custom Script (Paste Below)</option>
        </select>
        <div class="help-text">Choose which generated script to test, or paste a custom script</div>
      </div>

      <div id="testerCustomSection" style="display: none;">
        <div class="form-group">
          <label>Custom Script</label>
          <textarea id="testerCustomScript" rows="10" placeholder="Paste your script here..." style="font-family: 'Courier New', monospace; font-size: 0.85rem;"></textarea>
        </div>
        <div style="margin-bottom: 14px;">
          <strong>Load Example Preset:</strong>
          <button type="button" class="btn btn-secondary" onclick="loadTesterPreset('good')" style="margin-left: 8px;">‚úÖ Working Script</button>
          <button type="button" class="btn btn-secondary" onclick="loadTesterPreset('broken')" style="margin-left: 4px;">‚ùå Broken Script</button>
          <button type="button" class="btn btn-warning" onclick="loadTesterPreset('mega')" style="margin-left: 4px;">üî• MEGA Test (All Modules)</button>
        </div>
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" id="testerBatchMode" onchange="toggleBatchMode()" /> Enable Batch Testing (Multiple Messages)
        </label>
        <div class="help-text">Test multiple messages against the same script and see individual results for each</div>
      </div>

      <!-- Single Message Mode -->
      <div id="testerSingleMode">
        <div class="form-group">
          <label>Test Message</label>
          <textarea id="testerMessage" rows="3" placeholder="Enter a message to test against the script, e.g., 'I walk into the tavern and see the bartender'"></textarea>
          <div class="help-text">This simulates <code>context.chat.last_message</code></div>
        </div>
      </div>

      <!-- Batch Mode -->
      <div id="testerBatchSection" style="display: none;">
        <div class="form-group">
          <label>Test Messages</label>
          <button type="button" class="btn btn-secondary" onclick="addBatchTestMessage()" style="margin-left: 8px;">+ Add Message</button>
          <button type="button" class="btn btn-secondary" onclick="clearBatchMessages()" style="margin-left: 4px;">Clear All</button>
          <div id="batchTestMessages" class="dynamic-list" style="margin-top: 8px;"></div>
          <div class="help-text">Each message will be tested separately against the script. Add as many as you need.</div>
        </div>
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" id="testerMultiMessage" onchange="toggleMessageHistory()" /> Enable Message History
        </label>
        <div class="help-text">Test with multiple messages (simulates <code>context.chat.last_messages</code>)</div>
      </div>

      <div id="testerHistorySection" style="display: none;">
        <div class="form-group">
          <label>Message History (one per line, oldest first)</label>
          <textarea id="testerHistory" rows="5" placeholder="First message here
Second message here
Third message here"></textarea>
          <div class="help-text">Each line becomes a message in history. Current test message will be added as the latest.</div>
        </div>
      </div>

      <div class="form-group">
        <label>Character Name (optional)</label>
        <input type="text" id="testerCharName" placeholder="e.g., Luna" />
        <div class="help-text">Pre-fills <code>context.character.name</code> if your script uses it</div>
      </div>

      <!-- Single Test Buttons -->
      <div id="singleTestButtons">
        <button type="button" class="btn" onclick="runScriptTest()">‚ñ∂Ô∏è Run Test</button>
        <button type="button" class="btn btn-secondary" onclick="clearTestResults()">Clear Results</button>
      </div>

      <!-- Batch Test Buttons -->
      <div id="batchTestButtons" style="display: none;">
        <button type="button" class="btn btn-success" onclick="runBatchTests()">üöÄ Run All Tests</button>
        <button type="button" class="btn btn-secondary" onclick="clearBatchResults()">Clear Results</button>
      </div>

      <!-- Single Test Results -->
      <div id="testerResults" class="tester-results" style="display: none;">
        <h4>üìä Test Results</h4>

        <div class="tester-result-section">
          <strong>Console Output:</strong>
          <div class="output-box" id="testerConsoleOutput" style="max-height: 150px;">// Console logs will appear here</div>
        </div>

        <div class="tester-result-section">
          <strong>Personality Changes:</strong>
          <div class="output-box" id="testerPersonality" style="max-height: 100px;">(none)</div>
        </div>

        <div class="tester-result-section">
          <strong>Scenario Changes:</strong>
          <div class="output-box" id="testerScenario" style="max-height: 100px;">(none)</div>
        </div>

        <div class="tester-result-section">
          <strong>Example Dialogues Changes:</strong>
          <div class="output-box" id="testerExamples" style="max-height: 100px;">(none)</div>
        </div>
      </div>

      <!-- Batch Test Results -->
      <div id="batchResults" style="display: none;">
        <h4>üìä Batch Test Results</h4>
        <div id="batchResultsSummary" class="info-banner" style="margin-bottom: 12px;"></div>
        <div id="batchResultsList"></div>
      </div>

      <div class="pitfall-box">
        <strong>üí° Tips:</strong>
        <ul>
          <li>Generate your script first in the relevant tab before testing</li>
          <li>Test edge cases: keywords with punctuation, different capitalizations</li>
          <li>Try messages that should NOT trigger to verify specificity</li>
          <li>Check console output for any errors or debug logs from your script</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- TRIGGER ANALYZER -->
  <div class="card">
    <h3>üîç Trigger Analyzer</h3>
    <p>Scan all modules for potential keyword conflicts, overlaps, and bottlenecks.</p>
    <button type="button" class="btn" onclick="analyzeTriggers()">Analyze Triggers</button>
    <div id="analyzerResults"></div>
  </div>

  <!-- FINAL COMBINED OUTPUT -->
  <div class="card">
    <h3>üì¶ Final Combined Output</h3>
    <p>This is the complete script with all enabled modules merged in your chosen order.</p>
    <button type="button" class="btn btn-success" onclick="generateFinalCombinedScript()">üîÑ Regenerate Combined Script</button>
    <button type="button" class="btn btn-secondary" onclick="copyToClipboard('finalOutput')">Copy to Clipboard</button>
    <div class="output-box" id="finalOutput">// Combined script will appear here after clicking "Copy All Enabled Modules"</div>
  </div>

</div>

<script>
  // ===========================
  //   UTILITY FUNCTIONS
  // ===========================

  function escapeForScript(str) {
    if (!str) return '';
    // JSON.stringify handles quotes, newlines, special chars, and unicode safely
    // Slice off surrounding quotes, then escape single quotes for JS string literals
    return JSON.stringify(str).slice(1, -1).replace(/'/g, "\\'");
  }

  // Toast notification system - replaces blocking alert() dialogs
  var toastContainer = null;
  var toastTimeout = null;

  function showToast(message, type) {
    type = type || 'success';

    // Create container if it doesn't exist
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.className = 'toast-container';
      document.body.appendChild(toastContainer);
    }

    // Clear any existing toast
    if (toastTimeout) {
      clearTimeout(toastTimeout);
    }
    toastContainer.innerHTML = '';

    // Create new toast
    var toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    toastContainer.appendChild(toast);

    // Trigger animation
    setTimeout(function() {
      toast.classList.add('show');
    }, 10);

    // Auto-hide after 3 seconds
    toastTimeout = setTimeout(function() {
      toast.classList.remove('show');
      setTimeout(function() {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }, 3000);
  }

  function escapeForRegex(str) {
    if (!str) return '';
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  function switchTab(e, tabName) {
    var tabs = document.querySelectorAll('.tab-btn');
    var panels = document.querySelectorAll('.tab-panel');
    
    tabs.forEach(function(tab) {
      tab.classList.remove('active');
    });
    panels.forEach(function(panel) {
      panel.classList.remove('active');
    });

    e.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');
  }

  function copyToClipboard(elementId) {
    var text = document.getElementById(elementId).textContent;

    // Try modern clipboard API first (requires HTTPS)
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(function() {
        showToast('Copied to clipboard!', 'success');
      }, function() {
        // If clipboard API fails, fall back to legacy method
        fallbackCopyToClipboard(text);
      });
    } else {
      fallbackCopyToClipboard(text);
    }
  }

  // Robust fallback for mobile, WebViews, and non-HTTPS contexts
  function fallbackCopyToClipboard(text) {
    var textarea = document.createElement('textarea');
    textarea.value = text;

    // Prevent zooming on iOS (font-size < 16px triggers zoom)
    textarea.style.fontSize = '16px';

    // Hide the textarea while keeping it functional
    textarea.style.position = 'fixed';
    textarea.style.top = '0';
    textarea.style.left = '0';
    textarea.style.width = '2em';
    textarea.style.height = '2em';
    textarea.style.padding = '0';
    textarea.style.border = 'none';
    textarea.style.outline = 'none';
    textarea.style.boxShadow = 'none';
    textarea.style.background = 'transparent';
    textarea.style.opacity = '0';
    textarea.style.zIndex = '-1';

    // Prevent keyboard from appearing on mobile
    textarea.setAttribute('readonly', '');

    document.body.appendChild(textarea);

    // iOS-specific selection method
    if (navigator.userAgent.match(/ipad|ipod|iphone/i)) {
      textarea.contentEditable = true;
      textarea.readOnly = true;
      var range = document.createRange();
      range.selectNodeContents(textarea);
      var selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      textarea.setSelectionRange(0, 999999);
    } else {
      textarea.select();
    }

    var success = false;
    try {
      success = document.execCommand('copy');
    } catch (err) {
      success = false;
    }

    document.body.removeChild(textarea);

    if (success) {
      showToast('Copied to clipboard!', 'success');
    } else {
      showToast('Failed to copy. Please select and copy manually.', 'error');
    }
  }

  function updateTokenMeter() {
    var totalLength = 0;
    var items = document.querySelectorAll('#moduleOrder .order-item');

    items.forEach(function(item) {
      var module = item.getAttribute('data-module');
      var checkbox = document.getElementById('toggle-' + module);
      if (checkbox && checkbox.checked) {
        var outputId = module + 'Output';
        var outputEl = document.getElementById(outputId);
        if (outputEl && !outputEl.textContent.includes('// Script will appear here')) {
          // Ignore outputs that only contain "empty module" notices
          var isNoop = /module currently does nothing|entries configured|triggers configured|slots configured|phases or events configured|keywords configured|events configured|rules configured/i.test(outputEl.textContent);
          if (!isNoop) {
            totalLength += outputEl.textContent.length;
          }
        }
      }
    });

    document.getElementById('tokenCount').textContent = totalLength;
    var percentage = Math.min((totalLength / 10000) * 100, 100);
    document.getElementById('tokenFill').style.width = percentage + '%';
  }

  // Helper function for time wrap-around
  function generateHourInRangeFunction() {
    return "function hourInRange(h, start, end) {\n" +
           "  return start <= end ? (h >= start && h <= end) : (h >= start || h <= end);\n" +
           "}\n\n";
  }

  // ===========================
  //   DRAG & DROP FOR MODULE ORDER
  // ===========================

  (function() {
    var draggedItem = null;

    document.addEventListener('DOMContentLoaded', function() {
      var orderItems = document.querySelectorAll('.order-item');
      
      orderItems.forEach(function(item) {
        item.addEventListener('dragstart', function(e) {
          draggedItem = this;
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/html', this.innerHTML);
          this.style.opacity = '0.5';
        });

        item.addEventListener('dragend', function(e) {
          this.style.opacity = '';
        });

        item.addEventListener('dragover', function(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          
          if (this !== draggedItem) {
            var rect = this.getBoundingClientRect();
            var midpoint = rect.top + rect.height / 2;
            
            if (e.clientY < midpoint) {
              this.parentNode.insertBefore(draggedItem, this);
            } else {
              this.parentNode.insertBefore(draggedItem, this.nextSibling);
            }
          }
        });
      });
    });
  })();

  // ===========================
  //   RESET AND BATCH OPERATIONS
  // ===========================

  function resetAllFields() {
    if (!confirm('‚ö†Ô∏è This will clear all fields and reset to defaults. Are you sure?')) {
      return;
    }

    // Reset memory
    document.getElementById('memNamePhrase').value = 'my name is';
    document.getElementById('memFactsKeywords').value = 'fact, i am, i work as, i study';
    document.getElementById('memLikesKeywords').value = 'i like, i love, i enjoy, favorite';
    document.getElementById('memDislikesKeywords').value = 'i hate, i dislike, i don\'t like, can\'t stand';

    // Clear dynamic lists
    document.getElementById('loreEntries').innerHTML = '';
    document.getElementById('timeSlots').innerHTML = '';
    document.getElementById('pacingPhases').innerHTML = '';
    document.getElementById('oneTimeEvents').innerHTML = '';
    document.getElementById('toneTriggers').innerHTML = '';
    document.getElementById('ambientEvents').innerHTML = '';
    document.getElementById('randomEvents').innerHTML = '';
    document.getElementById('combinedRules').innerHTML = '';
    document.getElementById('scoreThresholds').innerHTML = '';

    // Reset other fields
    document.getElementById('timeOffset').value = '0';
    document.getElementById('ambientProbability').value = '10';
    document.getElementById('scoringPositive').value = 'love, great, wonderful, amazing';
    document.getElementById('scoringNegative').value = 'hate, awful, terrible, horrible';
    document.getElementById('scoringMode').value = 'stateless';

    // Clear outputs
    var outputs = ['memoryOutput', 'lorebookOutput', 'timeOutput', 'pacingOutput', 'toneOutput', 'scoringOutput', 'ambientOutput', 'randomOutput', 'combinedOutput', 'finalOutput'];
    outputs.forEach(function(id) {
      document.getElementById(id).textContent = '// Script will appear here after clicking Generate';
    });

    // Restore default toggles
    document.getElementById('toggle-lorebook').checked = true;
    document.getElementById('toggle-memory').checked = true;
    document.getElementById('toggle-pacing').checked = true;
    document.getElementById('toggle-tone').checked = true;

    document.getElementById('toggle-time').checked = false;
    document.getElementById('toggle-ambient').checked = false;
    document.getElementById('toggle-random').checked = false;
    document.getElementById('toggle-combined').checked = false;
    document.getElementById('toggle-scoring').checked = false;

    // Add one default entry for each
    addLoreEntry();
    addTimeSlot();
    addPacingPhase();
    addToneTrigger();
    addAmbientEvent();

    showToast('All fields reset to defaults!', 'success');
  }

  function generateAllEnabledModules() {
    var items = document.querySelectorAll('#moduleOrder .order-item');
    var enabledModules = [];
    
    items.forEach(function(item) {
      var module = item.getAttribute('data-module');
      var checkbox = document.getElementById('toggle-' + module);
      if (checkbox && checkbox.checked) {
        enabledModules.push(module);
      }
    });

    if (enabledModules.length === 0) {
      showToast('No modules enabled! Please enable at least one module.', 'warning');
      return;
    }

    // Generate each enabled module
    enabledModules.forEach(function(module) {
      switch(module) {
        case 'memory': generateMemoryScript(); break;
        case 'lorebook': generateLorebookScript(); break;
        case 'time': generateTimeScript(); break;
        case 'pacing': generatePacingScript(); break;
        case 'tone': generateToneScript(); break;
        case 'scoring': generateScoringScript(); break;
        case 'ambient': generateAmbientScript(); break;
        case 'random': generateRandomScript(); break;
        case 'combined': generateCombinedConditionsScript(); break;
      }
    });

    // Then combine
    setTimeout(function() {
      generateFinalCombinedScript();
    }, 100);

    showToast('Generated all ' + enabledModules.length + ' enabled modules and combined them!', 'success');
  }

  // ===========================
  //   PRESET LOADER
  // ===========================

  function loadPreset(presetName) {
    if (presetName === 'slowburn') {
      document.getElementById('memNamePhrase').value = 'my name is';
      document.getElementById('memFactsKeywords').value = 'fact, i am, i work as';
      document.getElementById('memLikesKeywords').value = 'i like, i love, favorite';
      document.getElementById('memDislikesKeywords').value = 'i hate, i dislike';

      document.getElementById('pacingPhases').innerHTML = '';
      addPacingPhase();
      var phases = document.querySelectorAll('#pacingPhases .dynamic-item');
      phases[0].querySelector('input[placeholder="Min messages"]').value = '1';
      phases[0].querySelector('input[placeholder="Max messages"]').value = '15';
      phases[0].querySelector('textarea').value = '{{char}} is cautious and formal, still getting to know {{user}}.';

      addPacingPhase();
      phases = document.querySelectorAll('#pacingPhases .dynamic-item');
      phases[1].querySelector('input[placeholder="Min messages"]').value = '16';
      phases[1].querySelector('input[placeholder="Max messages"]').value = '40';
      phases[1].querySelector('textarea').value = '{{char}} is warming up, showing more genuine interest.';

      addPacingPhase();
      phases = document.querySelectorAll('#pacingPhases .dynamic-item');
      phases[2].querySelector('input[placeholder="Min messages"]').value = '41';
      phases[2].querySelector('input[placeholder="Max messages"]').value = '999';
      phases[2].querySelector('textarea').value = '{{char}} feels comfortable and open, deeply engaged.';

      showToast('Slow-Burn Romance preset loaded! Check Memory and Pacing tabs.', 'success');
      switchTab({target: document.querySelectorAll('.tab-btn')[1]}, 'memory');

    } else if (presetName === 'rpg') {
      document.getElementById('loreEntries').innerHTML = '';
      addLoreEntry();
      var entries = document.querySelectorAll('#loreEntries .dynamic-item');
      entries[0].querySelector('select').value = 'people';
      entries[0].querySelector('input[placeholder="Keywords (comma-separated)"]').value = 'blacksmith, forge';
      entries[0].querySelector('textarea').value = 'The blacksmith Gareth runs the forge. He is gruff but fair, known for masterwork weapons.';

      addLoreEntry();
      entries = document.querySelectorAll('#loreEntries .dynamic-item');
      entries[1].querySelector('select').value = 'places';
      entries[1].querySelector('input[placeholder="Keywords (comma-separated)"]').value = 'tavern, inn';
      entries[1].querySelector('textarea').value = 'The Rusty Tankard tavern is a cozy refuge, always filled with adventurers and rumors.';

      addLoreEntry();
      entries = document.querySelectorAll('#loreEntries .dynamic-item');
      entries[2].querySelector('select').value = 'events';
      entries[2].querySelector('input[placeholder="Keywords (comma-separated)"]').value = 'festival, celebration';
      entries[2].querySelector('textarea').value = 'The annual Harvest Festival brings music, dancing, and competitions to the town square.';

      showToast('RPG Adventure preset loaded! Check Lorebook tab.', 'success');
      switchTab({target: document.querySelector('.tab-btn')}, 'lorebook');

    } else if (presetName === 'ambient') {
      document.getElementById('ambientEvents').innerHTML = '';
      addAmbientEvent();
      var events = document.querySelectorAll('#ambientEvents .dynamic-item');
      events[0].querySelector('textarea').value = 'A gentle breeze rustles the curtains.';

      addAmbientEvent();
      events = document.querySelectorAll('#ambientEvents .dynamic-item');
      events[1].querySelector('textarea').value = 'The faint sound of traffic hums in the distance.';

      addAmbientEvent();
      events = document.querySelectorAll('#ambientEvents .dynamic-item');
      events[2].querySelector('textarea').value = 'Sunlight filters through the window, casting warm patterns.';

      addAmbientEvent();
      events = document.querySelectorAll('#ambientEvents .dynamic-item');
      events[3].querySelector('textarea').value = 'The smell of fresh coffee lingers in the air.';

      document.getElementById('ambientProbability').value = '15';

      showToast('Ambient Flavor Pack preset loaded! Check Ambient Events tab.', 'success');
      switchTab({target: document.querySelectorAll('.tab-btn')[5]}, 'ambient');

    } else if (presetName === 'memory') {
      document.getElementById('memNamePhrase').value = 'my name is';
      document.getElementById('memFactsKeywords').value = 'fact, i am, i work, i study';
      document.getElementById('memLikesKeywords').value = 'i like, i love, i enjoy';
      document.getElementById('memDislikesKeywords').value = 'i hate, i dislike, i don\'t like';

      showToast('Memory Starter preset loaded! Check Memory tab.', 'success');
      switchTab({target: document.querySelectorAll('.tab-btn')[1]}, 'memory');
    }
  }

  // ===========================
  //   MEMORY SYSTEM
  // ===========================

  // Memory builder function - accepts standalone parameter
  function buildMemoryScript(standalone) {
    var namePhrase = escapeForRegex(document.getElementById('memNamePhrase').value.trim().toLowerCase());
    var factsKeywords = document.getElementById('memFactsKeywords').value.split(',').map(function(k) { return escapeForScript(k.trim().toLowerCase()); }).filter(Boolean);
    var likesKeywords = document.getElementById('memLikesKeywords').value.split(',').map(function(k) { return escapeForScript(k.trim().toLowerCase()); }).filter(Boolean);
    var dislikesKeywords = document.getElementById('memDislikesKeywords').value.split(',').map(function(k) { return escapeForScript(k.trim().toLowerCase()); }).filter(Boolean);
    var debugMode = document.getElementById('debugMode').checked;

    var script = "// ============================================\n";
    script += "// MODULE: MEMORY SYSTEM\n";
    script += "// ============================================\n\n";

    // Check for any valid configuration
    var hasAnyConfig = !!namePhrase || factsKeywords.length > 0 || likesKeywords.length > 0 || dislikesKeywords.length > 0;

    if (!hasAnyConfig) {
      script += "// (No memory triggers configured ‚Äî this module currently does nothing.)\n";
      return script;
    }

    // Only include initContext if standalone
    if (standalone) {
      script += "// Init function for standalone use\n";
      script += "function initContext() {\n";
      script += "  if (!context.character) context.character = {};\n";
      script += "  if (!context.character.personality) context.character.personality = \"\";\n";
      script += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
      script += "}\n";
      script += "initContext();\n\n";
    }

    // Get message safely
    script += "// Get last user message safely\n";
    script += "var message = (context.chat && context.chat.last_message) ? context.chat.last_message : \"\";\n";
    script += "var last_message = message.toLowerCase();\n";
    script += "var memoryUpdated = false;\n\n";

    // Only add name detection if namePhrase is provided
    if (namePhrase) {
      script += "// Name Detection (captures names with accents, hyphens, apostrophes)\n";
      script += "var nameRegex = new RegExp('" + namePhrase + "\\\\s+([^\\\\d,.;!?]{2,40})', 'i');\n";
      script += "var nameMatch = last_message.match(nameRegex);\n";
      script += "if (nameMatch && nameMatch[1]) {\n";
      script += "  var detectedName = nameMatch[1].trim();\n";
      script += "  // Dedupe: only add if not already present\n";
      script += "  if (context.character.scenario.indexOf('User name: ' + detectedName) === -1) {\n";
      script += "    context.character.scenario += '\\nUser name: ' + detectedName;\n";
      script += "    memoryUpdated = true;\n";
      script += "  }\n";
      script += "}\n\n";
    }

    // Facts with deduplication
    if (factsKeywords.length > 0) {
      script += "// Facts Detection with deduplication\n";
      script += "var factsKeywords = [" + factsKeywords.map(function(k) { return "'" + k + "'"; }).join(", ") + "];\n";
      script += "for (var i = 0; i < factsKeywords.length; i++) {\n";
      script += "  if (last_message.indexOf(factsKeywords[i]) !== -1) {\n";
      script += "    var factEntry = 'Fact: ' + message;\n";
      script += "    if (context.character.scenario.indexOf(factEntry) === -1) {\n";
      script += "      context.character.scenario += '\\n' + factEntry;\n";
      script += "      memoryUpdated = true;\n";
      script += "    }\n";
      script += "    break;\n";
      script += "  }\n";
      script += "}\n\n";
    }

    // Likes with deduplication
    if (likesKeywords.length > 0) {
      script += "// Likes Detection with deduplication\n";
      script += "var likesKeywords = [" + likesKeywords.map(function(k) { return "'" + k + "'"; }).join(", ") + "];\n";
      script += "for (var i = 0; i < likesKeywords.length; i++) {\n";
      script += "  if (last_message.indexOf(likesKeywords[i]) !== -1) {\n";
      script += "    var likeEntry = 'Likes: ' + message;\n";
      script += "    if (context.character.scenario.indexOf(likeEntry) === -1) {\n";
      script += "      context.character.scenario += '\\n' + likeEntry;\n";
      script += "      memoryUpdated = true;\n";
      script += "    }\n";
      script += "    break;\n";
      script += "  }\n";
      script += "}\n\n";
    }

    // Dislikes with deduplication
    if (dislikesKeywords.length > 0) {
      script += "// Dislikes Detection with deduplication\n";
      script += "var dislikesKeywords = [" + dislikesKeywords.map(function(k) { return "'" + k + "'"; }).join(", ") + "];\n";
      script += "for (var i = 0; i < dislikesKeywords.length; i++) {\n";
      script += "  if (last_message.indexOf(dislikesKeywords[i]) !== -1) {\n";
      script += "    var dislikeEntry = 'Dislikes: ' + message;\n";
      script += "    if (context.character.scenario.indexOf(dislikeEntry) === -1) {\n";
      script += "      context.character.scenario += '\\n' + dislikeEntry;\n";
      script += "      memoryUpdated = true;\n";
      script += "    }\n";
      script += "    break;\n";
      script += "  }\n";
      script += "}\n\n";
    }

    if (debugMode) {
      script += "// Debug Output\n";
      script += "if (memoryUpdated) {\n";
      script += "  context.character.scenario += '\\n(debug: memory updated)';\n";
      script += "}\n";
    }

    return script;
  }

  function generateMemoryScript() {
    var script = buildMemoryScript(true);
    document.getElementById('memoryOutput').textContent = script;
    updateTokenMeter();
  }

  // ===========================
  //   LOREBOOK SYSTEM
  // ===========================

  function addLoreEntry() {
    var container = document.getElementById('loreEntries');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.innerHTML = '<select style="width:120px;"><option value="people">People</option><option value="places">Places</option><option value="objects">Objects</option><option value="moods">Moods</option><option value="events">Events</option></select><input type="text" placeholder="Keywords (comma-separated)" style="flex:1;" /><textarea placeholder="Lore content to inject..." style="flex:2;"></textarea><button type="button" onclick="this.parentElement.remove()">Remove</button>';
    container.appendChild(item);
  }

  // Lorebook builder function - accepts standalone parameter
  function buildLorebookScript(standalone) {
    var padded = document.getElementById('lorePadded').checked;
    var breakEarly = document.getElementById('loreBreakEarly').checked;
    var debugMode = document.getElementById('debugMode').checked;

    var entries = document.querySelectorAll('#loreEntries .dynamic-item');
    var lorebook = {
      people: [],
      places: [],
      objects: [],
      moods: [],
      events: []
    };

    entries.forEach(function(entry) {
      var category = entry.querySelector('select').value;
      var keywords = entry.querySelector('input').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
      var content = entry.querySelector('textarea').value.trim();

      if (keywords.length > 0 && content) {
        lorebook[category].push({
          keywords: keywords,
          content: content
        });
      }
    });

    var script = "// ============================================\n";
    script += "// MODULE: LOREBOOK\n";
    script += "// ============================================\n\n";

    // Check for any valid configuration
    var hasEntries = lorebook.people.length > 0 || lorebook.places.length > 0 ||
                     lorebook.objects.length > 0 || lorebook.moods.length > 0 ||
                     lorebook.events.length > 0;

    if (!hasEntries) {
      script += "// (No lorebook entries configured ‚Äî this module currently does nothing.)\n";
      return script;
    }

    // Only include initContext if standalone
    if (standalone) {
      script += "// Init function for standalone use\n";
      script += "function initContext() {\n";
      script += "  if (!context.character) context.character = {};\n";
      script += "  if (!context.character.personality) context.character.personality = \"\";\n";
      script += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
      script += "}\n";
      script += "initContext();\n\n";
    }

    // Get message safely
    script += "// Get last user message safely\n";
    script += "var message = (context.chat && context.chat.last_message) ? context.chat.last_message : \"\";\n\n";

    script += "var lorebook = " + JSON.stringify(lorebook, null, 2) + ";\n\n";

    if (padded) {
      script += "var padded = ' ' + message.toLowerCase() + ' ';\n";
    } else {
      script += "var msgLower = message.toLowerCase();\n";
    }

    script += "var loreTriggered = false;\n";
    script += "var found = false;\n\n";

    script += "// Lorebook lookup with " + (breakEarly ? "break-early" : "multi-match") + " and deduplication\n";
    script += "for (var category in lorebook) {\n";
    script += "  var entries = lorebook[category];\n";
    script += "  for (var i = 0; i < entries.length && !found; i++) {\n";
    script += "    var entry = entries[i];\n";
    script += "    for (var k = 0; k < entry.keywords.length; k++) {\n";
    if (padded) {
      script += "      if (padded.indexOf(' ' + entry.keywords[k] + ' ') !== -1) {\n";
    } else {
      script += "      if (msgLower.indexOf(entry.keywords[k]) !== -1) {\n";
    }
    script += "        // Dedupe: only add if not already present\n";
    script += "        if (context.character.scenario.indexOf(entry.content) === -1) {\n";
    script += "          context.character.scenario += '\\n' + entry.content;\n";
    script += "          loreTriggered = true;\n";
    script += "        }\n";
    if (breakEarly) {
      script += "        found = true;\n";
    }
    script += "        break;\n";
    script += "      }\n";
    script += "    }\n";
    if (breakEarly) {
      script += "    if (found) break;\n";
    }
    script += "  }\n";
    if (breakEarly) {
      script += "  if (found) break;\n";
    }
    script += "}\n\n";

    if (debugMode) {
      script += "if (loreTriggered) {\n";
      script += "  context.character.scenario += '\\n(debug: lorebook fired)';\n";
      script += "}\n";
    }

    return script;
  }

  function generateLorebookScript() {
    var script = buildLorebookScript(true);
    document.getElementById('lorebookOutput').textContent = script;
    updateTokenMeter();
  }

  // ===========================
  //   TIME & ENVIRONMENT
  // ===========================

  function addTimeSlot() {
    var container = document.getElementById('timeSlots');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.innerHTML = '<input type="number" placeholder="Start hour (0-23)" min="0" max="23" style="width:120px;" /><input type="number" placeholder="End hour (0-23)" min="0" max="23" style="width:120px;" /><textarea placeholder="Scenario add-on for this time range..." style="flex:1;"></textarea><button type="button" onclick="this.parentElement.remove()">Remove</button>';
    container.appendChild(item);
  }

  // Time builder function - accepts standalone parameter
  function buildTimeScript(standalone) {
    var offset = parseInt(document.getElementById('timeOffset').value, 10) || 0;
    var debugMode = document.getElementById('debugMode').checked;
    var slots = document.querySelectorAll('#timeSlots .dynamic-item');

    var script = "// ============================================\n";
    script += "// MODULE: TIME & ENVIRONMENT\n";
    script += "// ============================================\n\n";

    // Check for any valid configuration
    var hasSlots = false;
    slots.forEach(function(slot) {
      var start = parseInt(slot.querySelectorAll('input')[0].value, 10);
      var end = parseInt(slot.querySelectorAll('input')[1].value, 10);
      var content = slot.querySelector('textarea').value.trim();
      if (!isNaN(start) && !isNaN(end) && content) {
        hasSlots = true;
      }
    });

    if (!hasSlots) {
      script += "// (No time slots configured ‚Äî this module currently does nothing.)\n";
      return script;
    }

    // Only include initContext if standalone
    if (standalone) {
      script += "// Init function for standalone use\n";
      script += "function initContext() {\n";
      script += "  if (!context.character) context.character = {};\n";
      script += "  if (!context.character.personality) context.character.personality = \"\";\n";
      script += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
      script += "}\n";
      script += "initContext();\n\n";
    }

    // Add hourInRange function for wrap-around support
    script += generateHourInRangeFunction();

    script += "var offset = " + offset + ";\n";
    script += "var hour = (new Date().getHours() + offset + 24) % 24;\n";
    script += "var timeSet = false;\n\n";

    slots.forEach(function(slot) {
      var start = parseInt(slot.querySelectorAll('input')[0].value, 10);
      var end = parseInt(slot.querySelectorAll('input')[1].value, 10);
      var content = slot.querySelector('textarea').value.trim();

      if (!isNaN(start) && !isNaN(end) && content) {
        script += "if (hourInRange(hour, " + start + ", " + end + ")) {\n";
        script += "  context.character.scenario += '\\n" + escapeForScript(content) + "';\n";
        script += "  timeSet = true;\n";
        script += "}\n";
      }
    });

    if (debugMode) {
      script += "\nif (timeSet) {\n";
      script += "  context.character.scenario += '\\n(debug: time module fired, hour=' + hour + ')';\n";
      script += "}\n";
    }

    return script;
  }

  function generateTimeScript() {
    var script = buildTimeScript(true);
    document.getElementById('timeOutput').textContent = script;
    updateTokenMeter();
  }

  // ===========================
  //   PACING SYSTEM
  // ===========================

  function addPacingPhase() {
    var container = document.getElementById('pacingPhases');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.innerHTML = '<input type="number" placeholder="Min messages" min="1" style="width:120px;" /><input type="number" placeholder="Max messages" min="1" style="width:120px;" /><textarea placeholder="Scenario add-on for this phase..." style="flex:1;"></textarea><button type="button" onclick="this.parentElement.remove()">Remove</button>';
    container.appendChild(item);
  }

  function addOneTimeEvent() {
    var container = document.getElementById('oneTimeEvents');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.innerHTML = '<input type="number" placeholder="Exact message #" min="1" style="width:120px;" /><textarea placeholder="One-time event content..." style="flex:1;"></textarea><button type="button" onclick="this.parentElement.remove()">Remove</button>';
    container.appendChild(item);
  }

  // Pacing builder function - accepts standalone parameter
  function buildPacingScript(standalone) {
    var phases = document.querySelectorAll('#pacingPhases .dynamic-item');
    var events = document.querySelectorAll('#oneTimeEvents .dynamic-item');
    var debugMode = document.getElementById('debugMode').checked;

    var script = "// ============================================\n";
    script += "// MODULE: PACING\n";
    script += "// ============================================\n\n";

    // Check for any valid configuration
    var hasPhases = false;
    var hasEvents = false;

    phases.forEach(function(phase) {
      var min = parseInt(phase.querySelectorAll('input')[0].value, 10);
      var max = parseInt(phase.querySelectorAll('input')[1].value, 10);
      var content = phase.querySelector('textarea').value.trim();
      if (!isNaN(min) && !isNaN(max) && content) {
        hasPhases = true;
      }
    });

    events.forEach(function(event) {
      var exact = parseInt(event.querySelector('input').value, 10);
      var content = event.querySelector('textarea').value.trim();
      if (!isNaN(exact) && content) {
        hasEvents = true;
      }
    });

    if (!hasPhases && !hasEvents) {
      script += "// (No pacing phases or events configured ‚Äî this module currently does nothing.)\n";
      return script;
    }

    // Only include initContext if standalone
    if (standalone) {
      script += "// Init function for standalone use\n";
      script += "function initContext() {\n";
      script += "  if (!context.character) context.character = {};\n";
      script += "  if (!context.character.personality) context.character.personality = \"\";\n";
      script += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
      script += "}\n";
      script += "initContext();\n\n";

      // Add message_count alias for standalone mode
      script += "// Safe message counter alias for pacing module\n";
      script += "var message_count = (context.chat && typeof context.chat.message_count === 'number')\n";
      script += "  ? context.chat.message_count\n";
      script += "  : 0;\n\n";
    }

    script += "var count = message_count;\n";
    script += "var pacingSet = false;\n\n";

    // Phases
    if (hasPhases) {
      script += "// Message Count Phases\n";
      phases.forEach(function(phase) {
        var min = parseInt(phase.querySelectorAll('input')[0].value, 10);
        var max = parseInt(phase.querySelectorAll('input')[1].value, 10);
        var content = phase.querySelector('textarea').value.trim();

        if (!isNaN(min) && !isNaN(max) && content) {
          script += "if (count >= " + min + " && count <= " + max + ") {\n";
          script += "  context.character.scenario += '\\n" + escapeForScript(content) + "';\n";
          script += "  pacingSet = true;\n";
          script += "}\n";
        }
      });
      script += "\n";
    }

    // One-time events
    if (hasEvents) {
      script += "// One-Time Events\n";
      events.forEach(function(event) {
        var exact = parseInt(event.querySelector('input').value, 10);
        var content = event.querySelector('textarea').value.trim();

        if (!isNaN(exact) && content) {
          script += "if (count === " + exact + ") {\n";
          script += "  context.character.scenario += '\\n" + escapeForScript(content) + "';\n";
          script += "  pacingSet = true;\n";
          script += "}\n";
        }
      });
    }

    if (debugMode) {
      script += "\nif (pacingSet) {\n";
      script += "  context.character.scenario += '\\n(debug: pacing fired, message_count=' + count + ')';\n";
      script += "}\n";
    }

    return script;
  }

  function generatePacingScript() {
    var script = buildPacingScript(true);
    document.getElementById('pacingOutput').textContent = script;
    updateTokenMeter();
  }

  // ===========================
  //   TONE/STATE ENGINE
  // ===========================

  function addToneTrigger() {
    var container = document.getElementById('toneTriggers');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.innerHTML = '<input type="text" placeholder="Keywords (comma-separated)" style="flex:1;" /><textarea placeholder="Personality add-on when triggered..." style="flex:1;"></textarea><button type="button" onclick="this.parentElement.remove()">Remove</button>';
    container.appendChild(item);
  }

  // Tone builder function - accepts standalone parameter
  function buildToneScript(standalone) {
    var padded = document.getElementById('tonePadded').checked;
    var debugMode = document.getElementById('debugMode').checked;
    var triggers = document.querySelectorAll('#toneTriggers .dynamic-item');

    var script = "// ============================================\n";
    script += "// MODULE: TONE/STATE ENGINE\n";
    script += "// ============================================\n\n";

    // Check for any valid configuration
    var hasTriggers = false;
    triggers.forEach(function(trigger) {
      var keywords = trigger.querySelector('input').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
      var content = trigger.querySelector('textarea').value.trim();
      if (keywords.length > 0 && content) {
        hasTriggers = true;
      }
    });

    if (!hasTriggers) {
      script += "// (No tone triggers configured ‚Äî this module currently does nothing.)\n";
      return script;
    }

    // Only include initContext if standalone
    if (standalone) {
      script += "// Init function for standalone use\n";
      script += "function initContext() {\n";
      script += "  if (!context.character) context.character = {};\n";
      script += "  if (!context.character.personality) context.character.personality = \"\";\n";
      script += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
      script += "}\n";
      script += "initContext();\n\n";
    }

    // Get message safely
    script += "// Get last user message safely\n";
    script += "var message = (context.chat && context.chat.last_message) ? context.chat.last_message : \"\";\n\n";

    if (padded) {
      script += "var padded = ' ' + message.toLowerCase() + ' ';\n";
    } else {
      script += "var msgLower = message.toLowerCase();\n";
    }

    script += "var toneSet = false;\n\n";

    triggers.forEach(function(trigger) {
      var keywords = trigger.querySelector('input').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
      var content = trigger.querySelector('textarea').value.trim();

      if (keywords.length > 0 && content) {
        script += "// Tone Trigger: " + keywords.join(', ') + "\n";
        keywords.forEach(function(keyword) {
          if (padded) {
            script += "if (padded.indexOf(' " + escapeForScript(keyword) + " ') !== -1) {\n";
          } else {
            script += "if (msgLower.indexOf('" + escapeForScript(keyword) + "') !== -1) {\n";
          }
          script += "  context.character.personality += '\\n" + escapeForScript(content) + "';\n";
          script += "  toneSet = true;\n";
          script += "}\n";
        });
        script += "\n";
      }
    });

    if (debugMode) {
      script += "if (toneSet) {\n";
      script += "  context.character.scenario += '\\n(debug: tone engine fired)';\n";
      script += "}\n";
    }

    return script;
  }

  function generateToneScript() {
    var script = buildToneScript(true);
    document.getElementById('toneOutput').textContent = script;
    updateTokenMeter();
  }

  // ===========================
  //   SCORING ENGINE
  // ===========================

  function addScoreThreshold() {
    var container = document.getElementById('scoreThresholds');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.innerHTML = '<select style="width:80px;"><option value=">=">>=</option><option value="<="><=</option><option value="==">=</option></select><input type="number" placeholder="Value" style="width:80px;" /><textarea placeholder="Response when score meets this condition..." style="flex:1;"></textarea><button type="button" onclick="this.parentElement.remove()">Remove</button>';
    container.appendChild(item);
  }

  // Scoring builder function - accepts standalone parameter
  function buildScoringScript(standalone) {
    var mode = document.getElementById('scoringMode').value;
    var positive = document.getElementById('scoringPositive').value.split(',').map(function(k) { return escapeForScript(k.trim().toLowerCase()); }).filter(Boolean);
    var negative = document.getElementById('scoringNegative').value.split(',').map(function(k) { return escapeForScript(k.trim().toLowerCase()); }).filter(Boolean);
    var thresholds = document.querySelectorAll('#scoreThresholds .dynamic-item');
    var debugMode = document.getElementById('debugMode').checked;

    var script = "// ============================================\n";
    script += "// MODULE: SCORING ENGINE (" + mode.toUpperCase() + ")\n";
    script += "// ============================================\n\n";

    // Check for any valid configuration
    var hasThresholds = false;
    thresholds.forEach(function(threshold) {
      var value = parseInt(threshold.querySelector('input').value, 10);
      var response = threshold.querySelector('textarea').value.trim();
      if (!isNaN(value) && response) {
        hasThresholds = true;
      }
    });

    if (positive.length === 0 && negative.length === 0 && !hasThresholds) {
      script += "// (No scoring keywords configured ‚Äî this module currently does nothing.)\n";
      return script;
    }

    // Only include initContext if standalone
    if (standalone) {
      script += "// Init function for standalone use\n";
      script += "function initContext() {\n";
      script += "  if (!context.character) context.character = {};\n";
      script += "  if (!context.character.personality) context.character.personality = \"\";\n";
      script += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
      script += "}\n";
      script += "initContext();\n\n";
    }

    // Get message safely
    script += "// Get last user message safely\n";
    script += "var message = (context.chat && context.chat.last_message) ? context.chat.last_message : \"\";\n\n";

    if (mode === 'persistent') {
      script += "// EXPERIMENTAL: Persistent scoring via {{char}} tags\n";
      script += "// WARNING: Fragile and may break with platform updates\n\n";
      script += "var scoreMatch = context.character.scenario.match(/\\{\\{char_score:([-\\d]+)\\}\\}/);\n";
      script += "var score = scoreMatch ? parseInt(scoreMatch[1], 10) : 0;\n\n";
    } else {
      script += "// Stateless: Single-turn sentiment analysis\n";
      script += "var score = 0;\n\n";
    }

    script += "var msgLower = message.toLowerCase();\n\n";

    // Positive keywords
    if (positive.length > 0) {
      script += "// Positive keywords\n";
      script += "var positiveKeywords = [" + positive.map(function(k) { return "'" + k + "'"; }).join(", ") + "];\n";
      script += "for (var i = 0; i < positiveKeywords.length; i++) {\n";
      script += "  if (msgLower.indexOf(positiveKeywords[i]) !== -1) {\n";
      script += "    score += 1;\n";
      script += "  }\n";
      script += "}\n\n";
    }

    // Negative keywords
    if (negative.length > 0) {
      script += "// Negative keywords\n";
      script += "var negativeKeywords = [" + negative.map(function(k) { return "'" + k + "'"; }).join(", ") + "];\n";
      script += "for (var i = 0; i < negativeKeywords.length; i++) {\n";
      script += "  if (msgLower.indexOf(negativeKeywords[i]) !== -1) {\n";
      script += "    score -= 1;\n";
      script += "  }\n";
      script += "}\n\n";
    }

    // Update persistent score
    if (mode === 'persistent') {
      script += "// Update score tag\n";
      script += "if (scoreMatch) {\n";
      script += "  context.character.scenario = context.character.scenario.replace(/\\{\\{char_score:[-\\d]+\\}\\}/, '{{char_score:' + score + '}}');\n";
      script += "} else {\n";
      script += "  context.character.scenario += '\\n{{char_score:' + score + '}}';\n";
      script += "}\n\n";
    }

    // Thresholds
    if (hasThresholds) {
      thresholds.forEach(function(threshold) {
        var operator = threshold.querySelector('select').value;
        var value = parseInt(threshold.querySelector('input').value, 10);
        var response = threshold.querySelector('textarea').value.trim();

        if (!isNaN(value) && response) {
          script += "if (score " + operator + " " + value + ") {\n";
          script += "  context.character.personality += '\\n" + escapeForScript(response) + "';\n";
          script += "}\n";
        }
      });
    }

    if (debugMode) {
      script += "\ncontext.character.scenario += '\\n(debug: scoring module fired, score=' + score + ')';\n";
    }

    return script;
  }

  function generateScoringScript() {
    var script = buildScoringScript(true);
    document.getElementById('scoringOutput').textContent = script;
    updateTokenMeter();
  }

  // ===========================
  //   AMBIENT EVENTS
  // ===========================

  function addAmbientEvent() {
    var container = document.getElementById('ambientEvents');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.innerHTML = '<textarea placeholder="Ambient event description..." style="flex:1;"></textarea><button type="button" onclick="this.parentElement.remove()">Remove</button>';
    container.appendChild(item);
  }

  // Ambient builder function - accepts standalone parameter
  function buildAmbientScript(standalone) {
    var probability = parseInt(document.getElementById('ambientProbability').value, 10) || 10;
    var events = document.querySelectorAll('#ambientEvents .dynamic-item');
    var debugMode = document.getElementById('debugMode').checked;

    var eventList = [];
    events.forEach(function(event) {
      var content = event.querySelector('textarea').value.trim();
      if (content) {
        eventList.push(content);
      }
    });

    var script = "// ============================================\n";
    script += "// MODULE: AMBIENT EVENTS\n";
    script += "// ============================================\n\n";

    // Check for any valid configuration
    if (eventList.length === 0) {
      script += "// (No ambient events configured ‚Äî this module currently does nothing.)\n";
      return script;
    }

    // Only include initContext if standalone
    if (standalone) {
      script += "// Init function for standalone use\n";
      script += "function initContext() {\n";
      script += "  if (!context.character) context.character = {};\n";
      script += "  if (!context.character.personality) context.character.personality = \"\";\n";
      script += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
      script += "}\n";
      script += "initContext();\n\n";
    }

    script += "var ambientEvents = " + JSON.stringify(eventList, null, 2) + ";\n\n";

    script += "var probability = " + probability + ";\n";
    script += "var roll = Math.floor(Math.random() * 100) + 1;\n\n";

    script += "if (roll <= probability && ambientEvents.length > 0) {\n";
    script += "  var randomIndex = Math.floor(Math.random() * ambientEvents.length);\n";
    script += "  context.character.scenario += '\\n' + ambientEvents[randomIndex];\n";
    if (debugMode) {
      script += "  context.character.scenario += '\\n(debug: ambient event fired)';\n";
    }
    script += "}\n";

    return script;
  }

  function generateAmbientScript() {
    var script = buildAmbientScript(true);
    document.getElementById('ambientOutput').textContent = script;
    updateTokenMeter();
  }

  // ===========================
  //   RANDOM EVENTS
  // ===========================

  function addRandomEvent() {
    var container = document.getElementById('randomEvents');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.innerHTML = '<input type="text" placeholder="Trigger phrase" style="flex:1;" /><textarea placeholder="Responses (pipe-separated: option1|option2|option3)" style="flex:1;"></textarea><button type="button" onclick="this.parentElement.remove()">Remove</button>';
    container.appendChild(item);
  }

  // Random builder function - accepts standalone parameter
  function buildRandomScript(standalone) {
    var events = document.querySelectorAll('#randomEvents .dynamic-item');
    var debugMode = document.getElementById('debugMode').checked;

    var script = "// ============================================\n";
    script += "// MODULE: RANDOM EVENTS\n";
    script += "// ============================================\n\n";

    // Check for any valid configuration
    var hasEvents = false;
    events.forEach(function(event) {
      var trigger = event.querySelector('input').value.trim().toLowerCase();
      var responses = event.querySelector('textarea').value.split('|').map(function(r) { return r.trim(); }).filter(Boolean);
      if (trigger && responses.length > 0) {
        hasEvents = true;
      }
    });

    if (!hasEvents) {
      script += "// (No random events configured ‚Äî this module currently does nothing.)\n";
      return script;
    }

    // Only include initContext if standalone
    if (standalone) {
      script += "// Init function for standalone use\n";
      script += "function initContext() {\n";
      script += "  if (!context.character) context.character = {};\n";
      script += "  if (!context.character.personality) context.character.personality = \"\";\n";
      script += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
      script += "}\n";
      script += "initContext();\n\n";
    }

    // Get message safely
    script += "// Get last user message safely\n";
    script += "var message = (context.chat && context.chat.last_message) ? context.chat.last_message : \"\";\n";
    script += "var msgLower = message.toLowerCase();\n";
    script += "var randomFired = false;\n\n";

    events.forEach(function(event) {
      var trigger = event.querySelector('input').value.trim().toLowerCase();
      var responses = event.querySelector('textarea').value.split('|').map(function(r) { return r.trim(); }).filter(Boolean);

      if (trigger && responses.length > 0) {
        script += "// Random Event: " + trigger + "\n";
        script += "if (msgLower.indexOf('" + escapeForScript(trigger) + "') !== -1) {\n";
        script += "  var responses = " + JSON.stringify(responses) + ";\n";
        script += "  var randomResponse = responses[Math.floor(Math.random() * responses.length)];\n";
        script += "  context.character.personality += '\\n' + randomResponse;\n";
        script += "  randomFired = true;\n";
        script += "}\n\n";
      }
    });

    if (debugMode) {
      script += "if (randomFired) {\n";
      script += "  context.character.scenario += '\\n(debug: random event fired)';\n";
      script += "}\n";
    }

    return script;
  }

  function generateRandomScript() {
    var script = buildRandomScript(true);
    document.getElementById('randomOutput').textContent = script;
    updateTokenMeter();
  }

  // ===========================
  //   COMBINED CONDITIONS
  // ===========================

  function addCombinedRule() {
    var container = document.getElementById('combinedRules');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.innerHTML = '<input type="text" placeholder="Keywords (comma-separated)" style="flex:1;" /><input type="number" placeholder="Min hour" min="0" max="23" style="width:80px;" /><input type="number" placeholder="Max hour" min="0" max="23" style="width:80px;" /><input type="number" placeholder="Min messages" min="1" style="width:100px;" /><textarea placeholder="Result when all conditions met..." style="flex:1;"></textarea><button type="button" onclick="this.parentElement.remove()">Remove</button>';
    container.appendChild(item);
  }

  // Combined Conditions builder function - accepts standalone parameter
  function buildCombinedConditionsScript(standalone) {
    var rules = document.querySelectorAll('#combinedRules .dynamic-item');
    var debugMode = document.getElementById('debugMode').checked;
    var offset = parseInt(document.getElementById('timeOffset').value, 10) || 0;

    var script = "// ============================================\n";
    script += "// MODULE: COMBINED CONDITIONS\n";
    script += "// ============================================\n\n";

    // Check for any valid configuration
    var hasRules = false;
    rules.forEach(function(rule) {
      var keywords = rule.querySelector('input').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
      var result = rule.querySelector('textarea').value.trim();
      if (keywords.length > 0 && result) {
        hasRules = true;
      }
    });

    if (!hasRules) {
      script += "// (No combined condition rules configured ‚Äî this module currently does nothing.)\n";
      return script;
    }

    // Only include initContext if standalone
    if (standalone) {
      script += "// Init function for standalone use\n";
      script += "function initContext() {\n";
      script += "  if (!context.character) context.character = {};\n";
      script += "  if (!context.character.personality) context.character.personality = \"\";\n";
      script += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
      script += "}\n";
      script += "initContext();\n\n";

      // Add message_count alias for standalone mode
      script += "// Safe message counter alias for combined conditions\n";
      script += "var message_count = (context.chat && typeof context.chat.message_count === 'number')\n";
      script += "  ? context.chat.message_count\n";
      script += "  : 0;\n\n";
    }

    // Add hourInRange for wrap-around support
    script += generateHourInRangeFunction();

    // Get message safely
    script += "// Get last user message safely\n";
    script += "var message = (context.chat && context.chat.last_message) ? context.chat.last_message : \"\";\n";
    script += "var msgLower = message.toLowerCase();\n";
    script += "var count = message_count;\n";
    script += "var offset = " + offset + ";\n";
    script += "var hour = (new Date().getHours() + offset + 24) % 24;\n";
    script += "var combinedFired = false;\n\n";

    rules.forEach(function(rule, index) {
      var keywords = rule.querySelector('input').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
      var inputs = rule.querySelectorAll('input[type="number"]');
      var minHour = parseInt(inputs[0].value, 10);
      var maxHour = parseInt(inputs[1].value, 10);
      var minMessages = parseInt(inputs[2].value, 10);
      var result = rule.querySelector('textarea').value.trim();

      if (keywords.length > 0 && result) {
        script += "// Combined Rule " + (index + 1) + "\n";
        script += "var keywordMatch" + index + " = false;\n";
        keywords.forEach(function(keyword) {
          script += "if (msgLower.indexOf('" + escapeForScript(keyword) + "') !== -1) keywordMatch" + index + " = true;\n";
        });

        script += "if (keywordMatch" + index;

        if (!isNaN(minHour) && !isNaN(maxHour)) {
          script += " && hourInRange(hour, " + minHour + ", " + maxHour + ")";
        }

        if (!isNaN(minMessages)) {
          script += " && count >= " + minMessages;
        }

        script += ") {\n";
        script += "  context.character.scenario += '\\n" + escapeForScript(result) + "';\n";
        script += "  combinedFired = true;\n";
        script += "}\n\n";
      }
    });

    if (debugMode) {
      script += "if (combinedFired) {\n";
      script += "  context.character.scenario += '\\n(debug: combined conditions fired)';\n";
      script += "}\n";
    }

    return script;
  }

  function generateCombinedConditionsScript() {
    var script = buildCombinedConditionsScript(true);
    document.getElementById('combinedOutput').textContent = script;
    updateTokenMeter();
  }

  // ===========================
  //   FINAL COMBINED SCRIPT
  // ===========================

  function generateFinalCombinedScript() {
    var order = [];
    var items = document.querySelectorAll('#moduleOrder .order-item');

    items.forEach(function(item) {
      var module = item.getAttribute('data-module');
      var checkbox = document.getElementById('toggle-' + module);
      if (checkbox && checkbox.checked) {
        order.push(module);
      }
    });

    if (order.length === 0) {
      showToast('No modules enabled! Please enable at least one module in the Module Control Panel.', 'warning');
      return;
    }

    var finalScript = "";
    finalScript += "// ============================================\n";
    finalScript += "// COMBINED SCRIPT - All Enabled Modules\n";
    finalScript += "// Generated by JanitorAI Script Builder v0.2.6\n";
    finalScript += "// ============================================\n\n";

    // Shared init function (only once for combined script)
    finalScript += "// Shared initialization function\n";
    finalScript += "function initContext() {\n";
    finalScript += "  if (!context.character) context.character = {};\n";
    finalScript += "  if (!context.character.personality) context.character.personality = \"\";\n";
    finalScript += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
    finalScript += "}\n\n";

    // Call it once at the start
    finalScript += "// Initialize context\n";
    finalScript += "initContext();\n\n";

    // Add message_count alias for modules that need it (pacing, combined)
    var needsMessageCount = order.includes('pacing') || order.includes('combined');
    if (needsMessageCount) {
      finalScript += "// Safe message counter alias for pacing/combined modules\n";
      finalScript += "var message_count = (context.chat && typeof context.chat.message_count === 'number')\n";
      finalScript += "  ? context.chat.message_count\n";
      finalScript += "  : 0;\n\n";
    }

    // Check if hourInRange is needed
    var needsHourInRange = order.includes('time') || order.includes('combined');
    if (needsHourInRange) {
      finalScript += generateHourInRangeFunction();
    }

    // Add each enabled module using builder functions with standalone=false
    var activeModuleCount = 0;
    order.forEach(function(module) {
      var moduleScript = '';

      // Call the appropriate builder function with standalone=false
      switch(module) {
        case 'memory':
          moduleScript = buildMemoryScript(false);
          break;
        case 'lorebook':
          moduleScript = buildLorebookScript(false);
          break;
        case 'time':
          moduleScript = buildTimeScript(false);
          break;
        case 'pacing':
          moduleScript = buildPacingScript(false);
          break;
        case 'tone':
          moduleScript = buildToneScript(false);
          break;
        case 'scoring':
          moduleScript = buildScoringScript(false);
          break;
        case 'ambient':
          moduleScript = buildAmbientScript(false);
          break;
        case 'random':
          moduleScript = buildRandomScript(false);
          break;
        case 'combined':
          moduleScript = buildCombinedConditionsScript(false);
          break;
      }

      // Remove module headers for cleaner combined output
      moduleScript = moduleScript.replace(/\/\/ =+\r?\n\/\/ MODULE:.*?\r?\n\/\/ =+\r?\n\r?\n/g, '');
      moduleScript = moduleScript.replace(/function hourInRange\(h, start, end\)[\s\S]*?\}\r?\n\r?\n/g, '');

      if (moduleScript.trim()) {
        finalScript += "// ========== " + module.toUpperCase() + " MODULE ==========\n";
        finalScript += moduleScript.trim() + "\n\n";
        activeModuleCount++;
      }
    });

    document.getElementById("finalOutput").textContent = finalScript;

    // Copy to clipboard (with robust fallback for non-HTTPS / mobile / WebViews)
    var successMsg = 'Complete script copied to clipboard! Total modules: ' + activeModuleCount;
    var fallbackMsg = 'Script generated! Scroll down to see the combined output. Total modules: ' + activeModuleCount;

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(finalScript).then(function () {
        showToast(successMsg, 'success');
      }, function () {
        // Clipboard API failed, try legacy method
        copyFinalScriptFallback(finalScript, successMsg, fallbackMsg);
      });
    } else {
      copyFinalScriptFallback(finalScript, successMsg, fallbackMsg);
    }

    updateTokenMeter();
  }

  // Robust fallback copy for final script (mobile, WebViews, non-HTTPS)
  function copyFinalScriptFallback(text, successMsg, fallbackMsg) {
    var textarea = document.createElement('textarea');
    textarea.value = text;

    // Prevent zooming on iOS
    textarea.style.fontSize = '16px';

    // Hide textarea while keeping it functional
    textarea.style.position = 'fixed';
    textarea.style.top = '0';
    textarea.style.left = '0';
    textarea.style.width = '2em';
    textarea.style.height = '2em';
    textarea.style.padding = '0';
    textarea.style.border = 'none';
    textarea.style.outline = 'none';
    textarea.style.boxShadow = 'none';
    textarea.style.background = 'transparent';
    textarea.style.opacity = '0';
    textarea.style.zIndex = '-1';

    // Prevent keyboard from appearing on mobile
    textarea.setAttribute('readonly', '');

    document.body.appendChild(textarea);

    // iOS-specific selection method
    if (navigator.userAgent.match(/ipad|ipod|iphone/i)) {
      textarea.contentEditable = true;
      textarea.readOnly = true;
      var range = document.createRange();
      range.selectNodeContents(textarea);
      var selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      textarea.setSelectionRange(0, 999999);
    } else {
      textarea.select();
    }

    var success = false;
    try {
      success = document.execCommand('copy');
    } catch (err) {
      success = false;
    }

    document.body.removeChild(textarea);

    if (success) {
      showToast(successMsg, 'success');
    } else {
      showToast(fallbackMsg, 'success');
    }
  }

  // ===========================
  //   TRIGGER ANALYZER
  // ===========================

  function analyzeTriggers() {
    var triggerMap = {}; // keyword -> [{module, context, action}]

    // Collect from Lorebook
    var loreEntries = document.querySelectorAll('#loreEntries .dynamic-item');
    loreEntries.forEach(function(entry) {
      var category = entry.querySelector('select').value;
      var keywords = entry.querySelector('input').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
      var content = entry.querySelector('textarea').value.trim();
      if (content) {
        keywords.forEach(function(kw) {
          if (!triggerMap[kw]) triggerMap[kw] = [];
          triggerMap[kw].push({
            module: 'Lorebook',
            context: category,
            action: 'Injects lore entry (' + content.substring(0, 40) + (content.length > 40 ? '...' : '') + ')'
          });
        });
      }
    });

    // Collect from Tone
    var toneTriggers = document.querySelectorAll('#toneTriggers .dynamic-item');
    toneTriggers.forEach(function(trigger) {
      var keywords = trigger.querySelector('input').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
      var content = trigger.querySelector('textarea').value.trim();
      if (content) {
        keywords.forEach(function(kw) {
          if (!triggerMap[kw]) triggerMap[kw] = [];
          triggerMap[kw].push({
            module: 'Tone',
            context: 'personality shift',
            action: 'Adds: ' + content.substring(0, 40) + (content.length > 40 ? '...' : '')
          });
        });
      }
    });

    // Collect from Scoring - Positive
    var positiveKeywords = document.getElementById('scoringPositive').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
    positiveKeywords.forEach(function(kw) {
      if (!triggerMap[kw]) triggerMap[kw] = [];
      triggerMap[kw].push({
        module: 'Scoring',
        context: 'positive',
        action: 'Adds +1 to score'
      });
    });

    // Collect from Scoring - Negative
    var negativeKeywords = document.getElementById('scoringNegative').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
    negativeKeywords.forEach(function(kw) {
      if (!triggerMap[kw]) triggerMap[kw] = [];
      triggerMap[kw].push({
        module: 'Scoring',
        context: 'negative',
        action: 'Subtracts -1 from score'
      });
    });

    // Collect from Memory - Facts
    var factsKeywords = document.getElementById('memFactsKeywords').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
    factsKeywords.forEach(function(kw) {
      if (!triggerMap[kw]) triggerMap[kw] = [];
      triggerMap[kw].push({
        module: 'Memory',
        context: 'facts detection',
        action: 'Triggers fact storage'
      });
    });

    // Collect from Memory - Likes
    var likesKeywords = document.getElementById('memLikesKeywords').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
    likesKeywords.forEach(function(kw) {
      if (!triggerMap[kw]) triggerMap[kw] = [];
      triggerMap[kw].push({
        module: 'Memory',
        context: 'likes detection',
        action: 'Triggers like storage'
      });
    });

    // Collect from Memory - Dislikes
    var dislikesKeywords = document.getElementById('memDislikesKeywords').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
    dislikesKeywords.forEach(function(kw) {
      if (!triggerMap[kw]) triggerMap[kw] = [];
      triggerMap[kw].push({
        module: 'Memory',
        context: 'dislikes detection',
        action: 'Triggers dislike storage'
      });
    });

    // Analyze the collected triggers
    var conflicts = [];      // Same keyword with opposing scoring effects
    var multiTriggers = [];  // Keywords that trigger multiple things
    var overlaps = [];       // Keywords that contain each other
    var allKeywords = Object.keys(triggerMap);

    // Check for multi-triggers and conflicts
    allKeywords.forEach(function(kw) {
      var usages = triggerMap[kw];
      if (usages.length > 1) {
        // Check for scoring conflicts (positive AND negative)
        var hasPositive = usages.some(function(u) { return u.module === 'Scoring' && u.context === 'positive'; });
        var hasNegative = usages.some(function(u) { return u.module === 'Scoring' && u.context === 'negative'; });
        if (hasPositive && hasNegative) {
          conflicts.push({ keyword: kw, usages: usages });
        } else {
          multiTriggers.push({ keyword: kw, usages: usages });
        }
      }
    });

    // Check for overlapping keywords (one contains another)
    for (var i = 0; i < allKeywords.length; i++) {
      for (var j = i + 1; j < allKeywords.length; j++) {
        var kw1 = allKeywords[i];
        var kw2 = allKeywords[j];
        // Check if one contains the other (but they're not equal)
        if (kw1 !== kw2) {
          if (kw1.indexOf(kw2) !== -1 || kw2.indexOf(kw1) !== -1) {
            overlaps.push({
              keywords: [kw1, kw2],
              note: kw1.length > kw2.length
                ? '"' + kw1 + '" contains "' + kw2 + '"'
                : '"' + kw2 + '" contains "' + kw1 + '"'
            });
          }
        }
      }
    }

    // Build results HTML
    var resultsHTML = '<div class="analyzer-results">';

    // Summary
    resultsHTML += '<div class="analyzer-summary">';
    resultsHTML += '<span class="analyzer-stat">Total keywords: <strong>' + allKeywords.length + '</strong></span>';
    resultsHTML += '<span class="analyzer-stat">Conflicts: <strong>' + conflicts.length + '</strong></span>';
    resultsHTML += '<span class="analyzer-stat">Multi-triggers: <strong>' + multiTriggers.length + '</strong></span>';
    resultsHTML += '<span class="analyzer-stat">Overlaps: <strong>' + overlaps.length + '</strong></span>';
    resultsHTML += '</div>';

    // Conflicts section
    if (conflicts.length > 0) {
      resultsHTML += '<div class="analyzer-section">';
      resultsHTML += '<h4>‚ö†Ô∏è Conflicts (Same keyword with opposing effects)</h4>';
      conflicts.forEach(function(item) {
        resultsHTML += '<div class="analyzer-item analyzer-conflict">';
        resultsHTML += '<div class="analyzer-keyword">"' + item.keyword + '"</div>';
        resultsHTML += '<div class="analyzer-usage">';
        item.usages.forEach(function(usage) {
          resultsHTML += '<div class="analyzer-usage-item">‚Üí ' + usage.module + ' (' + usage.context + '): ' + usage.action + '</div>';
        });
        resultsHTML += '</div></div>';
      });
      resultsHTML += '</div>';
    }

    // Multi-triggers section
    if (multiTriggers.length > 0) {
      resultsHTML += '<div class="analyzer-section">';
      resultsHTML += '<h4>üìã Multi-Triggers (Keywords that fire multiple things)</h4>';
      multiTriggers.forEach(function(item) {
        resultsHTML += '<div class="analyzer-item analyzer-warning">';
        resultsHTML += '<div class="analyzer-keyword">"' + item.keyword + '"</div>';
        resultsHTML += '<div class="analyzer-usage">';
        item.usages.forEach(function(usage) {
          resultsHTML += '<div class="analyzer-usage-item">‚Üí ' + usage.module + ' (' + usage.context + '): ' + usage.action + '</div>';
        });
        resultsHTML += '</div></div>';
      });
      resultsHTML += '</div>';
    }

    // Overlaps section
    if (overlaps.length > 0) {
      resultsHTML += '<div class="analyzer-section">';
      resultsHTML += '<h4>üîó Overlapping Keywords (May cause unintended matches without padded matching)</h4>';
      overlaps.forEach(function(item) {
        resultsHTML += '<div class="analyzer-item analyzer-warning">';
        resultsHTML += '<div class="analyzer-keyword">' + item.note + '</div>';
        resultsHTML += '</div>';
      });
      resultsHTML += '</div>';
    }

    // All clear message
    if (conflicts.length === 0 && multiTriggers.length === 0 && overlaps.length === 0) {
      if (allKeywords.length === 0) {
        resultsHTML += '<div class="analyzer-empty">No triggers configured yet. Add keywords to your modules to analyze them.</div>';
      } else {
        resultsHTML += '<div class="analyzer-item analyzer-ok">';
        resultsHTML += '<strong>‚úì All Clear!</strong> No conflicts or overlaps detected in your ' + allKeywords.length + ' keywords.';
        resultsHTML += '</div>';
      }
    }

    resultsHTML += '</div>';

    document.getElementById('analyzerResults').innerHTML = resultsHTML;
    showToast('Trigger analysis complete!', 'success');
  }

  // ===========================
  //   INITIALIZATION
  // ===========================

  document.addEventListener('DOMContentLoaded', function () {
    // Restore default toggles (prevents stale browser-cached states)
    document.getElementById('toggle-lorebook').checked = true;
    document.getElementById('toggle-memory').checked = true;
    document.getElementById('toggle-pacing').checked = true;
    document.getElementById('toggle-tone').checked = true;

    document.getElementById('toggle-time').checked = false;
    document.getElementById('toggle-ambient').checked = false;
    document.getElementById('toggle-random').checked = false;
    document.getElementById('toggle-combined').checked = false;
    document.getElementById('toggle-scoring').checked = false;

    // Ensure outputs start clean (helps with bfcache / reloads)
    var outputs = [
      'memoryOutput','lorebookOutput','timeOutput','pacingOutput','toneOutput',
      'scoringOutput','ambientOutput','randomOutput','combinedOutput','finalOutput'
    ];
    outputs.forEach(function (id) {
      document.getElementById(id).textContent = '// Script will appear here after clicking Generate';
    });

    // Add one default entry for each dynamic section
    addLoreEntry();
    addTimeSlot();
    addPacingPhase();
    addToneTrigger();
    addAmbientEvent();

    updateTokenMeter();
  });

  // ===========================
  //   SCRIPT TESTER FUNCTIONS
  // ===========================

  // Toggle message history visibility
  function toggleMessageHistory() {
    var checkbox = document.getElementById('testerMultiMessage');
    var section = document.getElementById('testerHistorySection');
    section.style.display = checkbox.checked ? 'block' : 'none';
  }

  // Get the script content from the selected source
  function getSelectedScript() {
    var source = document.getElementById('testerScriptSource').value;

    // Handle custom script option
    if (source === 'custom') {
      return document.getElementById('testerCustomScript').value || '';
    }

    var outputMap = {
      'final': 'finalOutput',
      'lorebook': 'lorebookOutput',
      'memory': 'memoryOutput',
      'pacing': 'pacingOutput',
      'tone': 'toneOutput',
      'time': 'timeOutput',
      'ambient': 'ambientOutput',
      'random': 'randomOutput',
      'combined': 'combinedOutput',
      'scoring': 'scoringOutput'
    };
    var outputId = outputMap[source];
    if (!outputId) return '';
    var el = document.getElementById(outputId);
    return el ? el.textContent : '';
  }

  // Clear test results
  function clearTestResults() {
    document.getElementById('testerResults').style.display = 'none';
    document.getElementById('testerConsoleOutput').textContent = '// Console logs will appear here';
    document.getElementById('testerPersonality').textContent = '(none)';
    document.getElementById('testerScenario').textContent = '(none)';
    document.getElementById('testerExamples').textContent = '(none)';
  }

  // Tester preset scripts
  var TESTER_PRESETS = {
    good: `// APHRODITE - DIVINE SLIP-UPS (Simplified Demo)
// A working script demonstrating keyword triggers and message count phases

var last = context.chat.last_message.toLowerCase();
var padded = " " + last + " ";
var count = context.chat.message_count;

// Relationship tier based on message count
var tier = "desperate";
if (count > 60) tier = "genuine";
else if (count > 40) tier = "vulnerable";
else if (count > 20) tier = "comfortable";

// Divine keyword detection
var mentionedGods = (padded.indexOf(" gods ") !== -1 || padded.indexOf(" divine ") !== -1 || padded.indexOf(" olympus ") !== -1);
var mentionedPowers = (padded.indexOf(" magic ") !== -1 || padded.indexOf(" powers ") !== -1 || padded.indexOf(" goddess ") !== -1);

// Technology failures
if (padded.indexOf(" phone ") !== -1 || padded.indexOf(" text ") !== -1) {
  var techFails = [
    " 'Why does it want to know my location?! I'm RIGHT HERE!'",
    " Her phone autocorrects everything wrong. 'It's possessed!'",
    " 'What do you mean low battery? I charged it three days ago!'"
  ];
  context.character.scenario += techFails[Math.floor(Math.random() * techFails.length)];
}

// Divine slip-ups when gods mentioned
if (mentionedGods) {
  context.character.scenario += " She glances around nervously. 'You didn't hear that part about‚Äî never mind.'";
}

// Power manifestation when happy
if (padded.indexOf(" happy ") !== -1 || padded.indexOf(" smile ") !== -1) {
  if (Math.random() < 0.5) {
    context.character.scenario += " Her hair floats slightly‚Äîshe's happy. 'It's static. Totally normal.'";
  }
}

// Food discovery
if (padded.indexOf(" food ") !== -1 || padded.indexOf(" eat ") !== -1 || padded.indexOf(" croissant ") !== -1) {
  context.character.scenario += " 'Why didn't anyone tell me about croissants?!' Crumbs on her face.";
}

// Relationship personality injection
context.character.personality += " [Relationship: " + tier + "] ";
if (tier === "desperate") {
  context.character.personality += "Trying too hard, nervous energy, desperately attempting to seem normal.";
} else if (tier === "genuine") {
  context.character.personality += "Stopped pretending, real feelings evident, comfortable being herself.";
}

console.log("Script executed successfully!");
console.log("Tier: " + tier + ", Count: " + count);
console.log("Gods mentioned: " + mentionedGods + ", Powers: " + mentionedPowers);`,

    broken: `// BROKEN SCRIPT - Intentional Errors for Testing
// This script contains syntax and runtime errors

var last = context.chat.last_message.toLowerCase();
var padded = " " + last + " ";

console.log("Starting broken script...");

// ERROR 1: Missing closing parenthesis
if (padded.indexOf("test") !== -1 {
  context.character.scenario += "This will never run";
}

// ERROR 2: Undefined variable access
var result = undefinedVariable.someMethod();

// ERROR 3: Invalid syntax - unclosed string
context.character.personality += "This string never ends...

// This line will never be reached
console.log("Script completed!");`,

    mega: `// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//        MEGA TEST SCRIPT - ALL MODULES COMBINED
//        Tests: Lorebook, Memory, Pacing, Tone, Time,
//               Ambient, Random, Combined, Scoring
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

var last = context.chat.last_message.toLowerCase();
var padded = " " + last + " ";
var count = context.chat.message_count;
var triggeredModules = [];

console.log("‚ïê‚ïê‚ïê MEGA TEST SCRIPT STARTING ‚ïê‚ïê‚ïê");
console.log("Message: " + last.substring(0, 50) + "...");
console.log("Message Count: " + count);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MODULE 1: LOREBOOK (Keyword Database)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
console.log("\\n[LOREBOOK] Checking keywords...");

// People
if (padded.indexOf(" marcus ") !== -1) {
  context.character.scenario += "\\n[LORE-PERSON] Marcus the blacksmith stands at his forge, muscles gleaming with sweat. He nods in greeting.";
  triggeredModules.push("Lorebook:People:Marcus");
  console.log("  ‚úì Triggered: Marcus (person)");
}

// Places
if (padded.indexOf(" tavern ") !== -1) {
  context.character.scenario += "\\n[LORE-PLACE] The Rusty Tankard tavern is warm and inviting, filled with the smell of ale and roasting meat.";
  triggeredModules.push("Lorebook:Places:Tavern");
  console.log("  ‚úì Triggered: Tavern (place)");
}

// Objects
if (padded.indexOf(" sword ") !== -1 || padded.indexOf(" blade ") !== -1) {
  context.character.scenario += "\\n[LORE-OBJECT] The ancient sword hums with magical energy, its runes glowing faintly blue.";
  triggeredModules.push("Lorebook:Objects:Sword");
  console.log("  ‚úì Triggered: Sword (object)");
}

// Moods
if (padded.indexOf(" danger ") !== -1 || padded.indexOf(" threat ") !== -1) {
  context.character.scenario += "\\n[LORE-MOOD] A sense of danger permeates the air. Something is watching from the shadows.";
  triggeredModules.push("Lorebook:Moods:Danger");
  console.log("  ‚úì Triggered: Danger (mood)");
}

// Events
if (padded.indexOf(" festival ") !== -1 || padded.indexOf(" celebration ") !== -1) {
  context.character.scenario += "\\n[LORE-EVENT] The annual harvest festival is in full swing! Colorful banners and music fill the streets.";
  triggeredModules.push("Lorebook:Events:Festival");
  console.log("  ‚úì Triggered: Festival (event)");
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MODULE 2: MEMORY SYSTEM
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
console.log("\\n[MEMORY] Checking for memorable info...");

// Name detection
var nameMatch = last.match(/my name is ([a-z'\\-]+)/i);
if (nameMatch) {
  var detectedName = nameMatch[1];
  context.character.personality += "\\n[MEMORY-NAME] User's name is " + detectedName + ".";
  triggeredModules.push("Memory:Name:" + detectedName);
  console.log("  ‚úì Detected name: " + detectedName);
}

// Facts
if (padded.indexOf(" i am ") !== -1 || padded.indexOf(" i work ") !== -1) {
  context.character.personality += "\\n[MEMORY-FACT] User shared a fact about themselves.";
  triggeredModules.push("Memory:Fact");
  console.log("  ‚úì Detected: Personal fact");
}

// Likes
if (padded.indexOf(" i like ") !== -1 || padded.indexOf(" i love ") !== -1 || padded.indexOf(" i enjoy ") !== -1) {
  context.character.personality += "\\n[MEMORY-LIKE] User expressed something they like.";
  triggeredModules.push("Memory:Like");
  console.log("  ‚úì Detected: User likes something");
}

// Dislikes
if (padded.indexOf(" i hate ") !== -1 || padded.indexOf(" i dislike ") !== -1 || padded.indexOf(" i don't like ") !== -1) {
  context.character.personality += "\\n[MEMORY-DISLIKE] User expressed something they dislike.";
  triggeredModules.push("Memory:Dislike");
  console.log("  ‚úì Detected: User dislikes something");
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MODULE 3: PACING SYSTEM (Message Count Phases)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
console.log("\\n[PACING] Determining conversation phase...");

var pacingPhase = "introduction";
if (count > 50) pacingPhase = "climax";
else if (count > 30) pacingPhase = "development";
else if (count > 10) pacingPhase = "rising";

context.character.personality += "\\n[PACING] Current phase: " + pacingPhase.toUpperCase();
triggeredModules.push("Pacing:" + pacingPhase);
console.log("  ‚úì Phase: " + pacingPhase + " (count: " + count + ")");

if (pacingPhase === "introduction") {
  context.character.scenario += "\\n[PACING] The story is just beginning. Characters are being established.";
} else if (pacingPhase === "rising") {
  context.character.scenario += "\\n[PACING] Tension builds. The plot thickens with each exchange.";
} else if (pacingPhase === "development") {
  context.character.scenario += "\\n[PACING] Deep into the narrative. Relationships and conflicts are complex.";
} else if (pacingPhase === "climax") {
  context.character.scenario += "\\n[PACING] The story reaches its peak intensity!";
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MODULE 4: TONE/STATE DETECTION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
console.log("\\n[TONE] Analyzing emotional tone...");

// Romantic tone
if (padded.indexOf(" love ") !== -1 || padded.indexOf(" kiss ") !== -1 || padded.indexOf(" heart ") !== -1) {
  context.character.personality += "\\n[TONE-ROMANTIC] Romantic undertones detected. Respond with warmth and affection.";
  triggeredModules.push("Tone:Romantic");
  console.log("  ‚úì Tone: Romantic");
}

// Tense tone
if (padded.indexOf(" fight ") !== -1 || padded.indexOf(" attack ") !== -1 || padded.indexOf(" battle ") !== -1) {
  context.character.personality += "\\n[TONE-TENSE] Combat/conflict detected. Increase tension and urgency.";
  triggeredModules.push("Tone:Tense");
  console.log("  ‚úì Tone: Tense/Combat");
}

// Sad tone
if (padded.indexOf(" sad ") !== -1 || padded.indexOf(" cry ") !== -1 || padded.indexOf(" tears ") !== -1) {
  context.character.personality += "\\n[TONE-SAD] Sadness detected. Respond with empathy and gentleness.";
  triggeredModules.push("Tone:Sad");
  console.log("  ‚úì Tone: Sad");
}

// Happy tone
if (padded.indexOf(" happy ") !== -1 || padded.indexOf(" joy ") !== -1 || padded.indexOf(" laugh ") !== -1) {
  context.character.personality += "\\n[TONE-HAPPY] Happiness detected. Match the upbeat energy!";
  triggeredModules.push("Tone:Happy");
  console.log("  ‚úì Tone: Happy");
}

// Mysterious tone
if (padded.indexOf(" secret ") !== -1 || padded.indexOf(" mystery ") !== -1 || padded.indexOf(" hidden ") !== -1) {
  context.character.personality += "\\n[TONE-MYSTERIOUS] Mystery detected. Add intrigue and suspense.";
  triggeredModules.push("Tone:Mysterious");
  console.log("  ‚úì Tone: Mysterious");
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MODULE 5: TIME & ENVIRONMENT (Simulated)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
console.log("\\n[TIME] Checking time-related keywords...");

if (padded.indexOf(" morning ") !== -1 || padded.indexOf(" sunrise ") !== -1 || padded.indexOf(" dawn ") !== -1) {
  context.character.scenario += "\\n[TIME-MORNING] Golden morning light streams through the windows. Birds sing outside.";
  triggeredModules.push("Time:Morning");
  console.log("  ‚úì Time: Morning");
}

if (padded.indexOf(" night ") !== -1 || padded.indexOf(" dark ") !== -1 || padded.indexOf(" moon ") !== -1) {
  context.character.scenario += "\\n[TIME-NIGHT] Darkness blankets the land. Stars twinkle overhead and shadows dance.";
  triggeredModules.push("Time:Night");
  console.log("  ‚úì Time: Night");
}

if (padded.indexOf(" rain ") !== -1 || padded.indexOf(" storm ") !== -1) {
  context.character.scenario += "\\n[TIME-WEATHER] Rain patters against the windows. Thunder rumbles in the distance.";
  triggeredModules.push("Time:Rain");
  console.log("  ‚úì Weather: Rain/Storm");
}

if (padded.indexOf(" forest ") !== -1 || padded.indexOf(" woods ") !== -1) {
  context.character.scenario += "\\n[TIME-ENVIRONMENT] The ancient forest looms around you, filled with whispers and mystery.";
  triggeredModules.push("Time:Forest");
  console.log("  ‚úì Environment: Forest");
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MODULE 6: AMBIENT EVENTS (Random flavor)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
console.log("\\n[AMBIENT] Rolling for ambient events...");

// Always trigger one ambient event for testing
var ambientRoll = Math.random();
var ambientEvents = [
  "A crow caws in the distance, breaking the silence.",
  "The wind picks up briefly, rustling nearby leaves.",
  "Somewhere, a door creaks open on rusty hinges.",
  "The faint smell of woodsmoke drifts on the air.",
  "A cat watches from a windowsill with knowing eyes."
];
var ambientPick = ambientEvents[Math.floor(Math.random() * ambientEvents.length)];
context.character.scenario += "\\n[AMBIENT] " + ambientPick;
triggeredModules.push("Ambient:Random");
console.log("  ‚úì Ambient event: " + ambientPick.substring(0, 30) + "...");

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MODULE 7: RANDOM EVENTS (Chance-based)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
console.log("\\n[RANDOM] Rolling for random events...");

// 50% chance events for testing
if (Math.random() < 0.5) {
  context.character.scenario += "\\n[RANDOM-50%] A stranger passes by, glancing curiously in your direction.";
  triggeredModules.push("Random:Stranger");
  console.log("  ‚úì Random event triggered (50% roll succeeded)");
} else {
  console.log("  ‚úó Random event skipped (50% roll failed)");
}

// Keyword + chance combo
if (padded.indexOf(" magic ") !== -1 && Math.random() < 0.7) {
  context.character.scenario += "\\n[RANDOM-MAGIC] A spark of wild magic flickers nearby‚Äîsomething reacts to the arcane mention!";
  triggeredModules.push("Random:MagicSpark");
  console.log("  ‚úì Magic + chance event triggered");
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MODULE 8: COMBINED CONDITIONS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
console.log("\\n[COMBINED] Checking multi-condition triggers...");

// Night + Danger = Spooky combo
if ((padded.indexOf(" night ") !== -1 || padded.indexOf(" dark ") !== -1) &&
    (padded.indexOf(" danger ") !== -1 || padded.indexOf(" threat ") !== -1)) {
  context.character.scenario += "\\n[COMBINED] Night + Danger: The darkness itself seems alive with menace. Every shadow could hide a threat.";
  triggeredModules.push("Combined:NightDanger");
  console.log("  ‚úì Combined: Night + Danger = Spooky atmosphere");
}

// Love + Sad = Bittersweet
if ((padded.indexOf(" love ") !== -1) && (padded.indexOf(" sad ") !== -1 || padded.indexOf(" tears ") !== -1)) {
  context.character.scenario += "\\n[COMBINED] Love + Sadness: A bittersweet moment. Love and loss intertwine.";
  triggeredModules.push("Combined:Bittersweet");
  console.log("  ‚úì Combined: Love + Sad = Bittersweet moment");
}

// Tavern + Festival = Party!
if (padded.indexOf(" tavern ") !== -1 && padded.indexOf(" festival ") !== -1) {
  context.character.scenario += "\\n[COMBINED] Tavern + Festival: The tavern is PACKED! Music, dancing, and free-flowing drinks everywhere!";
  triggeredModules.push("Combined:TavernParty");
  console.log("  ‚úì Combined: Tavern + Festival = Party time!");
}

// Magic + Sword = Enchanted weapon
if ((padded.indexOf(" magic ") !== -1) && (padded.indexOf(" sword ") !== -1 || padded.indexOf(" blade ") !== -1)) {
  context.character.scenario += "\\n[COMBINED] Magic + Sword: The blade resonates with magical energy, humming with ancient power!";
  triggeredModules.push("Combined:EnchantedBlade");
  console.log("  ‚úì Combined: Magic + Sword = Enchanted weapon");
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MODULE 9: SCORING SYSTEM (Sentiment)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
console.log("\\n[SCORING] Calculating sentiment score...");

var sentimentScore = 0;

// Positive words
var positiveWords = [" love ", " happy ", " joy ", " good ", " great ", " wonderful ", " amazing ", " like "];
for (var i = 0; i < positiveWords.length; i++) {
  if (padded.indexOf(positiveWords[i]) !== -1) {
    sentimentScore += 10;
    console.log("  + Positive word found: " + positiveWords[i].trim());
  }
}

// Negative words
var negativeWords = [" hate ", " sad ", " angry ", " bad ", " terrible ", " awful ", " dislike "];
for (var j = 0; j < negativeWords.length; j++) {
  if (padded.indexOf(negativeWords[j]) !== -1) {
    sentimentScore -= 10;
    console.log("  - Negative word found: " + negativeWords[j].trim());
  }
}

var sentimentLabel = "neutral";
if (sentimentScore >= 20) sentimentLabel = "very positive";
else if (sentimentScore > 0) sentimentLabel = "positive";
else if (sentimentScore <= -20) sentimentLabel = "very negative";
else if (sentimentScore < 0) sentimentLabel = "negative";

context.character.personality += "\\n[SCORING] Sentiment: " + sentimentLabel + " (score: " + sentimentScore + ")";
triggeredModules.push("Scoring:" + sentimentLabel);
console.log("  ‚úì Final sentiment: " + sentimentLabel + " (" + sentimentScore + " points)");

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FINAL SUMMARY
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
console.log("\\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
console.log("MODULES TRIGGERED: " + triggeredModules.length);
triggeredModules.forEach(function(mod) {
  console.log("  ‚Ä¢ " + mod);
});
console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");

context.character.example_dialogues += "\\n[TEST SUMMARY] Triggered " + triggeredModules.length + " module responses: " + triggeredModules.join(", ");`
  };

  // Load a tester preset
  function loadTesterPreset(presetName) {
    var script = TESTER_PRESETS[presetName];
    if (script) {
      document.getElementById('testerCustomScript').value = script;
      clearTestResults();

      // Also set a relevant test message
      if (presetName === 'good') {
        document.getElementById('testerMessage').value = "I'm so happy! Let me check my phone real quick.";
        showToast('Loaded working Aphrodite demo script', 'success');
      } else if (presetName === 'broken') {
        document.getElementById('testerMessage').value = "test message";
        showToast('Loaded broken script for error testing', 'warning');
      } else if (presetName === 'mega') {
        // MEGA test message designed to trigger ALL modules
        document.getElementById('testerMessage').value = "My name is Alex and I am a traveler who works as a mage. I love magic and I like adventure but I hate danger and I dislike waiting. I walk into the tavern during the festival on this dark night. Marcus hands me a magic sword blade as rain starts to fall. I feel happy and sad with tears of joy, thinking of love and mystery. There's a secret hidden in the forest woods. Let's fight this battle! It's going to be great and wonderful but also terrible and bad.";
        showToast('Loaded MEGA test - triggers all 9 module types!', 'success');
      }
    }
  }

  // Build message history array for multi-message testing
  function buildMessageHistory(historyText, currentMessage) {
    var messages = [];
    if (historyText && historyText.trim()) {
      var lines = historyText.split('\n').filter(function(line) {
        return line.trim() !== '';
      });
      lines.forEach(function(line, idx) {
        messages.push({
          message: line.trim(),
          isUser: idx % 2 === 0  // Alternate user/bot
        });
      });
    }
    // Add current message as the latest (always user)
    if (currentMessage && currentMessage.trim()) {
      messages.push({
        message: currentMessage.trim(),
        isUser: true
      });
    }
    return messages;
  }

  // Run the script test
  function runScriptTest() {
    var scriptCode = getSelectedScript();
    var testMessage = document.getElementById('testerMessage').value || '';
    var charName = document.getElementById('testerCharName').value || '';
    var useMultiMessage = document.getElementById('testerMultiMessage').checked;
    var historyText = document.getElementById('testerHistory').value || '';

    // Validate
    if (!scriptCode || scriptCode.indexOf('// Script will appear') === 0) {
      showToast('Please generate a script first before testing', 'error');
      return;
    }
    if (!testMessage.trim()) {
      showToast('Please enter a test message', 'error');
      return;
    }

    // Build context similar to JanitorAI
    var lastMessages = useMultiMessage ? buildMessageHistory(historyText, testMessage) : [];

    var context = {
      chat: {
        last_message: testMessage,
        last_messages: lastMessages,
        message_count: useMultiMessage ? lastMessages.length : 1,
        multi_depth_enabled: useMultiMessage
      },
      character: {
        name: charName,
        personality: '',
        scenario: '',
        example_dialogues: ''
      }
    };

    // Capture console output
    var consoleLogs = [];
    var mockConsole = {
      log: function() {
        var args = Array.prototype.slice.call(arguments);
        consoleLogs.push(args.map(String).join(' '));
      },
      error: function() {
        var args = Array.prototype.slice.call(arguments);
        consoleLogs.push('[ERROR] ' + args.map(String).join(' '));
      },
      warn: function() {
        var args = Array.prototype.slice.call(arguments);
        consoleLogs.push('[WARN] ' + args.map(String).join(' '));
      },
      info: function() {
        var args = Array.prototype.slice.call(arguments);
        consoleLogs.push('[INFO] ' + args.map(String).join(' '));
      }
    };

    // Execute the script in a sandboxed way
    var errorOccurred = false;
    var errorMessage = '';

    try {
      // Create a function that has access to context and mock console
      var wrappedCode = '(function(context, console, Math) {\n' + scriptCode + '\n})';
      var scriptFn = eval(wrappedCode);
      scriptFn(context, mockConsole, Math);
    } catch (e) {
      errorOccurred = true;
      errorMessage = e.toString();
      consoleLogs.push('[EXECUTION ERROR] ' + errorMessage);
    }

    // Display results
    document.getElementById('testerResults').style.display = 'block';

    // Console output
    var consoleEl = document.getElementById('testerConsoleOutput');
    if (consoleLogs.length > 0) {
      consoleEl.textContent = consoleLogs.join('\n');
      consoleEl.className = 'output-box' + (errorOccurred ? ' tester-error' : ' tester-success');
    } else {
      consoleEl.textContent = '(no console output)';
      consoleEl.className = 'output-box';
    }

    // Personality
    var personalityEl = document.getElementById('testerPersonality');
    if (context.character.personality) {
      personalityEl.textContent = context.character.personality;
      personalityEl.className = 'output-box tester-success';
    } else {
      personalityEl.textContent = '(no changes)';
      personalityEl.className = 'output-box';
    }

    // Scenario
    var scenarioEl = document.getElementById('testerScenario');
    if (context.character.scenario) {
      scenarioEl.textContent = context.character.scenario;
      scenarioEl.className = 'output-box tester-success';
    } else {
      scenarioEl.textContent = '(no changes)';
      scenarioEl.className = 'output-box';
    }

    // Example dialogues
    var examplesEl = document.getElementById('testerExamples');
    if (context.character.example_dialogues) {
      examplesEl.textContent = context.character.example_dialogues;
      examplesEl.className = 'output-box tester-success';
    } else {
      examplesEl.textContent = '(no changes)';
      examplesEl.className = 'output-box';
    }

    // Show success/error toast
    if (errorOccurred) {
      showToast('Script error: ' + errorMessage, 'error');
    } else {
      var changes = [];
      if (context.character.personality) changes.push('personality');
      if (context.character.scenario) changes.push('scenario');
      if (context.character.example_dialogues) changes.push('examples');

      if (changes.length > 0) {
        showToast('Test complete! Modified: ' + changes.join(', '), 'success');
      } else {
        showToast('Test complete - no triggers matched', 'warning');
      }
    }
  }

  // Update UI when script source changes
  function updateTesterScript() {
    var source = document.getElementById('testerScriptSource').value;
    var customSection = document.getElementById('testerCustomSection');

    // Show/hide custom script section
    if (source === 'custom') {
      customSection.style.display = 'block';
    } else {
      customSection.style.display = 'none';
    }

    clearTestResults();
  }

  // ===========================
  //   BATCH TESTING FUNCTIONS
  // ===========================

  // Toggle batch mode UI
  function toggleBatchMode() {
    var batchMode = document.getElementById('testerBatchMode').checked;
    var singleMode = document.getElementById('testerSingleMode');
    var batchSection = document.getElementById('testerBatchSection');
    var singleButtons = document.getElementById('singleTestButtons');
    var batchButtons = document.getElementById('batchTestButtons');

    if (batchMode) {
      singleMode.style.display = 'none';
      batchSection.style.display = 'block';
      singleButtons.style.display = 'none';
      batchButtons.style.display = 'block';
      // Add initial message box if empty
      if (document.getElementById('batchTestMessages').children.length === 0) {
        addBatchTestMessage();
      }
    } else {
      singleMode.style.display = 'block';
      batchSection.style.display = 'none';
      singleButtons.style.display = 'block';
      batchButtons.style.display = 'none';
    }

    // Clear results when switching modes
    clearTestResults();
    clearBatchResults();
  }

  // Add a new batch test message input
  var batchMessageCounter = 0;
  function addBatchTestMessage(prefillText) {
    batchMessageCounter++;
    var container = document.getElementById('batchTestMessages');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.style.flexDirection = 'column';
    item.style.alignItems = 'stretch';
    item.innerHTML =
      '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">' +
        '<span style="font-weight: 600; color: var(--accent);">Message #' + batchMessageCounter + '</span>' +
        '<button type="button" onclick="this.parentElement.parentElement.remove()" style="padding: 4px 8px; background: var(--danger); color: var(--text-primary); border: none; border-radius: 3px; cursor: pointer; font-size: 0.8rem;">Remove</button>' +
      '</div>' +
      '<textarea class="batch-message-input" rows="2" placeholder="Enter test message..." style="width: 100%; font-family: inherit; resize: vertical;"></textarea>';
    container.appendChild(item);

    // Prefill if text provided
    if (prefillText) {
      item.querySelector('textarea').value = prefillText;
    }

    return item;
  }

  // Clear all batch messages
  function clearBatchMessages() {
    document.getElementById('batchTestMessages').innerHTML = '';
    batchMessageCounter = 0;
    addBatchTestMessage(); // Add one empty one
  }

  // Clear batch results
  function clearBatchResults() {
    document.getElementById('batchResults').style.display = 'none';
    document.getElementById('batchResultsSummary').innerHTML = '';
    document.getElementById('batchResultsList').innerHTML = '';
  }

  // Execute a single test and return results (refactored for reuse)
  function executeScriptTest(scriptCode, testMessage, charName) {
    var context = {
      chat: {
        last_message: testMessage,
        last_messages: [],
        message_count: 1,
        multi_depth_enabled: false
      },
      character: {
        name: charName || '',
        personality: '',
        scenario: '',
        example_dialogues: ''
      }
    };

    var consoleLogs = [];
    var mockConsole = {
      log: function() {
        var args = Array.prototype.slice.call(arguments);
        consoleLogs.push(args.map(String).join(' '));
      },
      error: function() {
        var args = Array.prototype.slice.call(arguments);
        consoleLogs.push('[ERROR] ' + args.map(String).join(' '));
      },
      warn: function() {
        var args = Array.prototype.slice.call(arguments);
        consoleLogs.push('[WARN] ' + args.map(String).join(' '));
      },
      info: function() {
        var args = Array.prototype.slice.call(arguments);
        consoleLogs.push('[INFO] ' + args.map(String).join(' '));
      }
    };

    var errorOccurred = false;
    var errorMessage = '';

    try {
      var wrappedCode = '(function(context, console, Math) {\n' + scriptCode + '\n})';
      var scriptFn = eval(wrappedCode);
      scriptFn(context, mockConsole, Math);
    } catch (e) {
      errorOccurred = true;
      errorMessage = e.toString();
      consoleLogs.push('[EXECUTION ERROR] ' + errorMessage);
    }

    return {
      message: testMessage,
      consoleLogs: consoleLogs,
      personality: context.character.personality,
      scenario: context.character.scenario,
      examples: context.character.example_dialogues,
      error: errorOccurred,
      errorMessage: errorMessage,
      hasChanges: !!(context.character.personality || context.character.scenario || context.character.example_dialogues)
    };
  }

  // Run all batch tests
  function runBatchTests() {
    var scriptCode = getSelectedScript();
    var charName = document.getElementById('testerCharName').value || '';

    // Validate script
    if (!scriptCode || scriptCode.indexOf('// Script will appear') === 0) {
      showToast('Please generate or paste a script first', 'error');
      return;
    }

    // Get all messages
    var messageInputs = document.querySelectorAll('#batchTestMessages .batch-message-input');
    var messages = [];
    messageInputs.forEach(function(input) {
      var msg = input.value.trim();
      if (msg) messages.push(msg);
    });

    if (messages.length === 0) {
      showToast('Please add at least one test message', 'error');
      return;
    }

    // Run all tests
    var results = [];
    var successCount = 0;
    var noTriggerCount = 0;
    var errorCount = 0;

    messages.forEach(function(msg, idx) {
      var result = executeScriptTest(scriptCode, msg, charName);
      result.index = idx + 1;
      results.push(result);

      if (result.error) {
        errorCount++;
      } else if (result.hasChanges) {
        successCount++;
      } else {
        noTriggerCount++;
      }
    });

    // Display results
    displayBatchResults(results, successCount, noTriggerCount, errorCount);
  }

  // Display batch test results
  function displayBatchResults(results, successCount, noTriggerCount, errorCount) {
    var container = document.getElementById('batchResults');
    var summary = document.getElementById('batchResultsSummary');
    var list = document.getElementById('batchResultsList');

    // Summary
    summary.innerHTML =
      '<strong>Batch Test Complete:</strong> ' + results.length + ' messages tested ‚Äî ' +
      '<span style="color: var(--success);">' + successCount + ' triggered</span>, ' +
      '<span style="color: var(--text-muted);">' + noTriggerCount + ' no triggers</span>, ' +
      '<span style="color: var(--danger);">' + errorCount + ' errors</span>';

    // Individual results
    list.innerHTML = '';
    results.forEach(function(result) {
      var statusClass = result.error ? 'error' : (result.hasChanges ? 'success' : 'no-trigger');
      var statusText = result.error ? '‚ùå Error' : (result.hasChanges ? '‚úÖ Triggered' : '‚ö™ No Trigger');

      var item = document.createElement('div');
      item.className = 'batch-result-item ' + statusClass;
      item.innerHTML =
        '<div class="batch-result-header" onclick="this.nextElementSibling.nextElementSibling.classList.toggle(\'expanded\')">' +
          '<span class="batch-result-number">Test #' + result.index + '</span>' +
          '<span class="batch-result-status">' + statusText + ' (click to expand)</span>' +
        '</div>' +
        '<div class="batch-result-message">"' + escapeHtml(result.message.substring(0, 150)) + (result.message.length > 150 ? '...' : '') + '"</div>' +
        '<div class="batch-result-details">' +
          '<div class="batch-result-detail">' +
            '<strong>Console Output:</strong>' +
            '<div class="output-box">' + (result.consoleLogs.length > 0 ? escapeHtml(result.consoleLogs.join('\n')) : '(none)') + '</div>' +
          '</div>' +
          '<div class="batch-result-detail">' +
            '<strong>Personality:</strong>' +
            '<div class="output-box">' + (result.personality ? escapeHtml(result.personality) : '(no changes)') + '</div>' +
          '</div>' +
          '<div class="batch-result-detail">' +
            '<strong>Scenario:</strong>' +
            '<div class="output-box">' + (result.scenario ? escapeHtml(result.scenario) : '(no changes)') + '</div>' +
          '</div>' +
          '<div class="batch-result-detail">' +
            '<strong>Example Dialogues:</strong>' +
            '<div class="output-box">' + (result.examples ? escapeHtml(result.examples) : '(no changes)') + '</div>' +
          '</div>' +
        '</div>';
      list.appendChild(item);
    });

    container.style.display = 'block';
    showToast('Batch test complete: ' + results.length + ' messages processed', 'success');
  }

  // Helper to escape HTML
  function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>

</body>
</html>
