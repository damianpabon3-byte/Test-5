<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JanitorAI Script Builder v0.2.5 ‚Äì Production Ready</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }

    :root {
      --bg: #1A1411;
      --panel-bg: #241B16;
      --input-bg: #2E231D;
      --hover-surface: #332720;
      --text-primary: #F4E7D5;
      --text-secondary: #D6C2A7;
      --text-muted: #B79E86;
      --border: #4A382E;
      --divider: #3A2C25;
      --accent: #E58A9A;
      --accent-hover: #F0A3B0;
      --accent-soft: rgba(229,138,154,0.12);
      --button-bg: #8B4E3A;
      --button-hover: #A25A43;
      --success: #6E8B5C;
      --danger: #B85A5A;
    }

    body {
      margin: 0;
      padding: 20px;
      font-family: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
    }

    h1, h2, h3 {
      margin-top: 0;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .page-title {
      text-align: center;
      margin-bottom: 6px;
      color: var(--text-primary);
    }

    .page-subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 18px;
    }

    .shell {
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background: var(--panel-bg);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 18px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      border: 1px solid var(--border);
    }

    /* Unified banner system - base class with CSS variables */
    .banner {
      padding: 12px 16px;
      margin-bottom: 16px;
      border-radius: 6px;
      font-size: 0.9rem;
      border-left: 4px solid var(--banner-accent);
      background: var(--banner-bg);
      color: var(--text-primary);
    }

    .banner.warning { --banner-bg: var(--panel-bg); --banner-accent: var(--accent); }
    .banner.info    { --banner-bg: var(--panel-bg); --banner-accent: var(--accent); }
    .banner.success { --banner-bg: var(--panel-bg); --banner-accent: var(--success); }
    .banner.danger  { --banner-bg: var(--panel-bg); --banner-accent: var(--danger); }

    /* Legacy banner classes for backwards compatibility */
    .warning-banner { padding: 12px 16px; margin-bottom: 16px; border-radius: 6px; font-size: 0.9rem; border-left: 4px solid var(--accent); background: var(--panel-bg); }
    .info-banner { padding: 12px 16px; margin-bottom: 16px; border-radius: 6px; font-size: 0.9rem; border-left: 4px solid var(--accent); background: var(--panel-bg); }
    .success-banner { padding: 12px 16px; margin-bottom: 16px; border-radius: 6px; font-size: 0.9rem; border-left: 4px solid var(--success); background: var(--panel-bg); }
    .danger-banner { padding: 12px 16px; margin-bottom: 16px; border-radius: 6px; font-size: 0.9rem; border-left: 4px solid var(--danger); background: var(--panel-bg); }

    .banner strong, .warning-banner strong {
      color: var(--text-secondary);
    }

    /* Unified info boxes - pitfall, glossary, checklist */
    .info-box {
      padding: 12px;
      margin-top: 12px;
      border-radius: 6px;
      font-size: 0.9rem;
      border-left: 4px solid var(--box-accent);
      background: var(--box-bg);
    }

    .info-box.pitfall { --box-bg: var(--panel-bg); --box-accent: var(--accent); }
    .info-box.glossary { --box-bg: var(--panel-bg); --box-accent: var(--accent); }
    .info-box.checklist { --box-bg: var(--panel-bg); --box-accent: var(--success); }

    /* Legacy box classes for backwards compatibility */
    .pitfall-box {
      background: var(--panel-bg);
      border-left: 4px solid var(--accent);
      padding: 12px;
      margin-top: 12px;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .pitfall-box strong, .info-box strong {
      color: var(--accent-hover);
    }

    .pitfall-box ul, .info-box ul {
      margin: 8px 0 0 0;
      padding-left: 20px;
    }

    .pitfall-box li, .info-box li {
      margin-bottom: 4px;
    }

    .onboarding-card {
      background: linear-gradient(135deg, var(--panel-bg) 0%, var(--hover-surface) 100%);
      color: var(--text-primary);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .onboarding-card h2 {
      margin-top: 0;
      font-size: 1.5rem;
    }

    .onboarding-examples {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .onboarding-example {
      background: var(--hover-surface);
      padding: 12px;
      border-radius: 6px;
      backdrop-filter: blur(10px);
    }

    .onboarding-example strong {
      display: block;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }

    .onboarding-example code {
      display: block;
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
      justify-content: center;
    }

    .tab-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      background: var(--hover-surface);
      color: var(--text-primary);
      transition: all 0.2s;
      font-family: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    .tab-btn:hover {
      background: var(--accent);
      color: var(--text-primary);
    }

    .tab-btn.active {
      background: var(--accent);
      color: var(--text-primary);
    }

    .tab-btn.experimental {
      background: var(--accent-soft);
      color: var(--accent-hover);
    }

    .tab-btn.experimental.active {
      background: var(--accent);
      color: var(--text-primary);
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .form-group {
      margin-bottom: 14px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 0.95rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.95rem;
      background: var(--input-bg);
      color: var(--text-primary);
      font-family: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
      font-family: 'Courier New', monospace;
    }

    /* Placeholder styling - makes example text look muted and hint-like */
    input::placeholder,
    textarea::placeholder {
      color: var(--text-muted);
      opacity: 0.8;
    }

    .help-text {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 4px;
      font-style: italic;
    }

    .example-text {
      font-size: 0.85rem;
      color: var(--accent);
      margin-top: 4px;
      padding: 6px 8px;
      background: var(--accent-soft);
      border-radius: 3px;
      border-left: 3px solid var(--accent);
    }

    .example-text code {
      background: var(--hover-surface);
      padding: 2px 4px;
      border-radius: 2px;
      font-size: 0.9em;
    }

    .btn {
      background: var(--button-bg);
      color: var(--text-primary);
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
      margin-right: 8px;
      margin-bottom: 8px;
      transition: background 0.2s;
      font-family: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      font-weight: 600;
    }

    .btn:hover {
      background: var(--button-hover);
    }

    .btn-secondary {
      background: var(--hover-surface);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    .btn-danger {
      background: var(--danger);
    }

    .btn-danger:hover {
      background: var(--danger);
    }

    .btn-success {
      background: var(--success);
    }

    .btn-success:hover {
      background: var(--success);
    }

    .btn-warning {
      background: var(--accent);
      color: var(--text-primary);
    }

    .btn-warning:hover {
      background: var(--accent-hover);
    }

    .dynamic-list {
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 10px;
      margin-top: 8px;
      max-height: 300px;
      overflow-y: auto;
    }

    .dynamic-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      padding: 8px;
      background: var(--input-bg);
      border-radius: 4px;
    }

    .dynamic-item input,
    .dynamic-item textarea {
      flex: 1;
      padding: 6px 8px;
      border: 1px solid var(--border);
      border-radius: 3px;
      font-size: 0.9rem;
    }

    .dynamic-item textarea {
      min-height: 60px;
      font-family: 'Courier New', monospace;
    }

    .dynamic-item button {
      padding: 6px 10px;
      background: var(--danger);
      color: var(--text-primary);
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .output-box {
      background: var(--panel-bg);
      color: var(--text-primary);
      padding: 14px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 10px;
    }

    .module-order {
      border: 1px dashed var(--border);
      border-radius: 6px;
      padding: 12px;
      min-height: 80px;
    }

    .order-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 8px;
      cursor: move;
    }

    .order-item input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .order-item label {
      flex: 1;
      margin: 0;
      font-weight: normal;
    }

    .drag-handle {
      color: var(--text-muted);
      font-size: 1.2rem;
    }

    .token-meter {
      margin-top: 8px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .token-meter .bar {
      height: 6px;
      background: var(--input-bg);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 4px;
    }

    .token-meter .fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--accent), var(--danger));
      transition: width 0.3s;
    }

    .preset-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .preset-card {
      border: 2px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .preset-card:hover {
      border-color: var(--accent);
      box-shadow: 0 2px 8px var(--accent-soft);
    }

    .preset-card h4 {
      margin: 0 0 6px 0;
      color: var(--accent);
    }

    .preset-card p {
      margin: 0;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .glossary, .info-box.glossary {
      background: var(--panel-bg);
      border-left: 4px solid var(--accent);
      padding: 12px;
      border-radius: 6px;
      margin-top: 12px;
      font-size: 0.9rem;
    }

    .glossary h4, .info-box.glossary h4 {
      margin-top: 0;
      color: var(--accent);
    }

    .glossary dl {
      margin: 8px 0 0 0;
    }

    .glossary dt {
      font-weight: 600;
      margin-top: 8px;
      color: var(--text-secondary);
    }

    .glossary dd {
      margin: 2px 0 0 16px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .debug-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: var(--panel-bg);
      border-radius: 4px;
      margin-bottom: 12px;
    }

    .debug-toggle input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .debug-toggle label {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .checklist, .info-box.checklist {
      background: var(--panel-bg);
      border-left: 4px solid var(--success);
      padding: 12px;
      border-radius: 6px;
      margin-top: 12px;
      font-size: 0.9rem;
    }

    .checklist h4, .info-box.checklist h4 {
      margin-top: 0;
      color: var(--success);
    }

    .checklist ul, .info-box.checklist ul {
      margin: 8px 0 0 0;
      padding-left: 20px;
    }

    .checklist li, .info-box.checklist li {
      margin-bottom: 6px;
      color: var(--text-secondary);
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .page-title {
        font-size: 1.75rem;
      }

      .page-subtitle {
        font-size: 0.85rem;
        margin-bottom: 12px;
      }

      .tabs {
        flex-direction: column;
      }
      
      .tab-btn {
        width: 100%;
      }

      .onboarding-card h2 {
        font-size: 1.25rem;
      }

      .onboarding-examples {
        grid-template-columns: 1fr;
      }

      .preset-grid {
        grid-template-columns: 1fr;
      }

      .dynamic-item {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      .dynamic-item input,
      .dynamic-item textarea,
      .dynamic-item select {
        width: 100% !important;
        flex: none !important;
        min-height: 44px;
      }

      .dynamic-item input[type="number"] {
        width: 100% !important;
      }

      .dynamic-item textarea {
        min-height: 100px;
      }

      .dynamic-item button {
        width: 100%;
        padding: 12px;
        min-height: 44px;
      }

      .btn {
        width: 100%;
        margin-right: 0;
        margin-bottom: 10px;
        min-height: 44px;
      }

      .order-item {
        cursor: default;
        padding: 8px;
      }

      .drag-handle {
        display: none;
      }

      .output-box {
        font-size: 0.75rem;
        padding: 10px;
        max-height: 300px;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        min-height: 44px;
        font-size: 16px;
      }

      .form-group textarea {
        min-height: 100px;
      }

      .example-text {
        font-size: 0.8rem;
        word-break: break-word;
      }

      .pitfall-box,
      .warning-banner,
      .info-banner,
      .success-banner,
      .danger-banner {
        font-size: 0.85rem;
        padding: 10px 12px;
      }

      .card {
        padding: 12px;
        margin-bottom: 12px;
      }

      .glossary {
        padding: 10px;
      }

      h3 {
        font-size: 1.25rem;
      }

      h4 {
        font-size: 1.1rem;
      }

      .dynamic-list {
        max-height: 400px;
      }

      .token-meter {
        font-size: 0.8rem;
      }

      .checklist ul,
      .pitfall-box ul {
        font-size: 0.85rem;
      }
    }

    /* Tavern Banner Styles */
    .tavern-banner-wrap {
      text-align: center;
      margin-bottom: 14px;
    }

    .tavern-banner {
      width: 100%;
      max-width: 900px;
      height: auto;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      border: 2px solid var(--accent);
    }

    .tavern-banner-subtext {
      margin-top: 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* Toast notification styles */
    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      pointer-events: none;
    }

    .toast {
      background: var(--panel-bg);
      color: var(--text-primary);
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      font-size: 0.95rem;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: auto;
      text-align: center;
      max-width: 90vw;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    .toast.warning {
      border-left: 4px solid var(--accent);
    }

    /* Trigger Analyzer styles */
    .analyzer-results {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-top: 12px;
      max-height: 400px;
      overflow-y: auto;
    }

    .analyzer-section {
      margin-bottom: 16px;
    }

    .analyzer-section:last-child {
      margin-bottom: 0;
    }

    .analyzer-section h4 {
      margin: 0 0 8px 0;
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    .analyzer-item {
      background: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
      margin-bottom: 8px;
    }

    .analyzer-item:last-child {
      margin-bottom: 0;
    }

    .analyzer-keyword {
      font-weight: 700;
      color: var(--accent);
      font-family: monospace;
      font-size: 1rem;
    }

    .analyzer-usage {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 4px;
      padding-left: 12px;
      border-left: 2px solid var(--border);
    }

    .analyzer-usage-item {
      margin: 4px 0;
    }

    .analyzer-warning {
      border-left: 3px solid var(--accent);
    }

    .analyzer-conflict {
      border-left: 3px solid var(--danger);
    }

    .analyzer-ok {
      border-left: 3px solid var(--success);
    }

    .analyzer-empty {
      color: var(--text-muted);
      font-style: italic;
      text-align: center;
      padding: 20px;
    }

    .analyzer-summary {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      padding: 10px;
      background: var(--panel-bg);
      border-radius: 6px;
    }

    .analyzer-stat {
      font-size: 0.9rem;
    }

    .analyzer-stat strong {
      color: var(--accent);
    }
  </style>
</head>
<body>

<div class="shell">
  <!-- Tavern Banner -->
  <div class="tavern-banner-wrap">
    <img class="tavern-banner" src="tavern_banner.png" alt="Misfit's Tavern Banner">
    <div class="tavern-banner-subtext">
      web tool made by @mellowfllow ‚Ä¢ banner made by @re_joi_ce
    </div>
  </div>

  <h1 class="page-title">Janitor Script Builder v0.2.5</h1>
  <p class="page-subtitle">Advanced scripts made easy ‚Äì fill out simple forms, get copy-paste-ready code. Brought to you by Misfit's Tavern</p>

  <!-- Stateless 101 Onboarding -->
  <div class="onboarding-card">
    <h2>üéì Stateless 101: Understanding How Scripts Work</h2>
    <p style="margin-bottom: 12px;">
      <strong>Key Concept:</strong> JanitorAI scripts run fresh on <em>every single message</em>. Variables don't persist between messages unless you store them in scenario/personality notes.
    </p>
    <div class="onboarding-examples">
      <div class="onboarding-example">
        <strong>‚ùå Won't Work:</strong>
        <code>var score = 0; score++;</code>
        <small style="display:block; margin-top:4px;">Score resets to 0 every message</small>
      </div>
      <div class="onboarding-example">
        <strong>‚úÖ Will Work:</strong>
        <code>Memory ‚Üí adds to scenario notes</code>
        <small style="display:block; margin-top:4px;">Scenario persists between messages</small>
      </div>
      <div class="onboarding-example">
        <strong>‚ö†Ô∏è Experimental:</strong>
        <code>Using {{char}} tags for variables</code>
        <small style="display:block; margin-top:4px;">Fragile, can break with updates</small>
      </div>
    </div>
    <p style="margin-top: 12px; font-size: 0.9rem; opacity: 0.95;">
      <strong>Pro Tip:</strong> Scripts only check the <em>latest user message</em> by default. To check history, you need experimental methods (which may break).
    </p>
  </div>

  <!-- Test Checklist -->
  <div class="card">
    <h3>‚úÖ Pre-Launch Test Checklist</h3>
    <div class="checklist">
      <h4>Before using your script in JanitorAI:</h4>
      <ul>
        <li>‚úì Enable <strong>Debug Mode</strong> in Module Control Panel for first test</li>
        <li>‚úì Start with 1-2 modules, add more once working</li>
        <li>‚úì Test each trigger keyword/phrase in a real conversation</li>
        <li>‚úì Check scenario notes after 5-10 messages for bloat</li>
        <li>‚úì Verify message_count increments correctly (rerolls don't count)</li>
        <li>‚úì Disable debug mode before final deployment</li>
        <li>‚úì Keep total script under 10,000 characters for best performance</li>
      </ul>
    </div>
    <div class="info-banner" style="margin-top: 12px;">
      <strong>üí° Reroll Behavior:</strong> When you reroll a character response, <code>message_count</code> does NOT increment. Only new user messages increase the count.
    </div>
  </div>

  <!-- Recommended Build Order -->
  <div class="card">
    <h3>üìã Recommended Build Order (Pro Workflow)</h3>
    <p>Follow this order for the most reliable and maintainable scripts:</p>
    <ol style="line-height: 1.8;">
      <li><strong>Lorebook</strong> ‚Üí Foundation for rich context (most stable)</li>
      <li><strong>Memory System</strong> ‚Üí Track user info (stable)</li>
      <li><strong>Pacing</strong> ‚Üí Gate story progression (stable)</li>
      <li><strong>Tone/State Engine</strong> ‚Üí Dynamic mood shifts (stable)</li>
      <li><strong>Time & Environment</strong> ‚Üí Hour-based behaviors (stable)</li>
      <li><strong>Ambient Events</strong> ‚Üí Add flavor (watch token growth)</li>
      <li><strong>Random Events</strong> ‚Üí Weighted reactions (moderate complexity)</li>
      <li><strong>Combined Conditions</strong> ‚Üí Multi-trigger rules (advanced)</li>
      <li><strong>Scoring (Stateless only)</strong> ‚Üí Sentiment analysis (experimental)</li>
    </ol>
    <div class="info-banner">
      <strong>üí° Why this order?</strong> Lorebook and Memory are stable and token-efficient. Add complexity gradually, testing at each step. The Module Control Panel below is pre-ordered to match this workflow.
    </div>
  </div>

  <!-- Scenario Maintenance Tips -->
  <div class="card">
    <h3>üßπ Scenario Maintenance Best Practices</h3>
    <div class="warning-banner">
      <strong>‚ö†Ô∏è Token Bloat Warning:</strong> Scripts that only append to scenario will cause slowdowns over long conversations.
    </div>
    <p><strong>Pro strategies to prevent bloat:</strong></p>
    <ul style="line-height: 1.6;">
      <li><strong>Use personality for moods/states</strong> instead of scenario (personality can be overwritten)</li>
      <li><strong>Summarize old notes periodically</strong> instead of endless appending</li>
      <li><strong>Use lorebooks for static info</strong> that only triggers when relevant</li>
      <li><strong>Prefer "replace" over "append"</strong> for things that change (time, mood)</li>
      <li><strong>Test scenario length</strong> after 20-30 messages and clean if needed</li>
    </ul>
    <div class="example-text">
      <strong>Example:</strong> Instead of appending "User is happy" every time, <em>replace</em> the mood line or store it in personality which naturally gets refreshed.
    </div>
  </div>

  <!-- Module Control Panel -->
  <div class="card">
    <h3>‚öôÔ∏è Module Control Panel</h3>
    <div class="debug-toggle">
      <input type="checkbox" id="debugMode" />
      <label for="debugMode">
        <strong>üêõ Debug Mode:</strong> Add "(debug: module fired)" notes to scenario output for testing
      </label>
    </div>
    <div class="warning-banner">
      <strong>‚ö†Ô∏è Execution Order Matters!</strong> Modules run in the order below. Later modules can override earlier ones. Drag to reorder. This panel is pre-ordered to match the recommended pro workflow above.
    </div>
    <div id="moduleOrder" class="module-order">
      <div class="order-item" draggable="true" data-module="lorebook">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <input type="checkbox" id="toggle-lorebook" checked />
        <label for="toggle-lorebook">Lorebook</label>
      </div>
      <div class="order-item" draggable="true" data-module="memory">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <input type="checkbox" id="toggle-memory" checked />
        <label for="toggle-memory">Memory System</label>
      </div>
      <div class="order-item" draggable="true" data-module="pacing">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <input type="checkbox" id="toggle-pacing" checked />
        <label for="toggle-pacing">Pacing</label>
      </div>
      <div class="order-item" draggable="true" data-module="tone">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <input type="checkbox" id="toggle-tone" checked />
        <label for="toggle-tone">Tone/State Engine</label>
      </div>
      <div class="order-item" draggable="true" data-module="time">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <input type="checkbox" id="toggle-time" />
        <label for="toggle-time">Time & Environment</label>
      </div>
      <div class="order-item" draggable="true" data-module="ambient">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <input type="checkbox" id="toggle-ambient" />
        <label for="toggle-ambient">Ambient Events</label>
      </div>
      <div class="order-item" draggable="true" data-module="random">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <input type="checkbox" id="toggle-random" />
        <label for="toggle-random">Random Events</label>
      </div>
      <div class="order-item" draggable="true" data-module="combined">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <input type="checkbox" id="toggle-combined" />
        <label for="toggle-combined">Combined Conditions</label>
      </div>
      <div class="order-item" draggable="true" data-module="scoring">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <input type="checkbox" id="toggle-scoring" />
        <label for="toggle-scoring">Scoring Engine (Experimental)</label>
      </div>
    </div>
    <button type="button" class="btn btn-success" onclick="generateFinalCombinedScript()">
      üì¶ Copy All Enabled Modules
    </button>
    <button type="button" class="btn btn-warning" onclick="generateAllEnabledModules()">
      ‚ö° Generate All Enabled (then combine)
    </button>
    <button type="button" class="btn btn-danger" onclick="resetAllFields()">
      üîÑ Reset All Fields
    </button>
    <div class="token-meter" id="tokenMeter">
      <span>Estimated Script Size: <strong id="tokenCount">0</strong> characters</span>
      <div class="bar">
        <div class="fill" id="tokenFill" style="width: 0%"></div>
      </div>
      <small style="display:block; margin-top:4px;">Keep under 10,000 characters for best performance</small>
    </div>
  </div>

  <!-- Preset Library -->
  <div class="card">
    <h3>üìö Load Preset Templates</h3>
    <p>Click a preset to auto-fill the form with starter values. You can customize them after loading.</p>
    <div class="preset-grid">
      <div class="preset-card" onclick="loadPreset('slowburn')">
        <h4>üåπ Slow-Burn Romance</h4>
        <p>Gradual relationship progression with memory tracking</p>
      </div>
      <div class="preset-card" onclick="loadPreset('rpg')">
        <h4>‚öîÔ∏è RPG Adventure</h4>
        <p>Lorebook-heavy with locations, NPCs, and events</p>
      </div>
      <div class="preset-card" onclick="loadPreset('ambient')">
        <h4>üåø Ambient Flavor Pack</h4>
        <p>Random environmental details for immersion</p>
      </div>
      <div class="preset-card" onclick="loadPreset('memory')">
        <h4>üß† Memory Starter</h4>
        <p>Simple name + facts tracking for any scenario</p>
      </div>
    </div>
  </div>

  <!-- Module Tabs -->
  <div class="card">
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab(event, 'lorebook')">Lorebook</button>
      <button class="tab-btn" onclick="switchTab(event, 'memory')">Memory</button>
      <button class="tab-btn" onclick="switchTab(event, 'pacing')">Pacing</button>
      <button class="tab-btn" onclick="switchTab(event, 'tone')">Tone/State</button>
      <button class="tab-btn" onclick="switchTab(event, 'time')">Time & Environment</button>
      <button class="tab-btn" onclick="switchTab(event, 'ambient')">Ambient Events</button>
      <button class="tab-btn" onclick="switchTab(event, 'random')">Random Events</button>
      <button class="tab-btn" onclick="switchTab(event, 'combined')">Combined Conditions</button>
      <button class="tab-btn experimental" onclick="switchTab(event, 'scoring')">‚ö†Ô∏è Scoring (Experimental)</button>
    </div>

    <!-- LOREBOOK TAB -->
    <div id="lorebook" class="tab-panel active">
      <h3>üìñ Lorebook (Hierarchical Keyword Database)</h3>
      <p>Create a rich world with people, places, objects, moods, and events that trigger based on keywords.</p>
      
      <div class="warning-banner">
        <strong>‚ö†Ô∏è Token Warning:</strong> Keep entries 2-4 short paragraphs each. Too many long entries can cause slowdowns.
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" id="lorePadded" checked /> Use Padded Matching
        </label>
        <div class="help-text">Prevents partial word matches (e.g., "cat" won't trigger on "catch"). Note: Works best with single-word keywords. Multi-word phrases may need exact spacing.</div>
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" id="loreBreakEarly" checked /> Break After First Match
        </label>
        <div class="help-text">Stop after the first lore entry triggers (saves tokens, prevents multiple entries firing at once)</div>
      </div>

      <h4>üìù Lore Entries</h4>
      <button type="button" class="btn btn-secondary" onclick="addLoreEntry()">+ Add Entry</button>
      <div id="loreEntries" class="dynamic-list"></div>

      <button type="button" class="btn" onclick="generateLorebookScript()">Generate Lorebook Script</button>
      <button type="button" class="btn btn-secondary" onclick="copyToClipboard('lorebookOutput')">Copy to Clipboard</button>
      
      <div class="output-box" id="lorebookOutput">// Script will appear here after clicking Generate</div>

      <div class="pitfall-box">
        <strong>‚ö†Ô∏è Common Pitfalls:</strong>
        <ul>
          <li>Keywords too broad (e.g., "is", "the") trigger constantly</li>
          <li>Entries too long cause token bloat</li>
          <li>Without break-early, multiple entries can fire and overwhelm context</li>
          <li>Not using padded matching causes false triggers on partial words</li>
          <li>Same entry can trigger repeatedly ‚Üí enable deduplication below</li>
        </ul>
      </div>

      <div class="glossary">
        <h4>üìò Lorebook Glossary</h4>
        <dl>
          <dt>Keywords</dt>
          <dd>Words that trigger this lore entry (comma-separated, case-insensitive)</dd>
          <dt>Category</dt>
          <dd>Organizes entries: people, places, objects, moods, events</dd>
          <dt>Content</dt>
          <dd>Text injected into scenario when keywords match</dd>
          <dt>Padded Matching</dt>
          <dd>Requires spaces around keywords to avoid "cat" matching "scatter"</dd>
          <dt>Break-Early</dt>
          <dd>Stops checking after first match (recommended for performance)</dd>
        </dl>
      </div>
    </div>

    <!-- MEMORY TAB -->
    <div id="memory" class="tab-panel">
      <h3>üß† Memory System</h3>
      <p>Automatically detect and remember the user's name, facts about them, likes, and dislikes.</p>
      
      <div class="form-group">
        <label>Name Detection Trigger Phrase</label>
        <input type="text" id="memNamePhrase" placeholder="my name is" />
        <div class="help-text">The phrase that triggers name detection (case-insensitive)</div>
        <div class="example-text">Example: If user says "Hi, my name is Mar√≠a Garc√≠a", the script will remember "Mar√≠a Garc√≠a" (supports accents, hyphens, apostrophes, up to 40 characters)</div>
      </div>

      <div class="form-group">
        <label>Facts Keywords (comma-separated)</label>
        <input type="text" id="memFactsKeywords" placeholder="fact, i am, i work as, i study" />
        <div class="help-text">Keywords that trigger fact storage</div>
        <div class="example-text">Example: "Here's a fact: I love programming" ‚Üí saved as fact</div>
      </div>

      <div class="form-group">
        <label>Likes Keywords (comma-separated)</label>
        <input type="text" id="memLikesKeywords" placeholder="i like, i love, i enjoy, favorite" />
        <div class="help-text">Keywords that trigger likes storage</div>
        <div class="example-text">Example: "I love pizza" ‚Üí saved as like</div>
      </div>

      <div class="form-group">
        <label>Dislikes Keywords (comma-separated)</label>
        <input type="text" id="memDislikesKeywords" placeholder="i hate, i dislike, i don't like, can't stand" />
        <div class="help-text">Keywords that trigger dislikes storage</div>
        <div class="example-text">Example: "I hate mornings" ‚Üí saved as dislike</div>
      </div>

      <button type="button" class="btn" onclick="generateMemoryScript()">Generate Memory Script</button>
      <button type="button" class="btn btn-secondary" onclick="copyToClipboard('memoryOutput')">Copy to Clipboard</button>
      
      <div class="output-box" id="memoryOutput">// Script will appear here after clicking Generate</div>

      <div class="pitfall-box">
        <strong>‚ö†Ô∏è Common Pitfalls:</strong>
        <ul>
          <li>Trigger phrases too specific ‚Üí never fire</li>
          <li>No deduplication ‚Üí same fact saved multiple times (v3 includes basic dedupe)</li>
          <li>Scenario grows forever without maintenance</li>
          <li>Name regex may miss very long names (limited to 40 chars for safety)</li>
        </ul>
      </div>
    </div>

    <!-- PACING TAB -->
    <div id="pacing" class="tab-panel">
      <h3>üìä Pacing System (Message Count Gates)</h3>
      <p>Control story progression based on how many messages have been sent.</p>

      <div class="info-banner">
        <strong>üí° Pro Tip:</strong> Use pacing to gate major story beats. Combine with one-time events for reveals.
      </div>

      <div class="warning-banner">
        <strong>‚ö†Ô∏è Reroll Behavior:</strong> When you reroll a character response, <code>message_count</code> does NOT increment. Only new user messages count.
      </div>

      <h4>üìà Message Count Phases</h4>
      <button type="button" class="btn btn-secondary" onclick="addPacingPhase()">+ Add Phase</button>
      <div id="pacingPhases" class="dynamic-list"></div>

      <h4>üéØ One-Time Events (Exact Message Count)</h4>
      <button type="button" class="btn btn-secondary" onclick="addOneTimeEvent()">+ Add Event</button>
      <div id="oneTimeEvents" class="dynamic-list"></div>

      <button type="button" class="btn" onclick="generatePacingScript()">Generate Pacing Script</button>
      <button type="button" class="btn btn-secondary" onclick="copyToClipboard('pacingOutput')">Copy to Clipboard</button>
      
      <div class="output-box" id="pacingOutput">// Script will appear here after clicking Generate</div>

      <div class="pitfall-box">
        <strong>‚ö†Ô∏è Common Pitfalls:</strong>
        <ul>
          <li>Forgetting that rerolls don't increment message_count</li>
          <li>Overlapping phases causing conflicts</li>
          <li>One-time events at count 1 may miss if bot speaks first</li>
        </ul>
      </div>

      <div class="glossary">
        <h4>üìò Pacing Glossary</h4>
        <dl>
          <dt>message_count</dt>
          <dd>Built-in JanitorAI variable tracking total user messages sent (rerolls don't increment)</dd>
          <dt>Phases</dt>
          <dd>Ranges of messages (e.g., 1-10, 11-30) with associated behavior</dd>
          <dt>One-Time Events</dt>
          <dd>Fire exactly once at a specific message number</dd>
        </dl>
      </div>
    </div>

    <!-- TONE/STATE TAB -->
    <div id="tone" class="tab-panel">
      <h3>üé≠ Tone/State Engine</h3>
      <p>Dynamically shift character personality based on keywords in user messages.</p>

      <div class="form-group">
        <label>
          <input type="checkbox" id="tonePadded" checked /> Use Padded Matching
        </label>
        <div class="help-text">Prevents "angry" matching "danger". Note: Works best with single-word keywords.</div>
      </div>

      <h4>üé® Tone Triggers</h4>
      <button type="button" class="btn btn-secondary" onclick="addToneTrigger()">+ Add Trigger</button>
      <div id="toneTriggers" class="dynamic-list"></div>

      <button type="button" class="btn" onclick="generateToneScript()">Generate Tone Script</button>
      <button type="button" class="btn btn-secondary" onclick="copyToClipboard('toneOutput')">Copy to Clipboard</button>
      
      <div class="output-box" id="toneOutput">// Script will appear here after clicking Generate</div>

      <div class="pitfall-box">
        <strong>‚ö†Ô∏è Common Pitfalls:</strong>
        <ul>
          <li>Without padded matching, "sad" triggers on "salad"</li>
          <li>Multiple triggers fire ‚Üí personality bloats</li>
          <li>Mood doesn't reset between messages (use replace, not append)</li>
        </ul>
      </div>

      <div class="example-text">
        <strong>Example Trigger:</strong><br>
        Keywords: <code>angry, mad, furious</code><br>
        Personality Add-on: <code>{{char}} is currently angry and speaking tersely.</code>
      </div>
    </div>

    <!-- TIME & ENVIRONMENT TAB -->
    <div id="time" class="tab-panel">
      <h3>üåÖ Time & Environment System</h3>
      <p>Change character behavior and environment based on time of day.</p>

      <div class="warning-banner">
        <strong>‚ö†Ô∏è Time Source:</strong> Uses server time + your timezone offset. Time changes happen once per hour. Supports wrap-around (e.g., 22:00 to 03:00 for night).
      </div>

      <div class="form-group">
        <label>Timezone Offset (hours from UTC)</label>
        <input type="number" id="timeOffset" value="0" min="-12" max="14" />
        <div class="help-text">e.g., PST = -8, EST = -5, GMT = 0, JST = +9</div>
        <div class="example-text">Example: If server time is 14:00 UTC and offset is -8, local time is 06:00</div>
      </div>

      <h4>‚è∞ Time-Based Behaviors</h4>
      <button type="button" class="btn btn-secondary" onclick="addTimeSlot()">+ Add Time Slot</button>
      <div id="timeSlots" class="dynamic-list"></div>

      <button type="button" class="btn" onclick="generateTimeScript()">Generate Time Script</button>
      <button type="button" class="btn btn-secondary" onclick="copyToClipboard('timeOutput')">Copy to Clipboard</button>
      
      <div class="output-box" id="timeOutput">// Script will appear here after clicking Generate</div>

      <div class="pitfall-box">
        <strong>‚ö†Ô∏è Common Pitfalls:</strong>
        <ul>
          <li>Server time may not match your local time without offset</li>
          <li>Overlapping time slots cause conflicts</li>
          <li>Hour-based checks only update once per hour</li>
          <li>Forgot to handle wrap-around (e.g., 22:00-03:00) ‚Üí v3 handles this automatically</li>
        </ul>
      </div>
    </div>

    <!-- AMBIENT EVENTS TAB -->
    <div id="ambient" class="tab-panel">
      <h3>üåø Ambient Events (Random Flavor Text)</h3>
      <p>Add random environmental details to make the world feel alive.</p>

      <div class="warning-banner">
        <strong>‚ö†Ô∏è Scenario Growth:</strong> These add to scenario notes. Use sparingly to avoid bloat.
      </div>

      <div class="form-group">
        <label>Trigger Probability (%)</label>
        <input type="number" id="ambientProbability" value="10" min="1" max="100" />
        <div class="help-text">Chance each message triggers an ambient event (1-100)</div>
        <div class="example-text">Example: 10% = roughly 1 in 10 messages adds flavor text</div>
      </div>

      <h4>üé≤ Ambient Event Pool</h4>
      <button type="button" class="btn btn-secondary" onclick="addAmbientEvent()">+ Add Event</button>
      <div id="ambientEvents" class="dynamic-list"></div>

      <button type="button" class="btn" onclick="generateAmbientScript()">Generate Ambient Script</button>
      <button type="button" class="btn btn-secondary" onclick="copyToClipboard('ambientOutput')">Copy to Clipboard</button>
      
      <div class="output-box" id="ambientOutput">// Script will appear here after clicking Generate</div>

      <div class="pitfall-box">
        <strong>‚ö†Ô∏è Common Pitfalls:</strong>
        <ul>
          <li>High probability (>20%) causes rapid scenario bloat</li>
          <li>Events append forever without cleanup</li>
          <li>Same event can trigger multiple times (expected behavior)</li>
        </ul>
      </div>

      <div class="example-text">
        <strong>Example Event:</strong><br>
        <code>A bird chirps in the distance. The cafe smells of fresh coffee.</code>
      </div>
    </div>

    <!-- RANDOM EVENTS TAB -->
    <div id="random" class="tab-panel">
      <h3>üé≤ Random Events (Weighted Reactions)</h3>
      <p>Trigger random character reactions when user says specific phrases.</p>

      <h4>üéØ Event Triggers</h4>
      <button type="button" class="btn btn-secondary" onclick="addRandomEvent()">+ Add Event</button>
      <div id="randomEvents" class="dynamic-list"></div>

      <button type="button" class="btn" onclick="generateRandomScript()">Generate Random Events Script</button>
      <button type="button" class="btn btn-secondary" onclick="copyToClipboard('randomOutput')">Copy to Clipboard</button>
      
      <div class="output-box" id="randomOutput">// Script will appear here after clicking Generate</div>

      <div class="pitfall-box">
        <strong>‚ö†Ô∏è Common Pitfalls:</strong>
        <ul>
          <li>Trigger phrases too common ‚Üí fires constantly</li>
          <li>Responses not pipe-separated correctly</li>
          <li>Adding to personality instead of scenario</li>
        </ul>
      </div>

      <div class="example-text">
        <strong>Example Event:</strong><br>
        Trigger Phrase: <code>what do you think</code><br>
        Responses: <code>I think it's interesting|I'm not sure|That's a tough one</code> (pipe-separated, chosen randomly)
      </div>
    </div>

    <!-- COMBINED CONDITIONS TAB -->
    <div id="combined" class="tab-panel">
      <h3>üîó Combined Conditions (Multi-Trigger Rules)</h3>
      <p>Create rules that fire when multiple conditions are met (keywords + time + message count).</p>

      <div class="warning-banner">
        <strong>‚ö†Ô∏è Stateless Only:</strong> Combined rules work best with stateless checks (time + message_count + keywords). Time wrap-around supported (e.g., 22:00-03:00).
      </div>

      <h4>‚ö° Combined Rules</h4>
      <button type="button" class="btn btn-secondary" onclick="addCombinedRule()">+ Add Rule</button>
      <div id="combinedRules" class="dynamic-list"></div>

      <button type="button" class="btn" onclick="generateCombinedConditionsScript()">Generate Combined Script</button>
      <button type="button" class="btn btn-secondary" onclick="copyToClipboard('combinedOutput')">Copy to Clipboard</button>
      
      <div class="output-box" id="combinedOutput">// Script will appear here after clicking Generate</div>

      <div class="pitfall-box">
        <strong>‚ö†Ô∏è Common Pitfalls:</strong>
        <ul>
          <li>Conditions too strict ‚Üí never triggers</li>
          <li>Time checks without timezone offset mismatch user's local time</li>
          <li>Multiple rules fire at once causing bloat</li>
        </ul>
      </div>

      <div class="example-text">
        <strong>Example Rule:</strong><br>
        Keywords: <code>romantic, dinner</code><br>
        Min Hour: <code>18</code> Max Hour: <code>22</code><br>
        Min Messages: <code>20</code><br>
        Result: <code>{{char}} suggests a romantic candlelit dinner.</code><br>
        ‚Üí Only fires if user mentions "romantic" or "dinner" between 6pm-10pm after 20+ messages
      </div>
    </div>

    <!-- SCORING TAB -->
    <div id="scoring" class="tab-panel">
      <h3>üéØ Scoring Engine (EXPERIMENTAL)</h3>
      
      <div class="danger-banner">
        <strong>‚ö†Ô∏è EXPERIMENTAL FEATURE:</strong> Scoring is complex due to stateless constraints. Persistent mode uses fragile tag-based storage that may break. Use with extreme caution.
      </div>

      <div class="form-group">
        <label>Scoring Mode</label>
        <select id="scoringMode">
          <option value="stateless">Stateless (Single-Turn Sentiment) - RECOMMENDED</option>
          <option value="persistent">Persistent (Experimental Tag-Based) - FRAGILE</option>
        </select>
        <div class="help-text">
          <strong>Stateless:</strong> Analyzes current message only (safe)<br>
          <strong>Persistent:</strong> Uses {{char}} tags to store scores (fragile, may break with platform updates)
        </div>
      </div>

      <h4>‚ûï Positive Keywords</h4>
      <div class="form-group">
        <input type="text" id="scoringPositive" placeholder="love, great, wonderful, amazing" />
        <div class="example-text">Example: "You're amazing!" ‚Üí positive sentiment detected</div>
      </div>

      <h4>‚ûñ Negative Keywords</h4>
      <div class="form-group">
        <input type="text" id="scoringNegative" placeholder="hate, awful, terrible, horrible" />
        <div class="example-text">Example: "This is terrible" ‚Üí negative sentiment detected</div>
      </div>

      <h4>üìä Score Thresholds & Responses</h4>
      <button type="button" class="btn btn-secondary" onclick="addScoreThreshold()">+ Add Threshold</button>
      <div id="scoreThresholds" class="dynamic-list"></div>

      <button type="button" class="btn" onclick="generateScoringScript()">Generate Scoring Script</button>
      <button type="button" class="btn btn-secondary" onclick="copyToClipboard('scoringOutput')">Copy to Clipboard</button>
      
      <div class="output-box" id="scoringOutput">// Script will appear here after clicking Generate</div>

      <div class="pitfall-box">
        <strong>‚ö†Ô∏è Common Pitfalls:</strong>
        <ul>
          <li>Persistent mode tags can be stripped by platform updates</li>
          <li>Keyword sentiment too simplistic for nuanced emotion</li>
          <li>Score thresholds never reached with stateless mode</li>
          <li>No decay ‚Üí persistent scores grow forever</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- TRIGGER ANALYZER -->
  <div class="card">
    <h3>üîç Trigger Analyzer</h3>
    <p>Scan all modules for potential keyword conflicts, overlaps, and bottlenecks.</p>
    <button type="button" class="btn" onclick="analyzeTriggers()">Analyze Triggers</button>
    <div id="analyzerResults"></div>
  </div>

  <!-- FINAL COMBINED OUTPUT -->
  <div class="card">
    <h3>üì¶ Final Combined Output</h3>
    <p>This is the complete script with all enabled modules merged in your chosen order.</p>
    <button type="button" class="btn btn-success" onclick="generateFinalCombinedScript()">üîÑ Regenerate Combined Script</button>
    <button type="button" class="btn btn-secondary" onclick="copyToClipboard('finalOutput')">Copy to Clipboard</button>
    <div class="output-box" id="finalOutput">// Combined script will appear here after clicking "Copy All Enabled Modules"</div>
  </div>

</div>

<script>
  // ===========================
  //   UTILITY FUNCTIONS
  // ===========================

  function escapeForScript(str) {
    if (!str) return '';
    // JSON.stringify handles quotes, newlines, special chars, and unicode safely
    // Slice off surrounding quotes, then escape single quotes for JS string literals
    return JSON.stringify(str).slice(1, -1).replace(/'/g, "\\'");
  }

  // Toast notification system - replaces blocking alert() dialogs
  var toastContainer = null;
  var toastTimeout = null;

  function showToast(message, type) {
    type = type || 'success';

    // Create container if it doesn't exist
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.className = 'toast-container';
      document.body.appendChild(toastContainer);
    }

    // Clear any existing toast
    if (toastTimeout) {
      clearTimeout(toastTimeout);
    }
    toastContainer.innerHTML = '';

    // Create new toast
    var toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    toastContainer.appendChild(toast);

    // Trigger animation
    setTimeout(function() {
      toast.classList.add('show');
    }, 10);

    // Auto-hide after 3 seconds
    toastTimeout = setTimeout(function() {
      toast.classList.remove('show');
      setTimeout(function() {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }, 3000);
  }

  function escapeForRegex(str) {
    if (!str) return '';
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  function switchTab(e, tabName) {
    var tabs = document.querySelectorAll('.tab-btn');
    var panels = document.querySelectorAll('.tab-panel');
    
    tabs.forEach(function(tab) {
      tab.classList.remove('active');
    });
    panels.forEach(function(panel) {
      panel.classList.remove('active');
    });

    e.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');
  }

  function copyToClipboard(elementId) {
    var text = document.getElementById(elementId).textContent;

    // Try modern clipboard API first (requires HTTPS)
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(function() {
        showToast('Copied to clipboard!', 'success');
      }, function() {
        // If clipboard API fails, fall back to legacy method
        fallbackCopyToClipboard(text);
      });
    } else {
      fallbackCopyToClipboard(text);
    }
  }

  // Robust fallback for mobile, WebViews, and non-HTTPS contexts
  function fallbackCopyToClipboard(text) {
    var textarea = document.createElement('textarea');
    textarea.value = text;

    // Prevent zooming on iOS (font-size < 16px triggers zoom)
    textarea.style.fontSize = '16px';

    // Hide the textarea while keeping it functional
    textarea.style.position = 'fixed';
    textarea.style.top = '0';
    textarea.style.left = '0';
    textarea.style.width = '2em';
    textarea.style.height = '2em';
    textarea.style.padding = '0';
    textarea.style.border = 'none';
    textarea.style.outline = 'none';
    textarea.style.boxShadow = 'none';
    textarea.style.background = 'transparent';
    textarea.style.opacity = '0';
    textarea.style.zIndex = '-1';

    // Prevent keyboard from appearing on mobile
    textarea.setAttribute('readonly', '');

    document.body.appendChild(textarea);

    // iOS-specific selection method
    if (navigator.userAgent.match(/ipad|ipod|iphone/i)) {
      textarea.contentEditable = true;
      textarea.readOnly = true;
      var range = document.createRange();
      range.selectNodeContents(textarea);
      var selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      textarea.setSelectionRange(0, 999999);
    } else {
      textarea.select();
    }

    var success = false;
    try {
      success = document.execCommand('copy');
    } catch (err) {
      success = false;
    }

    document.body.removeChild(textarea);

    if (success) {
      showToast('Copied to clipboard!', 'success');
    } else {
      showToast('Failed to copy. Please select and copy manually.', 'error');
    }
  }

  function updateTokenMeter() {
    var totalLength = 0;
    var items = document.querySelectorAll('#moduleOrder .order-item');

    items.forEach(function(item) {
      var module = item.getAttribute('data-module');
      var checkbox = document.getElementById('toggle-' + module);
      if (checkbox && checkbox.checked) {
        var outputId = module + 'Output';
        var outputEl = document.getElementById(outputId);
        if (outputEl && !outputEl.textContent.includes('// Script will appear here')) {
          // Ignore outputs that only contain "empty module" notices
          var isNoop = /module currently does nothing|entries configured|triggers configured|slots configured|phases or events configured|keywords configured|events configured|rules configured/i.test(outputEl.textContent);
          if (!isNoop) {
            totalLength += outputEl.textContent.length;
          }
        }
      }
    });

    document.getElementById('tokenCount').textContent = totalLength;
    var percentage = Math.min((totalLength / 10000) * 100, 100);
    document.getElementById('tokenFill').style.width = percentage + '%';
  }

  // Helper function for time wrap-around
  function generateHourInRangeFunction() {
    return "function hourInRange(h, start, end) {\n" +
           "  return start <= end ? (h >= start && h <= end) : (h >= start || h <= end);\n" +
           "}\n\n";
  }

  // ===========================
  //   DRAG & DROP FOR MODULE ORDER
  // ===========================

  (function() {
    var draggedItem = null;

    document.addEventListener('DOMContentLoaded', function() {
      var orderItems = document.querySelectorAll('.order-item');
      
      orderItems.forEach(function(item) {
        item.addEventListener('dragstart', function(e) {
          draggedItem = this;
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/html', this.innerHTML);
          this.style.opacity = '0.5';
        });

        item.addEventListener('dragend', function(e) {
          this.style.opacity = '';
        });

        item.addEventListener('dragover', function(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          
          if (this !== draggedItem) {
            var rect = this.getBoundingClientRect();
            var midpoint = rect.top + rect.height / 2;
            
            if (e.clientY < midpoint) {
              this.parentNode.insertBefore(draggedItem, this);
            } else {
              this.parentNode.insertBefore(draggedItem, this.nextSibling);
            }
          }
        });
      });
    });
  })();

  // ===========================
  //   RESET AND BATCH OPERATIONS
  // ===========================

  function resetAllFields() {
    if (!confirm('‚ö†Ô∏è This will clear all fields and reset to defaults. Are you sure?')) {
      return;
    }

    // Reset memory
    document.getElementById('memNamePhrase').value = 'my name is';
    document.getElementById('memFactsKeywords').value = 'fact, i am, i work as, i study';
    document.getElementById('memLikesKeywords').value = 'i like, i love, i enjoy, favorite';
    document.getElementById('memDislikesKeywords').value = 'i hate, i dislike, i don\'t like, can\'t stand';

    // Clear dynamic lists
    document.getElementById('loreEntries').innerHTML = '';
    document.getElementById('timeSlots').innerHTML = '';
    document.getElementById('pacingPhases').innerHTML = '';
    document.getElementById('oneTimeEvents').innerHTML = '';
    document.getElementById('toneTriggers').innerHTML = '';
    document.getElementById('ambientEvents').innerHTML = '';
    document.getElementById('randomEvents').innerHTML = '';
    document.getElementById('combinedRules').innerHTML = '';
    document.getElementById('scoreThresholds').innerHTML = '';

    // Reset other fields
    document.getElementById('timeOffset').value = '0';
    document.getElementById('ambientProbability').value = '10';
    document.getElementById('scoringPositive').value = 'love, great, wonderful, amazing';
    document.getElementById('scoringNegative').value = 'hate, awful, terrible, horrible';
    document.getElementById('scoringMode').value = 'stateless';

    // Clear outputs
    var outputs = ['memoryOutput', 'lorebookOutput', 'timeOutput', 'pacingOutput', 'toneOutput', 'scoringOutput', 'ambientOutput', 'randomOutput', 'combinedOutput', 'finalOutput'];
    outputs.forEach(function(id) {
      document.getElementById(id).textContent = '// Script will appear here after clicking Generate';
    });

    // Restore default toggles
    document.getElementById('toggle-lorebook').checked = true;
    document.getElementById('toggle-memory').checked = true;
    document.getElementById('toggle-pacing').checked = true;
    document.getElementById('toggle-tone').checked = true;

    document.getElementById('toggle-time').checked = false;
    document.getElementById('toggle-ambient').checked = false;
    document.getElementById('toggle-random').checked = false;
    document.getElementById('toggle-combined').checked = false;
    document.getElementById('toggle-scoring').checked = false;

    // Add one default entry for each
    addLoreEntry();
    addTimeSlot();
    addPacingPhase();
    addToneTrigger();
    addAmbientEvent();

    showToast('All fields reset to defaults!', 'success');
  }

  function generateAllEnabledModules() {
    var items = document.querySelectorAll('#moduleOrder .order-item');
    var enabledModules = [];
    
    items.forEach(function(item) {
      var module = item.getAttribute('data-module');
      var checkbox = document.getElementById('toggle-' + module);
      if (checkbox && checkbox.checked) {
        enabledModules.push(module);
      }
    });

    if (enabledModules.length === 0) {
      showToast('No modules enabled! Please enable at least one module.', 'warning');
      return;
    }

    // Generate each enabled module
    enabledModules.forEach(function(module) {
      switch(module) {
        case 'memory': generateMemoryScript(); break;
        case 'lorebook': generateLorebookScript(); break;
        case 'time': generateTimeScript(); break;
        case 'pacing': generatePacingScript(); break;
        case 'tone': generateToneScript(); break;
        case 'scoring': generateScoringScript(); break;
        case 'ambient': generateAmbientScript(); break;
        case 'random': generateRandomScript(); break;
        case 'combined': generateCombinedConditionsScript(); break;
      }
    });

    // Then combine
    setTimeout(function() {
      generateFinalCombinedScript();
    }, 100);

    showToast('Generated all ' + enabledModules.length + ' enabled modules and combined them!', 'success');
  }

  // ===========================
  //   PRESET LOADER
  // ===========================

  function loadPreset(presetName) {
    if (presetName === 'slowburn') {
      document.getElementById('memNamePhrase').value = 'my name is';
      document.getElementById('memFactsKeywords').value = 'fact, i am, i work as';
      document.getElementById('memLikesKeywords').value = 'i like, i love, favorite';
      document.getElementById('memDislikesKeywords').value = 'i hate, i dislike';

      document.getElementById('pacingPhases').innerHTML = '';
      addPacingPhase();
      var phases = document.querySelectorAll('#pacingPhases .dynamic-item');
      phases[0].querySelector('input[placeholder="Min messages"]').value = '1';
      phases[0].querySelector('input[placeholder="Max messages"]').value = '15';
      phases[0].querySelector('textarea').value = '{{char}} is cautious and formal, still getting to know {{user}}.';

      addPacingPhase();
      phases = document.querySelectorAll('#pacingPhases .dynamic-item');
      phases[1].querySelector('input[placeholder="Min messages"]').value = '16';
      phases[1].querySelector('input[placeholder="Max messages"]').value = '40';
      phases[1].querySelector('textarea').value = '{{char}} is warming up, showing more genuine interest.';

      addPacingPhase();
      phases = document.querySelectorAll('#pacingPhases .dynamic-item');
      phases[2].querySelector('input[placeholder="Min messages"]').value = '41';
      phases[2].querySelector('input[placeholder="Max messages"]').value = '999';
      phases[2].querySelector('textarea').value = '{{char}} feels comfortable and open, deeply engaged.';

      showToast('Slow-Burn Romance preset loaded! Check Memory and Pacing tabs.', 'success');
      switchTab({target: document.querySelectorAll('.tab-btn')[1]}, 'memory');

    } else if (presetName === 'rpg') {
      document.getElementById('loreEntries').innerHTML = '';
      addLoreEntry();
      var entries = document.querySelectorAll('#loreEntries .dynamic-item');
      entries[0].querySelector('select').value = 'people';
      entries[0].querySelector('input[placeholder="Keywords (comma-separated)"]').value = 'blacksmith, forge';
      entries[0].querySelector('textarea').value = 'The blacksmith Gareth runs the forge. He is gruff but fair, known for masterwork weapons.';

      addLoreEntry();
      entries = document.querySelectorAll('#loreEntries .dynamic-item');
      entries[1].querySelector('select').value = 'places';
      entries[1].querySelector('input[placeholder="Keywords (comma-separated)"]').value = 'tavern, inn';
      entries[1].querySelector('textarea').value = 'The Rusty Tankard tavern is a cozy refuge, always filled with adventurers and rumors.';

      addLoreEntry();
      entries = document.querySelectorAll('#loreEntries .dynamic-item');
      entries[2].querySelector('select').value = 'events';
      entries[2].querySelector('input[placeholder="Keywords (comma-separated)"]').value = 'festival, celebration';
      entries[2].querySelector('textarea').value = 'The annual Harvest Festival brings music, dancing, and competitions to the town square.';

      showToast('RPG Adventure preset loaded! Check Lorebook tab.', 'success');
      switchTab({target: document.querySelector('.tab-btn')}, 'lorebook');

    } else if (presetName === 'ambient') {
      document.getElementById('ambientEvents').innerHTML = '';
      addAmbientEvent();
      var events = document.querySelectorAll('#ambientEvents .dynamic-item');
      events[0].querySelector('textarea').value = 'A gentle breeze rustles the curtains.';

      addAmbientEvent();
      events = document.querySelectorAll('#ambientEvents .dynamic-item');
      events[1].querySelector('textarea').value = 'The faint sound of traffic hums in the distance.';

      addAmbientEvent();
      events = document.querySelectorAll('#ambientEvents .dynamic-item');
      events[2].querySelector('textarea').value = 'Sunlight filters through the window, casting warm patterns.';

      addAmbientEvent();
      events = document.querySelectorAll('#ambientEvents .dynamic-item');
      events[3].querySelector('textarea').value = 'The smell of fresh coffee lingers in the air.';

      document.getElementById('ambientProbability').value = '15';

      showToast('Ambient Flavor Pack preset loaded! Check Ambient Events tab.', 'success');
      switchTab({target: document.querySelectorAll('.tab-btn')[5]}, 'ambient');

    } else if (presetName === 'memory') {
      document.getElementById('memNamePhrase').value = 'my name is';
      document.getElementById('memFactsKeywords').value = 'fact, i am, i work, i study';
      document.getElementById('memLikesKeywords').value = 'i like, i love, i enjoy';
      document.getElementById('memDislikesKeywords').value = 'i hate, i dislike, i don\'t like';

      showToast('Memory Starter preset loaded! Check Memory tab.', 'success');
      switchTab({target: document.querySelectorAll('.tab-btn')[1]}, 'memory');
    }
  }

  // ===========================
  //   MEMORY SYSTEM
  // ===========================

  // Memory builder function - accepts standalone parameter
  function buildMemoryScript(standalone) {
    var namePhrase = escapeForRegex(document.getElementById('memNamePhrase').value.trim().toLowerCase());
    var factsKeywords = document.getElementById('memFactsKeywords').value.split(',').map(function(k) { return escapeForScript(k.trim().toLowerCase()); }).filter(Boolean);
    var likesKeywords = document.getElementById('memLikesKeywords').value.split(',').map(function(k) { return escapeForScript(k.trim().toLowerCase()); }).filter(Boolean);
    var dislikesKeywords = document.getElementById('memDislikesKeywords').value.split(',').map(function(k) { return escapeForScript(k.trim().toLowerCase()); }).filter(Boolean);
    var debugMode = document.getElementById('debugMode').checked;

    var script = "// ============================================\n";
    script += "// MODULE: MEMORY SYSTEM\n";
    script += "// ============================================\n\n";

    // Check for any valid configuration
    var hasAnyConfig = !!namePhrase || factsKeywords.length > 0 || likesKeywords.length > 0 || dislikesKeywords.length > 0;

    if (!hasAnyConfig) {
      script += "// (No memory triggers configured ‚Äî this module currently does nothing.)\n";
      return script;
    }

    // Only include initContext if standalone
    if (standalone) {
      script += "// Init function for standalone use\n";
      script += "function initContext() {\n";
      script += "  if (!context.character) context.character = {};\n";
      script += "  if (!context.character.personality) context.character.personality = \"\";\n";
      script += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
      script += "}\n";
      script += "initContext();\n\n";
    }

    // Get message safely
    script += "// Get last user message safely\n";
    script += "var message = (context.chat && context.chat.last_message) ? context.chat.last_message : \"\";\n";
    script += "var last_message = message.toLowerCase();\n";
    script += "var memoryUpdated = false;\n\n";

    // Only add name detection if namePhrase is provided
    if (namePhrase) {
      script += "// Name Detection (captures names with accents, hyphens, apostrophes)\n";
      script += "var nameRegex = new RegExp('" + namePhrase + "\\\\s+([^\\\\d,.;!?]{2,40})', 'i');\n";
      script += "var nameMatch = last_message.match(nameRegex);\n";
      script += "if (nameMatch && nameMatch[1]) {\n";
      script += "  var detectedName = nameMatch[1].trim();\n";
      script += "  // Dedupe: only add if not already present\n";
      script += "  if (context.character.scenario.indexOf('User name: ' + detectedName) === -1) {\n";
      script += "    context.character.scenario += '\\nUser name: ' + detectedName;\n";
      script += "    memoryUpdated = true;\n";
      script += "  }\n";
      script += "}\n\n";
    }

    // Facts with deduplication
    if (factsKeywords.length > 0) {
      script += "// Facts Detection with deduplication\n";
      script += "var factsKeywords = [" + factsKeywords.map(function(k) { return "'" + k + "'"; }).join(", ") + "];\n";
      script += "for (var i = 0; i < factsKeywords.length; i++) {\n";
      script += "  if (last_message.indexOf(factsKeywords[i]) !== -1) {\n";
      script += "    var factEntry = 'Fact: ' + message;\n";
      script += "    if (context.character.scenario.indexOf(factEntry) === -1) {\n";
      script += "      context.character.scenario += '\\n' + factEntry;\n";
      script += "      memoryUpdated = true;\n";
      script += "    }\n";
      script += "    break;\n";
      script += "  }\n";
      script += "}\n\n";
    }

    // Likes with deduplication
    if (likesKeywords.length > 0) {
      script += "// Likes Detection with deduplication\n";
      script += "var likesKeywords = [" + likesKeywords.map(function(k) { return "'" + k + "'"; }).join(", ") + "];\n";
      script += "for (var i = 0; i < likesKeywords.length; i++) {\n";
      script += "  if (last_message.indexOf(likesKeywords[i]) !== -1) {\n";
      script += "    var likeEntry = 'Likes: ' + message;\n";
      script += "    if (context.character.scenario.indexOf(likeEntry) === -1) {\n";
      script += "      context.character.scenario += '\\n' + likeEntry;\n";
      script += "      memoryUpdated = true;\n";
      script += "    }\n";
      script += "    break;\n";
      script += "  }\n";
      script += "}\n\n";
    }

    // Dislikes with deduplication
    if (dislikesKeywords.length > 0) {
      script += "// Dislikes Detection with deduplication\n";
      script += "var dislikesKeywords = [" + dislikesKeywords.map(function(k) { return "'" + k + "'"; }).join(", ") + "];\n";
      script += "for (var i = 0; i < dislikesKeywords.length; i++) {\n";
      script += "  if (last_message.indexOf(dislikesKeywords[i]) !== -1) {\n";
      script += "    var dislikeEntry = 'Dislikes: ' + message;\n";
      script += "    if (context.character.scenario.indexOf(dislikeEntry) === -1) {\n";
      script += "      context.character.scenario += '\\n' + dislikeEntry;\n";
      script += "      memoryUpdated = true;\n";
      script += "    }\n";
      script += "    break;\n";
      script += "  }\n";
      script += "}\n\n";
    }

    if (debugMode) {
      script += "// Debug Output\n";
      script += "if (memoryUpdated) {\n";
      script += "  context.character.scenario += '\\n(debug: memory updated)';\n";
      script += "}\n";
    }

    return script;
  }

  function generateMemoryScript() {
    var script = buildMemoryScript(true);
    document.getElementById('memoryOutput').textContent = script;
    updateTokenMeter();
  }

  // ===========================
  //   LOREBOOK SYSTEM
  // ===========================

  function addLoreEntry() {
    var container = document.getElementById('loreEntries');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.innerHTML = '<select style="width:120px;"><option value="people">People</option><option value="places">Places</option><option value="objects">Objects</option><option value="moods">Moods</option><option value="events">Events</option></select><input type="text" placeholder="Keywords (comma-separated)" style="flex:1;" /><textarea placeholder="Lore content to inject..." style="flex:2;"></textarea><button type="button" onclick="this.parentElement.remove()">Remove</button>';
    container.appendChild(item);
  }

  // Lorebook builder function - accepts standalone parameter
  function buildLorebookScript(standalone) {
    var padded = document.getElementById('lorePadded').checked;
    var breakEarly = document.getElementById('loreBreakEarly').checked;
    var debugMode = document.getElementById('debugMode').checked;

    var entries = document.querySelectorAll('#loreEntries .dynamic-item');
    var lorebook = {
      people: [],
      places: [],
      objects: [],
      moods: [],
      events: []
    };

    entries.forEach(function(entry) {
      var category = entry.querySelector('select').value;
      var keywords = entry.querySelector('input').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
      var content = entry.querySelector('textarea').value.trim();

      if (keywords.length > 0 && content) {
        lorebook[category].push({
          keywords: keywords,
          content: content
        });
      }
    });

    var script = "// ============================================\n";
    script += "// MODULE: LOREBOOK\n";
    script += "// ============================================\n\n";

    // Check for any valid configuration
    var hasEntries = lorebook.people.length > 0 || lorebook.places.length > 0 ||
                     lorebook.objects.length > 0 || lorebook.moods.length > 0 ||
                     lorebook.events.length > 0;

    if (!hasEntries) {
      script += "// (No lorebook entries configured ‚Äî this module currently does nothing.)\n";
      return script;
    }

    // Only include initContext if standalone
    if (standalone) {
      script += "// Init function for standalone use\n";
      script += "function initContext() {\n";
      script += "  if (!context.character) context.character = {};\n";
      script += "  if (!context.character.personality) context.character.personality = \"\";\n";
      script += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
      script += "}\n";
      script += "initContext();\n\n";
    }

    // Get message safely
    script += "// Get last user message safely\n";
    script += "var message = (context.chat && context.chat.last_message) ? context.chat.last_message : \"\";\n\n";

    script += "var lorebook = " + JSON.stringify(lorebook, null, 2) + ";\n\n";

    if (padded) {
      script += "var padded = ' ' + message.toLowerCase() + ' ';\n";
    } else {
      script += "var msgLower = message.toLowerCase();\n";
    }

    script += "var loreTriggered = false;\n";
    script += "var found = false;\n\n";

    script += "// Lorebook lookup with " + (breakEarly ? "break-early" : "multi-match") + " and deduplication\n";
    script += "for (var category in lorebook) {\n";
    script += "  var entries = lorebook[category];\n";
    script += "  for (var i = 0; i < entries.length && !found; i++) {\n";
    script += "    var entry = entries[i];\n";
    script += "    for (var k = 0; k < entry.keywords.length; k++) {\n";
    if (padded) {
      script += "      if (padded.indexOf(' ' + entry.keywords[k] + ' ') !== -1) {\n";
    } else {
      script += "      if (msgLower.indexOf(entry.keywords[k]) !== -1) {\n";
    }
    script += "        // Dedupe: only add if not already present\n";
    script += "        if (context.character.scenario.indexOf(entry.content) === -1) {\n";
    script += "          context.character.scenario += '\\n' + entry.content;\n";
    script += "          loreTriggered = true;\n";
    script += "        }\n";
    if (breakEarly) {
      script += "        found = true;\n";
    }
    script += "        break;\n";
    script += "      }\n";
    script += "    }\n";
    if (breakEarly) {
      script += "    if (found) break;\n";
    }
    script += "  }\n";
    if (breakEarly) {
      script += "  if (found) break;\n";
    }
    script += "}\n\n";

    if (debugMode) {
      script += "if (loreTriggered) {\n";
      script += "  context.character.scenario += '\\n(debug: lorebook fired)';\n";
      script += "}\n";
    }

    return script;
  }

  function generateLorebookScript() {
    var script = buildLorebookScript(true);
    document.getElementById('lorebookOutput').textContent = script;
    updateTokenMeter();
  }

  // ===========================
  //   TIME & ENVIRONMENT
  // ===========================

  function addTimeSlot() {
    var container = document.getElementById('timeSlots');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.innerHTML = '<input type="number" placeholder="Start hour (0-23)" min="0" max="23" style="width:120px;" /><input type="number" placeholder="End hour (0-23)" min="0" max="23" style="width:120px;" /><textarea placeholder="Scenario add-on for this time range..." style="flex:1;"></textarea><button type="button" onclick="this.parentElement.remove()">Remove</button>';
    container.appendChild(item);
  }

  // Time builder function - accepts standalone parameter
  function buildTimeScript(standalone) {
    var offset = parseInt(document.getElementById('timeOffset').value, 10) || 0;
    var debugMode = document.getElementById('debugMode').checked;
    var slots = document.querySelectorAll('#timeSlots .dynamic-item');

    var script = "// ============================================\n";
    script += "// MODULE: TIME & ENVIRONMENT\n";
    script += "// ============================================\n\n";

    // Check for any valid configuration
    var hasSlots = false;
    slots.forEach(function(slot) {
      var start = parseInt(slot.querySelectorAll('input')[0].value, 10);
      var end = parseInt(slot.querySelectorAll('input')[1].value, 10);
      var content = slot.querySelector('textarea').value.trim();
      if (!isNaN(start) && !isNaN(end) && content) {
        hasSlots = true;
      }
    });

    if (!hasSlots) {
      script += "// (No time slots configured ‚Äî this module currently does nothing.)\n";
      return script;
    }

    // Only include initContext if standalone
    if (standalone) {
      script += "// Init function for standalone use\n";
      script += "function initContext() {\n";
      script += "  if (!context.character) context.character = {};\n";
      script += "  if (!context.character.personality) context.character.personality = \"\";\n";
      script += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
      script += "}\n";
      script += "initContext();\n\n";
    }

    // Add hourInRange function for wrap-around support
    script += generateHourInRangeFunction();

    script += "var offset = " + offset + ";\n";
    script += "var hour = (new Date().getHours() + offset + 24) % 24;\n";
    script += "var timeSet = false;\n\n";

    slots.forEach(function(slot) {
      var start = parseInt(slot.querySelectorAll('input')[0].value, 10);
      var end = parseInt(slot.querySelectorAll('input')[1].value, 10);
      var content = slot.querySelector('textarea').value.trim();

      if (!isNaN(start) && !isNaN(end) && content) {
        script += "if (hourInRange(hour, " + start + ", " + end + ")) {\n";
        script += "  context.character.scenario += '\\n" + escapeForScript(content) + "';\n";
        script += "  timeSet = true;\n";
        script += "}\n";
      }
    });

    if (debugMode) {
      script += "\nif (timeSet) {\n";
      script += "  context.character.scenario += '\\n(debug: time module fired, hour=' + hour + ')';\n";
      script += "}\n";
    }

    return script;
  }

  function generateTimeScript() {
    var script = buildTimeScript(true);
    document.getElementById('timeOutput').textContent = script;
    updateTokenMeter();
  }

  // ===========================
  //   PACING SYSTEM
  // ===========================

  function addPacingPhase() {
    var container = document.getElementById('pacingPhases');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.innerHTML = '<input type="number" placeholder="Min messages" min="1" style="width:120px;" /><input type="number" placeholder="Max messages" min="1" style="width:120px;" /><textarea placeholder="Scenario add-on for this phase..." style="flex:1;"></textarea><button type="button" onclick="this.parentElement.remove()">Remove</button>';
    container.appendChild(item);
  }

  function addOneTimeEvent() {
    var container = document.getElementById('oneTimeEvents');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.innerHTML = '<input type="number" placeholder="Exact message #" min="1" style="width:120px;" /><textarea placeholder="One-time event content..." style="flex:1;"></textarea><button type="button" onclick="this.parentElement.remove()">Remove</button>';
    container.appendChild(item);
  }

  // Pacing builder function - accepts standalone parameter
  function buildPacingScript(standalone) {
    var phases = document.querySelectorAll('#pacingPhases .dynamic-item');
    var events = document.querySelectorAll('#oneTimeEvents .dynamic-item');
    var debugMode = document.getElementById('debugMode').checked;

    var script = "// ============================================\n";
    script += "// MODULE: PACING\n";
    script += "// ============================================\n\n";

    // Check for any valid configuration
    var hasPhases = false;
    var hasEvents = false;

    phases.forEach(function(phase) {
      var min = parseInt(phase.querySelectorAll('input')[0].value, 10);
      var max = parseInt(phase.querySelectorAll('input')[1].value, 10);
      var content = phase.querySelector('textarea').value.trim();
      if (!isNaN(min) && !isNaN(max) && content) {
        hasPhases = true;
      }
    });

    events.forEach(function(event) {
      var exact = parseInt(event.querySelector('input').value, 10);
      var content = event.querySelector('textarea').value.trim();
      if (!isNaN(exact) && content) {
        hasEvents = true;
      }
    });

    if (!hasPhases && !hasEvents) {
      script += "// (No pacing phases or events configured ‚Äî this module currently does nothing.)\n";
      return script;
    }

    // Only include initContext if standalone
    if (standalone) {
      script += "// Init function for standalone use\n";
      script += "function initContext() {\n";
      script += "  if (!context.character) context.character = {};\n";
      script += "  if (!context.character.personality) context.character.personality = \"\";\n";
      script += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
      script += "}\n";
      script += "initContext();\n\n";

      // Add message_count alias for standalone mode
      script += "// Safe message counter alias for pacing module\n";
      script += "var message_count = (context.chat && typeof context.chat.message_count === 'number')\n";
      script += "  ? context.chat.message_count\n";
      script += "  : 0;\n\n";
    }

    script += "var count = message_count;\n";
    script += "var pacingSet = false;\n\n";

    // Phases
    if (hasPhases) {
      script += "// Message Count Phases\n";
      phases.forEach(function(phase) {
        var min = parseInt(phase.querySelectorAll('input')[0].value, 10);
        var max = parseInt(phase.querySelectorAll('input')[1].value, 10);
        var content = phase.querySelector('textarea').value.trim();

        if (!isNaN(min) && !isNaN(max) && content) {
          script += "if (count >= " + min + " && count <= " + max + ") {\n";
          script += "  context.character.scenario += '\\n" + escapeForScript(content) + "';\n";
          script += "  pacingSet = true;\n";
          script += "}\n";
        }
      });
      script += "\n";
    }

    // One-time events
    if (hasEvents) {
      script += "// One-Time Events\n";
      events.forEach(function(event) {
        var exact = parseInt(event.querySelector('input').value, 10);
        var content = event.querySelector('textarea').value.trim();

        if (!isNaN(exact) && content) {
          script += "if (count === " + exact + ") {\n";
          script += "  context.character.scenario += '\\n" + escapeForScript(content) + "';\n";
          script += "  pacingSet = true;\n";
          script += "}\n";
        }
      });
    }

    if (debugMode) {
      script += "\nif (pacingSet) {\n";
      script += "  context.character.scenario += '\\n(debug: pacing fired, message_count=' + count + ')';\n";
      script += "}\n";
    }

    return script;
  }

  function generatePacingScript() {
    var script = buildPacingScript(true);
    document.getElementById('pacingOutput').textContent = script;
    updateTokenMeter();
  }

  // ===========================
  //   TONE/STATE ENGINE
  // ===========================

  function addToneTrigger() {
    var container = document.getElementById('toneTriggers');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.innerHTML = '<input type="text" placeholder="Keywords (comma-separated)" style="flex:1;" /><textarea placeholder="Personality add-on when triggered..." style="flex:1;"></textarea><button type="button" onclick="this.parentElement.remove()">Remove</button>';
    container.appendChild(item);
  }

  // Tone builder function - accepts standalone parameter
  function buildToneScript(standalone) {
    var padded = document.getElementById('tonePadded').checked;
    var debugMode = document.getElementById('debugMode').checked;
    var triggers = document.querySelectorAll('#toneTriggers .dynamic-item');

    var script = "// ============================================\n";
    script += "// MODULE: TONE/STATE ENGINE\n";
    script += "// ============================================\n\n";

    // Check for any valid configuration
    var hasTriggers = false;
    triggers.forEach(function(trigger) {
      var keywords = trigger.querySelector('input').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
      var content = trigger.querySelector('textarea').value.trim();
      if (keywords.length > 0 && content) {
        hasTriggers = true;
      }
    });

    if (!hasTriggers) {
      script += "// (No tone triggers configured ‚Äî this module currently does nothing.)\n";
      return script;
    }

    // Only include initContext if standalone
    if (standalone) {
      script += "// Init function for standalone use\n";
      script += "function initContext() {\n";
      script += "  if (!context.character) context.character = {};\n";
      script += "  if (!context.character.personality) context.character.personality = \"\";\n";
      script += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
      script += "}\n";
      script += "initContext();\n\n";
    }

    // Get message safely
    script += "// Get last user message safely\n";
    script += "var message = (context.chat && context.chat.last_message) ? context.chat.last_message : \"\";\n\n";

    if (padded) {
      script += "var padded = ' ' + message.toLowerCase() + ' ';\n";
    } else {
      script += "var msgLower = message.toLowerCase();\n";
    }

    script += "var toneSet = false;\n\n";

    triggers.forEach(function(trigger) {
      var keywords = trigger.querySelector('input').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
      var content = trigger.querySelector('textarea').value.trim();

      if (keywords.length > 0 && content) {
        script += "// Tone Trigger: " + keywords.join(', ') + "\n";
        keywords.forEach(function(keyword) {
          if (padded) {
            script += "if (padded.indexOf(' " + escapeForScript(keyword) + " ') !== -1) {\n";
          } else {
            script += "if (msgLower.indexOf('" + escapeForScript(keyword) + "') !== -1) {\n";
          }
          script += "  context.character.personality += '\\n" + escapeForScript(content) + "';\n";
          script += "  toneSet = true;\n";
          script += "}\n";
        });
        script += "\n";
      }
    });

    if (debugMode) {
      script += "if (toneSet) {\n";
      script += "  context.character.scenario += '\\n(debug: tone engine fired)';\n";
      script += "}\n";
    }

    return script;
  }

  function generateToneScript() {
    var script = buildToneScript(true);
    document.getElementById('toneOutput').textContent = script;
    updateTokenMeter();
  }

  // ===========================
  //   SCORING ENGINE
  // ===========================

  function addScoreThreshold() {
    var container = document.getElementById('scoreThresholds');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.innerHTML = '<select style="width:80px;"><option value=">=">>=</option><option value="<="><=</option><option value="==">=</option></select><input type="number" placeholder="Value" style="width:80px;" /><textarea placeholder="Response when score meets this condition..." style="flex:1;"></textarea><button type="button" onclick="this.parentElement.remove()">Remove</button>';
    container.appendChild(item);
  }

  // Scoring builder function - accepts standalone parameter
  function buildScoringScript(standalone) {
    var mode = document.getElementById('scoringMode').value;
    var positive = document.getElementById('scoringPositive').value.split(',').map(function(k) { return escapeForScript(k.trim().toLowerCase()); }).filter(Boolean);
    var negative = document.getElementById('scoringNegative').value.split(',').map(function(k) { return escapeForScript(k.trim().toLowerCase()); }).filter(Boolean);
    var thresholds = document.querySelectorAll('#scoreThresholds .dynamic-item');
    var debugMode = document.getElementById('debugMode').checked;

    var script = "// ============================================\n";
    script += "// MODULE: SCORING ENGINE (" + mode.toUpperCase() + ")\n";
    script += "// ============================================\n\n";

    // Check for any valid configuration
    var hasThresholds = false;
    thresholds.forEach(function(threshold) {
      var value = parseInt(threshold.querySelector('input').value, 10);
      var response = threshold.querySelector('textarea').value.trim();
      if (!isNaN(value) && response) {
        hasThresholds = true;
      }
    });

    if (positive.length === 0 && negative.length === 0 && !hasThresholds) {
      script += "// (No scoring keywords configured ‚Äî this module currently does nothing.)\n";
      return script;
    }

    // Only include initContext if standalone
    if (standalone) {
      script += "// Init function for standalone use\n";
      script += "function initContext() {\n";
      script += "  if (!context.character) context.character = {};\n";
      script += "  if (!context.character.personality) context.character.personality = \"\";\n";
      script += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
      script += "}\n";
      script += "initContext();\n\n";
    }

    // Get message safely
    script += "// Get last user message safely\n";
    script += "var message = (context.chat && context.chat.last_message) ? context.chat.last_message : \"\";\n\n";

    if (mode === 'persistent') {
      script += "// EXPERIMENTAL: Persistent scoring via {{char}} tags\n";
      script += "// WARNING: Fragile and may break with platform updates\n\n";
      script += "var scoreMatch = context.character.scenario.match(/\\{\\{char_score:([-\\d]+)\\}\\}/);\n";
      script += "var score = scoreMatch ? parseInt(scoreMatch[1], 10) : 0;\n\n";
    } else {
      script += "// Stateless: Single-turn sentiment analysis\n";
      script += "var score = 0;\n\n";
    }

    script += "var msgLower = message.toLowerCase();\n\n";

    // Positive keywords
    if (positive.length > 0) {
      script += "// Positive keywords\n";
      script += "var positiveKeywords = [" + positive.map(function(k) { return "'" + k + "'"; }).join(", ") + "];\n";
      script += "for (var i = 0; i < positiveKeywords.length; i++) {\n";
      script += "  if (msgLower.indexOf(positiveKeywords[i]) !== -1) {\n";
      script += "    score += 1;\n";
      script += "  }\n";
      script += "}\n\n";
    }

    // Negative keywords
    if (negative.length > 0) {
      script += "// Negative keywords\n";
      script += "var negativeKeywords = [" + negative.map(function(k) { return "'" + k + "'"; }).join(", ") + "];\n";
      script += "for (var i = 0; i < negativeKeywords.length; i++) {\n";
      script += "  if (msgLower.indexOf(negativeKeywords[i]) !== -1) {\n";
      script += "    score -= 1;\n";
      script += "  }\n";
      script += "}\n\n";
    }

    // Update persistent score
    if (mode === 'persistent') {
      script += "// Update score tag\n";
      script += "if (scoreMatch) {\n";
      script += "  context.character.scenario = context.character.scenario.replace(/\\{\\{char_score:[-\\d]+\\}\\}/, '{{char_score:' + score + '}}');\n";
      script += "} else {\n";
      script += "  context.character.scenario += '\\n{{char_score:' + score + '}}';\n";
      script += "}\n\n";
    }

    // Thresholds
    if (hasThresholds) {
      thresholds.forEach(function(threshold) {
        var operator = threshold.querySelector('select').value;
        var value = parseInt(threshold.querySelector('input').value, 10);
        var response = threshold.querySelector('textarea').value.trim();

        if (!isNaN(value) && response) {
          script += "if (score " + operator + " " + value + ") {\n";
          script += "  context.character.personality += '\\n" + escapeForScript(response) + "';\n";
          script += "}\n";
        }
      });
    }

    if (debugMode) {
      script += "\ncontext.character.scenario += '\\n(debug: scoring module fired, score=' + score + ')';\n";
    }

    return script;
  }

  function generateScoringScript() {
    var script = buildScoringScript(true);
    document.getElementById('scoringOutput').textContent = script;
    updateTokenMeter();
  }

  // ===========================
  //   AMBIENT EVENTS
  // ===========================

  function addAmbientEvent() {
    var container = document.getElementById('ambientEvents');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.innerHTML = '<textarea placeholder="Ambient event description..." style="flex:1;"></textarea><button type="button" onclick="this.parentElement.remove()">Remove</button>';
    container.appendChild(item);
  }

  // Ambient builder function - accepts standalone parameter
  function buildAmbientScript(standalone) {
    var probability = parseInt(document.getElementById('ambientProbability').value, 10) || 10;
    var events = document.querySelectorAll('#ambientEvents .dynamic-item');
    var debugMode = document.getElementById('debugMode').checked;

    var eventList = [];
    events.forEach(function(event) {
      var content = event.querySelector('textarea').value.trim();
      if (content) {
        eventList.push(content);
      }
    });

    var script = "// ============================================\n";
    script += "// MODULE: AMBIENT EVENTS\n";
    script += "// ============================================\n\n";

    // Check for any valid configuration
    if (eventList.length === 0) {
      script += "// (No ambient events configured ‚Äî this module currently does nothing.)\n";
      return script;
    }

    // Only include initContext if standalone
    if (standalone) {
      script += "// Init function for standalone use\n";
      script += "function initContext() {\n";
      script += "  if (!context.character) context.character = {};\n";
      script += "  if (!context.character.personality) context.character.personality = \"\";\n";
      script += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
      script += "}\n";
      script += "initContext();\n\n";
    }

    script += "var ambientEvents = " + JSON.stringify(eventList, null, 2) + ";\n\n";

    script += "var probability = " + probability + ";\n";
    script += "var roll = Math.floor(Math.random() * 100) + 1;\n\n";

    script += "if (roll <= probability && ambientEvents.length > 0) {\n";
    script += "  var randomIndex = Math.floor(Math.random() * ambientEvents.length);\n";
    script += "  context.character.scenario += '\\n' + ambientEvents[randomIndex];\n";
    if (debugMode) {
      script += "  context.character.scenario += '\\n(debug: ambient event fired)';\n";
    }
    script += "}\n";

    return script;
  }

  function generateAmbientScript() {
    var script = buildAmbientScript(true);
    document.getElementById('ambientOutput').textContent = script;
    updateTokenMeter();
  }

  // ===========================
  //   RANDOM EVENTS
  // ===========================

  function addRandomEvent() {
    var container = document.getElementById('randomEvents');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.innerHTML = '<input type="text" placeholder="Trigger phrase" style="flex:1;" /><textarea placeholder="Responses (pipe-separated: option1|option2|option3)" style="flex:1;"></textarea><button type="button" onclick="this.parentElement.remove()">Remove</button>';
    container.appendChild(item);
  }

  // Random builder function - accepts standalone parameter
  function buildRandomScript(standalone) {
    var events = document.querySelectorAll('#randomEvents .dynamic-item');
    var debugMode = document.getElementById('debugMode').checked;

    var script = "// ============================================\n";
    script += "// MODULE: RANDOM EVENTS\n";
    script += "// ============================================\n\n";

    // Check for any valid configuration
    var hasEvents = false;
    events.forEach(function(event) {
      var trigger = event.querySelector('input').value.trim().toLowerCase();
      var responses = event.querySelector('textarea').value.split('|').map(function(r) { return r.trim(); }).filter(Boolean);
      if (trigger && responses.length > 0) {
        hasEvents = true;
      }
    });

    if (!hasEvents) {
      script += "// (No random events configured ‚Äî this module currently does nothing.)\n";
      return script;
    }

    // Only include initContext if standalone
    if (standalone) {
      script += "// Init function for standalone use\n";
      script += "function initContext() {\n";
      script += "  if (!context.character) context.character = {};\n";
      script += "  if (!context.character.personality) context.character.personality = \"\";\n";
      script += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
      script += "}\n";
      script += "initContext();\n\n";
    }

    // Get message safely
    script += "// Get last user message safely\n";
    script += "var message = (context.chat && context.chat.last_message) ? context.chat.last_message : \"\";\n";
    script += "var msgLower = message.toLowerCase();\n";
    script += "var randomFired = false;\n\n";

    events.forEach(function(event) {
      var trigger = event.querySelector('input').value.trim().toLowerCase();
      var responses = event.querySelector('textarea').value.split('|').map(function(r) { return r.trim(); }).filter(Boolean);

      if (trigger && responses.length > 0) {
        script += "// Random Event: " + trigger + "\n";
        script += "if (msgLower.indexOf('" + escapeForScript(trigger) + "') !== -1) {\n";
        script += "  var responses = " + JSON.stringify(responses) + ";\n";
        script += "  var randomResponse = responses[Math.floor(Math.random() * responses.length)];\n";
        script += "  context.character.personality += '\\n' + randomResponse;\n";
        script += "  randomFired = true;\n";
        script += "}\n\n";
      }
    });

    if (debugMode) {
      script += "if (randomFired) {\n";
      script += "  context.character.scenario += '\\n(debug: random event fired)';\n";
      script += "}\n";
    }

    return script;
  }

  function generateRandomScript() {
    var script = buildRandomScript(true);
    document.getElementById('randomOutput').textContent = script;
    updateTokenMeter();
  }

  // ===========================
  //   COMBINED CONDITIONS
  // ===========================

  function addCombinedRule() {
    var container = document.getElementById('combinedRules');
    var item = document.createElement('div');
    item.className = 'dynamic-item';
    item.innerHTML = '<input type="text" placeholder="Keywords (comma-separated)" style="flex:1;" /><input type="number" placeholder="Min hour" min="0" max="23" style="width:80px;" /><input type="number" placeholder="Max hour" min="0" max="23" style="width:80px;" /><input type="number" placeholder="Min messages" min="1" style="width:100px;" /><textarea placeholder="Result when all conditions met..." style="flex:1;"></textarea><button type="button" onclick="this.parentElement.remove()">Remove</button>';
    container.appendChild(item);
  }

  // Combined Conditions builder function - accepts standalone parameter
  function buildCombinedConditionsScript(standalone) {
    var rules = document.querySelectorAll('#combinedRules .dynamic-item');
    var debugMode = document.getElementById('debugMode').checked;
    var offset = parseInt(document.getElementById('timeOffset').value, 10) || 0;

    var script = "// ============================================\n";
    script += "// MODULE: COMBINED CONDITIONS\n";
    script += "// ============================================\n\n";

    // Check for any valid configuration
    var hasRules = false;
    rules.forEach(function(rule) {
      var keywords = rule.querySelector('input').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
      var result = rule.querySelector('textarea').value.trim();
      if (keywords.length > 0 && result) {
        hasRules = true;
      }
    });

    if (!hasRules) {
      script += "// (No combined condition rules configured ‚Äî this module currently does nothing.)\n";
      return script;
    }

    // Only include initContext if standalone
    if (standalone) {
      script += "// Init function for standalone use\n";
      script += "function initContext() {\n";
      script += "  if (!context.character) context.character = {};\n";
      script += "  if (!context.character.personality) context.character.personality = \"\";\n";
      script += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
      script += "}\n";
      script += "initContext();\n\n";

      // Add message_count alias for standalone mode
      script += "// Safe message counter alias for combined conditions\n";
      script += "var message_count = (context.chat && typeof context.chat.message_count === 'number')\n";
      script += "  ? context.chat.message_count\n";
      script += "  : 0;\n\n";
    }

    // Add hourInRange for wrap-around support
    script += generateHourInRangeFunction();

    // Get message safely
    script += "// Get last user message safely\n";
    script += "var message = (context.chat && context.chat.last_message) ? context.chat.last_message : \"\";\n";
    script += "var msgLower = message.toLowerCase();\n";
    script += "var count = message_count;\n";
    script += "var offset = " + offset + ";\n";
    script += "var hour = (new Date().getHours() + offset + 24) % 24;\n";
    script += "var combinedFired = false;\n\n";

    rules.forEach(function(rule, index) {
      var keywords = rule.querySelector('input').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
      var inputs = rule.querySelectorAll('input[type="number"]');
      var minHour = parseInt(inputs[0].value, 10);
      var maxHour = parseInt(inputs[1].value, 10);
      var minMessages = parseInt(inputs[2].value, 10);
      var result = rule.querySelector('textarea').value.trim();

      if (keywords.length > 0 && result) {
        script += "// Combined Rule " + (index + 1) + "\n";
        script += "var keywordMatch" + index + " = false;\n";
        keywords.forEach(function(keyword) {
          script += "if (msgLower.indexOf('" + escapeForScript(keyword) + "') !== -1) keywordMatch" + index + " = true;\n";
        });

        script += "if (keywordMatch" + index;

        if (!isNaN(minHour) && !isNaN(maxHour)) {
          script += " && hourInRange(hour, " + minHour + ", " + maxHour + ")";
        }

        if (!isNaN(minMessages)) {
          script += " && count >= " + minMessages;
        }

        script += ") {\n";
        script += "  context.character.scenario += '\\n" + escapeForScript(result) + "';\n";
        script += "  combinedFired = true;\n";
        script += "}\n\n";
      }
    });

    if (debugMode) {
      script += "if (combinedFired) {\n";
      script += "  context.character.scenario += '\\n(debug: combined conditions fired)';\n";
      script += "}\n";
    }

    return script;
  }

  function generateCombinedConditionsScript() {
    var script = buildCombinedConditionsScript(true);
    document.getElementById('combinedOutput').textContent = script;
    updateTokenMeter();
  }

  // ===========================
  //   FINAL COMBINED SCRIPT
  // ===========================

  function generateFinalCombinedScript() {
    var order = [];
    var items = document.querySelectorAll('#moduleOrder .order-item');

    items.forEach(function(item) {
      var module = item.getAttribute('data-module');
      var checkbox = document.getElementById('toggle-' + module);
      if (checkbox && checkbox.checked) {
        order.push(module);
      }
    });

    if (order.length === 0) {
      showToast('No modules enabled! Please enable at least one module in the Module Control Panel.', 'warning');
      return;
    }

    var finalScript = "";
    finalScript += "// ============================================\n";
    finalScript += "// COMBINED SCRIPT - All Enabled Modules\n";
    finalScript += "// Generated by JanitorAI Script Builder v0.2.5\n";
    finalScript += "// ============================================\n\n";

    // Shared init function (only once for combined script)
    finalScript += "// Shared initialization function\n";
    finalScript += "function initContext() {\n";
    finalScript += "  if (!context.character) context.character = {};\n";
    finalScript += "  if (!context.character.personality) context.character.personality = \"\";\n";
    finalScript += "  if (!context.character.scenario) context.character.scenario = \"\";\n";
    finalScript += "}\n\n";

    // Call it once at the start
    finalScript += "// Initialize context\n";
    finalScript += "initContext();\n\n";

    // Add message_count alias for modules that need it (pacing, combined)
    var needsMessageCount = order.includes('pacing') || order.includes('combined');
    if (needsMessageCount) {
      finalScript += "// Safe message counter alias for pacing/combined modules\n";
      finalScript += "var message_count = (context.chat && typeof context.chat.message_count === 'number')\n";
      finalScript += "  ? context.chat.message_count\n";
      finalScript += "  : 0;\n\n";
    }

    // Check if hourInRange is needed
    var needsHourInRange = order.includes('time') || order.includes('combined');
    if (needsHourInRange) {
      finalScript += generateHourInRangeFunction();
    }

    // Add each enabled module using builder functions with standalone=false
    var activeModuleCount = 0;
    order.forEach(function(module) {
      var moduleScript = '';

      // Call the appropriate builder function with standalone=false
      switch(module) {
        case 'memory':
          moduleScript = buildMemoryScript(false);
          break;
        case 'lorebook':
          moduleScript = buildLorebookScript(false);
          break;
        case 'time':
          moduleScript = buildTimeScript(false);
          break;
        case 'pacing':
          moduleScript = buildPacingScript(false);
          break;
        case 'tone':
          moduleScript = buildToneScript(false);
          break;
        case 'scoring':
          moduleScript = buildScoringScript(false);
          break;
        case 'ambient':
          moduleScript = buildAmbientScript(false);
          break;
        case 'random':
          moduleScript = buildRandomScript(false);
          break;
        case 'combined':
          moduleScript = buildCombinedConditionsScript(false);
          break;
      }

      // Remove module headers for cleaner combined output
      moduleScript = moduleScript.replace(/\/\/ =+\r?\n\/\/ MODULE:.*?\r?\n\/\/ =+\r?\n\r?\n/g, '');
      moduleScript = moduleScript.replace(/function hourInRange\(h, start, end\)[\s\S]*?\}\r?\n\r?\n/g, '');

      if (moduleScript.trim()) {
        finalScript += "// ========== " + module.toUpperCase() + " MODULE ==========\n";
        finalScript += moduleScript.trim() + "\n\n";
        activeModuleCount++;
      }
    });

    document.getElementById("finalOutput").textContent = finalScript;

    // Copy to clipboard (with robust fallback for non-HTTPS / mobile / WebViews)
    var successMsg = 'Complete script copied to clipboard! Total modules: ' + activeModuleCount;
    var fallbackMsg = 'Script generated! Scroll down to see the combined output. Total modules: ' + activeModuleCount;

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(finalScript).then(function () {
        showToast(successMsg, 'success');
      }, function () {
        // Clipboard API failed, try legacy method
        copyFinalScriptFallback(finalScript, successMsg, fallbackMsg);
      });
    } else {
      copyFinalScriptFallback(finalScript, successMsg, fallbackMsg);
    }

    updateTokenMeter();
  }

  // Robust fallback copy for final script (mobile, WebViews, non-HTTPS)
  function copyFinalScriptFallback(text, successMsg, fallbackMsg) {
    var textarea = document.createElement('textarea');
    textarea.value = text;

    // Prevent zooming on iOS
    textarea.style.fontSize = '16px';

    // Hide textarea while keeping it functional
    textarea.style.position = 'fixed';
    textarea.style.top = '0';
    textarea.style.left = '0';
    textarea.style.width = '2em';
    textarea.style.height = '2em';
    textarea.style.padding = '0';
    textarea.style.border = 'none';
    textarea.style.outline = 'none';
    textarea.style.boxShadow = 'none';
    textarea.style.background = 'transparent';
    textarea.style.opacity = '0';
    textarea.style.zIndex = '-1';

    // Prevent keyboard from appearing on mobile
    textarea.setAttribute('readonly', '');

    document.body.appendChild(textarea);

    // iOS-specific selection method
    if (navigator.userAgent.match(/ipad|ipod|iphone/i)) {
      textarea.contentEditable = true;
      textarea.readOnly = true;
      var range = document.createRange();
      range.selectNodeContents(textarea);
      var selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      textarea.setSelectionRange(0, 999999);
    } else {
      textarea.select();
    }

    var success = false;
    try {
      success = document.execCommand('copy');
    } catch (err) {
      success = false;
    }

    document.body.removeChild(textarea);

    if (success) {
      showToast(successMsg, 'success');
    } else {
      showToast(fallbackMsg, 'success');
    }
  }

  // ===========================
  //   TRIGGER ANALYZER
  // ===========================

  function analyzeTriggers() {
    var triggerMap = {}; // keyword -> [{module, context, action}]

    // Collect from Lorebook
    var loreEntries = document.querySelectorAll('#loreEntries .dynamic-item');
    loreEntries.forEach(function(entry) {
      var category = entry.querySelector('select').value;
      var keywords = entry.querySelector('input').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
      var content = entry.querySelector('textarea').value.trim();
      if (content) {
        keywords.forEach(function(kw) {
          if (!triggerMap[kw]) triggerMap[kw] = [];
          triggerMap[kw].push({
            module: 'Lorebook',
            context: category,
            action: 'Injects lore entry (' + content.substring(0, 40) + (content.length > 40 ? '...' : '') + ')'
          });
        });
      }
    });

    // Collect from Tone
    var toneTriggers = document.querySelectorAll('#toneTriggers .dynamic-item');
    toneTriggers.forEach(function(trigger) {
      var keywords = trigger.querySelector('input').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
      var content = trigger.querySelector('textarea').value.trim();
      if (content) {
        keywords.forEach(function(kw) {
          if (!triggerMap[kw]) triggerMap[kw] = [];
          triggerMap[kw].push({
            module: 'Tone',
            context: 'personality shift',
            action: 'Adds: ' + content.substring(0, 40) + (content.length > 40 ? '...' : '')
          });
        });
      }
    });

    // Collect from Scoring - Positive
    var positiveKeywords = document.getElementById('scoringPositive').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
    positiveKeywords.forEach(function(kw) {
      if (!triggerMap[kw]) triggerMap[kw] = [];
      triggerMap[kw].push({
        module: 'Scoring',
        context: 'positive',
        action: 'Adds +1 to score'
      });
    });

    // Collect from Scoring - Negative
    var negativeKeywords = document.getElementById('scoringNegative').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
    negativeKeywords.forEach(function(kw) {
      if (!triggerMap[kw]) triggerMap[kw] = [];
      triggerMap[kw].push({
        module: 'Scoring',
        context: 'negative',
        action: 'Subtracts -1 from score'
      });
    });

    // Collect from Memory - Facts
    var factsKeywords = document.getElementById('memFactsKeywords').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
    factsKeywords.forEach(function(kw) {
      if (!triggerMap[kw]) triggerMap[kw] = [];
      triggerMap[kw].push({
        module: 'Memory',
        context: 'facts detection',
        action: 'Triggers fact storage'
      });
    });

    // Collect from Memory - Likes
    var likesKeywords = document.getElementById('memLikesKeywords').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
    likesKeywords.forEach(function(kw) {
      if (!triggerMap[kw]) triggerMap[kw] = [];
      triggerMap[kw].push({
        module: 'Memory',
        context: 'likes detection',
        action: 'Triggers like storage'
      });
    });

    // Collect from Memory - Dislikes
    var dislikesKeywords = document.getElementById('memDislikesKeywords').value.split(',').map(function(k) { return k.trim().toLowerCase(); }).filter(Boolean);
    dislikesKeywords.forEach(function(kw) {
      if (!triggerMap[kw]) triggerMap[kw] = [];
      triggerMap[kw].push({
        module: 'Memory',
        context: 'dislikes detection',
        action: 'Triggers dislike storage'
      });
    });

    // Analyze the collected triggers
    var conflicts = [];      // Same keyword with opposing scoring effects
    var multiTriggers = [];  // Keywords that trigger multiple things
    var overlaps = [];       // Keywords that contain each other
    var allKeywords = Object.keys(triggerMap);

    // Check for multi-triggers and conflicts
    allKeywords.forEach(function(kw) {
      var usages = triggerMap[kw];
      if (usages.length > 1) {
        // Check for scoring conflicts (positive AND negative)
        var hasPositive = usages.some(function(u) { return u.module === 'Scoring' && u.context === 'positive'; });
        var hasNegative = usages.some(function(u) { return u.module === 'Scoring' && u.context === 'negative'; });
        if (hasPositive && hasNegative) {
          conflicts.push({ keyword: kw, usages: usages });
        } else {
          multiTriggers.push({ keyword: kw, usages: usages });
        }
      }
    });

    // Check for overlapping keywords (one contains another)
    for (var i = 0; i < allKeywords.length; i++) {
      for (var j = i + 1; j < allKeywords.length; j++) {
        var kw1 = allKeywords[i];
        var kw2 = allKeywords[j];
        // Check if one contains the other (but they're not equal)
        if (kw1 !== kw2) {
          if (kw1.indexOf(kw2) !== -1 || kw2.indexOf(kw1) !== -1) {
            overlaps.push({
              keywords: [kw1, kw2],
              note: kw1.length > kw2.length
                ? '"' + kw1 + '" contains "' + kw2 + '"'
                : '"' + kw2 + '" contains "' + kw1 + '"'
            });
          }
        }
      }
    }

    // Build results HTML
    var resultsHTML = '<div class="analyzer-results">';

    // Summary
    resultsHTML += '<div class="analyzer-summary">';
    resultsHTML += '<span class="analyzer-stat">Total keywords: <strong>' + allKeywords.length + '</strong></span>';
    resultsHTML += '<span class="analyzer-stat">Conflicts: <strong>' + conflicts.length + '</strong></span>';
    resultsHTML += '<span class="analyzer-stat">Multi-triggers: <strong>' + multiTriggers.length + '</strong></span>';
    resultsHTML += '<span class="analyzer-stat">Overlaps: <strong>' + overlaps.length + '</strong></span>';
    resultsHTML += '</div>';

    // Conflicts section
    if (conflicts.length > 0) {
      resultsHTML += '<div class="analyzer-section">';
      resultsHTML += '<h4>‚ö†Ô∏è Conflicts (Same keyword with opposing effects)</h4>';
      conflicts.forEach(function(item) {
        resultsHTML += '<div class="analyzer-item analyzer-conflict">';
        resultsHTML += '<div class="analyzer-keyword">"' + item.keyword + '"</div>';
        resultsHTML += '<div class="analyzer-usage">';
        item.usages.forEach(function(usage) {
          resultsHTML += '<div class="analyzer-usage-item">‚Üí ' + usage.module + ' (' + usage.context + '): ' + usage.action + '</div>';
        });
        resultsHTML += '</div></div>';
      });
      resultsHTML += '</div>';
    }

    // Multi-triggers section
    if (multiTriggers.length > 0) {
      resultsHTML += '<div class="analyzer-section">';
      resultsHTML += '<h4>üìã Multi-Triggers (Keywords that fire multiple things)</h4>';
      multiTriggers.forEach(function(item) {
        resultsHTML += '<div class="analyzer-item analyzer-warning">';
        resultsHTML += '<div class="analyzer-keyword">"' + item.keyword + '"</div>';
        resultsHTML += '<div class="analyzer-usage">';
        item.usages.forEach(function(usage) {
          resultsHTML += '<div class="analyzer-usage-item">‚Üí ' + usage.module + ' (' + usage.context + '): ' + usage.action + '</div>';
        });
        resultsHTML += '</div></div>';
      });
      resultsHTML += '</div>';
    }

    // Overlaps section
    if (overlaps.length > 0) {
      resultsHTML += '<div class="analyzer-section">';
      resultsHTML += '<h4>üîó Overlapping Keywords (May cause unintended matches without padded matching)</h4>';
      overlaps.forEach(function(item) {
        resultsHTML += '<div class="analyzer-item analyzer-warning">';
        resultsHTML += '<div class="analyzer-keyword">' + item.note + '</div>';
        resultsHTML += '</div>';
      });
      resultsHTML += '</div>';
    }

    // All clear message
    if (conflicts.length === 0 && multiTriggers.length === 0 && overlaps.length === 0) {
      if (allKeywords.length === 0) {
        resultsHTML += '<div class="analyzer-empty">No triggers configured yet. Add keywords to your modules to analyze them.</div>';
      } else {
        resultsHTML += '<div class="analyzer-item analyzer-ok">';
        resultsHTML += '<strong>‚úì All Clear!</strong> No conflicts or overlaps detected in your ' + allKeywords.length + ' keywords.';
        resultsHTML += '</div>';
      }
    }

    resultsHTML += '</div>';

    document.getElementById('analyzerResults').innerHTML = resultsHTML;
    showToast('Trigger analysis complete!', 'success');
  }

  // ===========================
  //   INITIALIZATION
  // ===========================

  document.addEventListener('DOMContentLoaded', function () {
    // Restore default toggles (prevents stale browser-cached states)
    document.getElementById('toggle-lorebook').checked = true;
    document.getElementById('toggle-memory').checked = true;
    document.getElementById('toggle-pacing').checked = true;
    document.getElementById('toggle-tone').checked = true;

    document.getElementById('toggle-time').checked = false;
    document.getElementById('toggle-ambient').checked = false;
    document.getElementById('toggle-random').checked = false;
    document.getElementById('toggle-combined').checked = false;
    document.getElementById('toggle-scoring').checked = false;

    // Ensure outputs start clean (helps with bfcache / reloads)
    var outputs = [
      'memoryOutput','lorebookOutput','timeOutput','pacingOutput','toneOutput',
      'scoringOutput','ambientOutput','randomOutput','combinedOutput','finalOutput'
    ];
    outputs.forEach(function (id) {
      document.getElementById(id).textContent = '// Script will appear here after clicking Generate';
    });

    // Add one default entry for each dynamic section
    addLoreEntry();
    addTimeSlot();
    addPacingPhase();
    addToneTrigger();
    addAmbientEvent();

    updateTokenMeter();
  });
</script>

</body>
</html>
